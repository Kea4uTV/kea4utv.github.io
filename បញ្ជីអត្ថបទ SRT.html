<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subtitle Audio Editor - HTML Version</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kantumruy Pro', sans-serif;
            background-color: #f1f5f9;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 20px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #cbd5e1;
        }
        input[type="range"] {
            accent-color: #4f46e5;
        }
    </style>
</head>
<body class="p-4 md:p-6 text-slate-900">

    <div class="max-w-[1400px] mx-auto flex flex-col xl:flex-row gap-6">
        
        <!-- LEFT: MEDIA PREVIEW -->
        <div class="xl:w-1/3 space-y-6">
            <div class="bg-slate-900 rounded-2xl shadow-xl overflow-hidden border border-slate-800">
                <div class="p-4 border-b border-slate-800 flex justify-between items-center">
                    <h2 class="text-white font-bold flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 8-6 4 6 4V8Z"/><rect width="14" height="12" x="2" y="6" rx="2" ry="2"/></svg>
                        Media Preview
                    </h2>
                    <div class="flex gap-2">
                        <button id="vocalBtn" class="hidden text-[10px] px-2 py-1 rounded font-bold transition flex items-center gap-1 bg-slate-700 text-slate-200 hover:bg-slate-600">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
                            Vocal
                        </button>
                        <label class="text-[10px] bg-indigo-600 hover:bg-indigo-500 text-white px-2 py-1 rounded cursor-pointer transition">
                            Upload Media
                            <input type="file" id="mediaUpload" accept="video/*,audio/*" class="hidden" />
                        </label>
                    </div>
                </div>
                
                <div class="aspect-video bg-black flex items-center justify-center relative" id="mediaContainer">
                    <div id="mediaPlaceholder" class="text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-2 opacity-20 text-white"><rect width="20" height="14" x="2" y="3" rx="2"/><line x1="8" x2="16" y1="21" y2="21"/><line x1="12" x2="12" y1="17" y2="21"/></svg>
                        <p class="text-slate-500 text-xs">áŸá¼á˜ Upload áœá¸áŠáŸá¢á¼ á¬áŸá˜áŸ’á›áŸá„á˜áŸ</p>
                    </div>
                    <div class="absolute bottom-12 left-0 right-0 px-4 text-center pointer-events-none">
                        <p id="subtitleOverlay" class="hidden inline-block bg-black/80 text-amber-300 px-4 py-1.5 rounded-lg text-sm font-bold shadow-2xl backdrop-blur-sm"></p>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                    á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á¯á€áŸá¶áš
                </h3>
                <div class="grid grid-cols-1 gap-3">
                    <label class="w-full bg-slate-50 hover:bg-slate-100 text-slate-700 py-3 rounded-xl transition flex items-center justify-center gap-2 text-sm font-bold cursor-pointer border border-slate-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                        Upload SRT
                        <input type="file" id="srtUpload" accept=".srt" class="hidden" />
                    </label>
                    <button id="exportBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-xl transition flex items-center justify-center gap-2 text-sm font-bold shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                        ášá€áŸ’áŸá¶á‘á»á€ .srt
                    </button>
                </div>
            </div>
        </div>

        <!-- RIGHT: SRT EDITOR -->
        <div class="xl:w-2/3 bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col h-[calc(100vh-80px)]">
            <div class="p-4 border-b bg-slate-50/50 backdrop-blur-md flex justify-between items-center sticky top-0 z-10 rounded-t-2xl">
                <h2 class="font-bold text-slate-700 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
                    á”á‰áŸ’á‡á¸á¢ááŸ’áá”á‘ SRT
                </h2>
                <div class="flex items-center gap-4">
                    <span id="timer" class="text-xs font-mono text-slate-500 bg-slate-200 px-2 py-1 rounded">00:00:00,000</span>
                    <span id="lineCount" class="text-xs bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full font-bold">1 á‡á½áš</span>
                </div>
            </div>

            <div id="subContainer" class="flex-grow overflow-y-auto p-4 md:p-6 space-y-6 custom-scrollbar">
                <!-- Subtitle Rows will be injected here -->
            </div>

            <div class="p-4 border-t">
                <button id="addBtn" class="w-full py-4 border-2 border-dashed border-slate-200 rounded-2xl text-slate-400 hover:bg-indigo-50 hover:text-indigo-500 hover:border-indigo-300 transition-all flex flex-col items-center justify-center gap-1 group">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="group-hover:scale-110 transition-transform"><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></svg>
                    <span class="text-sm font-bold">á”á“áŸ’ááŸ‚á˜á‡á½ášá¢ááŸ’áá”á‘ááŸ’á˜á¸</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // State Management
        let subtitles = [
            { id: Date.now(), start: '00:00:01,000', end: '00:00:04,000', text: 'áŸá½áŸáŸ’áá¸! á“áŸáŸ‡á‚áºá‡á¶á€áŸ†ááŸ‚ HTML Version', audioClips: [] }
        ];
        let activeId = null;
        let isVocalRemoved = false;
        let mainMedia = null;
        let audioContext = null;
        let mainMediaSource = null;
        let vocalFilter = null;
        let lastTriggeredId = null;

        // Elements
        const subContainer = document.getElementById('subContainer');
        const mediaContainer = document.getElementById('mediaContainer');
        const mediaPlaceholder = document.getElementById('mediaPlaceholder');
        const subtitleOverlay = document.getElementById('subtitleOverlay');
        const timer = document.getElementById('timer');
        const lineCount = document.getElementById('lineCount');
        const vocalBtn = document.getElementById('vocalBtn');

        // Helpers
        const srtToSeconds = (srtTime) => {
            if (!srtTime || typeof srtTime !== 'string' || !srtTime.includes(',')) return 0;
            const parts = srtTime.split(',');
            const [h, m, s] = parts[0].split(':').map(Number);
            const ms = parseInt(parts[1]) || 0;
            return h * 3600 + m * 60 + s + ms / 1000;
        };

        const secondsToSrt = (totalSeconds) => {
            const safeSecs = Math.max(0, totalSeconds);
            const h = Math.floor(safeSecs / 3600).toString().padStart(2, '0');
            const m = Math.floor((safeSecs % 3600) / 60).toString().padStart(2, '0');
            const s = Math.floor(safeSecs % 60).toString().padStart(2, '0');
            const ms = Math.floor((safeSecs % 1) * 1000).toString().padStart(3, '0');
            return `${h}:${m}:${s},${ms}`;
        };

        const getAudioContext = () => {
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            return audioContext;
        };

        // Render UI
        const renderSubtitles = () => {
            subContainer.innerHTML = '';
            lineCount.textContent = `${subtitles.length} á‡á½áš`;
            
            subtitles.forEach((sub, index) => {
                const isActive = activeId === sub.id;
                const duration = (srtToSeconds(sub.end) - srtToSeconds(sub.start)).toFixed(2);
                
                const subEl = document.createElement('div');
                subEl.className = `p-5 rounded-2xl border transition-all duration-300 ${isActive ? 'bg-indigo-50 border-indigo-400 shadow-lg ring-1 ring-indigo-300 scale-[1.01]' : 'bg-white border-slate-200'}`;
                subEl.id = `sub-${sub.id}`;

                subEl.innerHTML = `
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="md:w-48 space-y-2 border-r border-slate-100 pr-4">
                            <span class="text-[10px] font-black uppercase tracking-wider ${isActive ? 'text-indigo-600' : 'text-slate-400'}">á‡á½áš #${index + 1}</span>
                            <input type="text" value="${sub.start}" onchange="updateSub(${sub.id}, 'start', this.value)" class="w-full text-[11px] bg-slate-50 border border-slate-200 rounded px-2 py-1 font-mono outline-none">
                            <input type="text" value="${sub.end}" onchange="updateSub(${sub.id}, 'end', this.value)" class="w-full text-[11px] bg-slate-50 border border-slate-200 rounded px-2 py-1 font-mono outline-none">
                            <div class="text-[10px] font-bold text-center py-1 bg-indigo-100 text-indigo-700 rounded-md mt-2">DUR: ${duration}s</div>
                        </div>
                        <div class="flex-grow space-y-3">
                            <div class="relative">
                                <textarea onchange="updateSub(${sub.id}, 'text', this.value)" class="w-full h-20 p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none resize-none focus:border-indigo-400">${sub.text}</textarea>
                                <button onclick="deleteSub(${sub.id})" class="absolute -top-2 -right-2 p-1.5 bg-white shadow-md border rounded-full text-slate-400 hover:text-red-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                                </button>
                            </div>
                            <div class="flex items-center justify-between">
                                <label class="flex items-center gap-1.5 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-xl text-[11px] font-bold cursor-pointer transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></svg>
                                    á”á‰áŸ’á…á¼á›áŸá˜áŸ’á›áŸá„
                                    <input type="file" multiple accept="audio/*" class="hidden" onchange="addAudioClip(${sub.id}, this)">
                                </label>
                                <button onclick="previewSub(${sub.id})" class="px-5 py-2 rounded-xl text-[11px] font-bold flex items-center gap-2 transition shadow-md ${isActive ? 'bg-amber-500 text-white' : 'bg-emerald-500 text-white'}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                                    ${isActive ? 'á€áŸ†á–á»á„á…á¶á€áŸ‹...' : 'á…á¶á€áŸ‹á•áŸ’á‘áŸ€á„á•áŸ’á‘á¶ááŸ‹'}
                                </button>
                            </div>
                            <div id="clips-${sub.id}" class="space-y-2 mt-2">
                                ${renderClips(sub)}
                            </div>
                        </div>
                    </div>
                `;
                subContainer.appendChild(subEl);
            });
        };

        const renderClips = (sub) => {
            return sub.audioClips.map(clip => `
                <div class="bg-slate-50 border border-slate-200 p-3 rounded-lg flex flex-col gap-2 ${clip.isMuted ? 'opacity-50' : ''}">
                    <div class="flex justify-between items-center">
                        <span class="text-[10px] font-bold truncate max-w-[150px]">${clip.name}</span>
                        <div class="flex gap-2">
                            <button onclick="updateClip(${sub.id}, '${clip.id}', {useEcho: !${clip.useEcho}})" class="px-2 py-0.5 rounded text-[8px] font-bold ${clip.useEcho ? 'bg-amber-500 text-white' : 'bg-white border'}">Echo</button>
                            <button onclick="updateClip(${sub.id}, '${clip.id}', {isMuted: !${clip.isMuted}})" class="p-1 rounded bg-white border">
                                ${clip.isMuted ? 'ğŸ”‡' : 'ğŸ”Š'}
                            </button>
                            <button onclick="removeClip(${sub.id}, '${clip.id}')" class="text-red-400">âœ•</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="flex flex-col gap-1">
                            <span class="text-[9px] text-slate-400">Volume</span>
                            <input type="range" min="0" max="1" step="0.1" value="${clip.volume}" onchange="updateClip(${sub.id}, '${clip.id}', {volume: parseFloat(this.value)})" class="w-full">
                        </div>
                        <div class="flex flex-col gap-1">
                            <span class="text-[9px] text-slate-400">Speed</span>
                            <input type="range" min="0.5" max="2" step="0.1" value="${clip.speed}" onchange="updateClip(${sub.id}, '${clip.id}', {speed: parseFloat(this.value)})" class="w-full">
                        </div>
                    </div>
                </div>
            `).join('');
        };

        // Actions
        window.updateSub = (id, key, val) => {
            const sub = subtitles.find(s => s.id === id);
            if (sub) sub[key] = val;
            renderSubtitles();
        };

        window.deleteSub = (id) => {
            subtitles = subtitles.filter(s => s.id !== id);
            renderSubtitles();
        };

        window.addAudioClip = (subId, input) => {
            const files = Array.from(input.files);
            const sub = subtitles.find(s => s.id === subId);
            if (!sub) return;

            files.forEach(file => {
                sub.audioClips.push({
                    id: Math.random().toString(36).substr(2, 9),
                    url: URL.createObjectURL(file),
                    name: file.name,
                    volume: 1,
                    speed: 1,
                    useEcho: false,
                    isMuted: false
                });
            });
            renderSubtitles();
        };

        window.updateClip = (subId, clipId, settings) => {
            const sub = subtitles.find(s => s.id === subId);
            if (!sub) return;
            const clip = sub.audioClips.find(c => c.id === clipId);
            if (clip) Object.assign(clip, settings);
            renderSubtitles();
        };

        window.removeClip = (subId, clipId) => {
            const sub = subtitles.find(s => s.id === subId);
            if (sub) sub.audioClips = sub.audioClips.filter(c => c.id !== clipId);
            renderSubtitles();
        };

        window.previewSub = (id) => {
            const sub = subtitles.find(s => s.id === id);
            if (!sub) return;
            
            if (mainMedia) {
                mainMedia.currentTime = srtToSeconds(sub.start);
                mainMedia.play().catch(() => {});
            }
            playClips(sub);
        };

        const playClips = (sub) => {
            const duration = srtToSeconds(sub.end) - srtToSeconds(sub.start);
            sub.audioClips.forEach(clip => {
                if (clip.isMuted) return;
                const audio = new Audio(clip.url);
                audio.volume = clip.volume;
                audio.playbackRate = clip.speed;
                
                // Simple Echo if enabled
                if (clip.useEcho) {
                    const ctx = getAudioContext();
                    const source = ctx.createMediaElementSource(audio);
                    const delay = ctx.createDelay();
                    delay.delayTime.value = 0.3;
                    source.connect(delay);
                    delay.connect(ctx.destination);
                    source.connect(ctx.destination);
                }

                audio.play();
                setTimeout(() => audio.pause(), duration * 1000);
            });
        };

        // Media Handlers
        document.getElementById('mediaUpload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const url = URL.createObjectURL(file);
            mediaPlaceholder.classList.add('hidden');
            vocalBtn.classList.remove('hidden');
            
            if (file.type.startsWith('video')) {
                mediaContainer.innerHTML = `<video id="mainMedia" src="${url}" controls class="w-full h-full" crossorigin="anonymous"></video>`;
            } else {
                mediaContainer.innerHTML = `<audio id="mainMedia" src="${url}" controls class="w-full mx-4" crossorigin="anonymous"></audio>`;
            }
            
            mainMedia = document.getElementById('mainMedia');
            initAudioEffects();
            
            mainMedia.ontimeupdate = () => {
                const time = mainMedia.currentTime;
                timer.textContent = secondsToSrt(time);
                
                const active = subtitles.find(s => time >= srtToSeconds(s.start) && time <= srtToSeconds(s.end));
                if (active) {
                    if (activeId !== active.id) {
                        activeId = active.id;
                        subtitleOverlay.textContent = active.text;
                        subtitleOverlay.classList.remove('hidden');
                        renderSubtitles();
                        
                        if (lastTriggeredId !== active.id) {
                            lastTriggeredId = active.id;
                            playClips(active);
                        }
                    }
                } else {
                    activeId = null;
                    lastTriggeredId = null;
                    subtitleOverlay.classList.add('hidden');
                    renderSubtitles();
                }
            };
        });

        const initAudioEffects = () => {
            const ctx = getAudioContext();
            mainMediaSource = ctx.createMediaElementSource(mainMedia);
            vocalFilter = ctx.createBiquadFilter();
            vocalFilter.type = 'peaking';
            vocalFilter.frequency.value = 1000;
            vocalFilter.gain.value = 0;
            
            mainMediaSource.connect(vocalFilter);
            vocalFilter.connect(ctx.destination);
        };

        vocalBtn.onclick = () => {
            isVocalRemoved = !isVocalRemoved;
            vocalFilter.gain.value = isVocalRemoved ? -40 : 0;
            vocalBtn.classList.toggle('bg-red-500', isVocalRemoved);
            vocalBtn.classList.toggle('text-white', isVocalRemoved);
        };

        document.getElementById('srtUpload').onchange = (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (ev) => {
                const text = ev.target.result;
                const blocks = text.trim().split(/\n\s*\n/);
                subtitles = blocks.map(b => {
                    const lines = b.split('\n');
                    const timeLine = lines.find(l => l.includes('-->'));
                    if (!timeLine) return null;
                    const [start, end] = timeLine.split(' --> ');
                    return { id: Date.now() + Math.random(), start, end, text: lines.slice(lines.indexOf(timeLine)+1).join('\n'), audioClips: [] };
                }).filter(s => s);
                renderSubtitles();
            };
            reader.readAsText(file);
        };

        document.getElementById('addBtn').onclick = () => {
            const last = subtitles[subtitles.length - 1];
            const start = last ? last.end : '00:00:00,000';
            const end = secondsToSrt(srtToSeconds(start) + 3);
            subtitles.push({ id: Date.now(), start, end, text: '', audioClips: [] });
            renderSubtitles();
        };

        document.getElementById('exportBtn').onclick = () => {
            const content = subtitles.map((s, i) => `${i + 1}\n${s.start} --> ${s.end}\n${s.text}\n`).join('\n');
            const blob = new Blob([content], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'edited_subtitles.srt';
            a.click();
        };

        // Initial Render
        renderSubtitles();

    </script>
</body>
</html>
