<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recode Video Preview App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for predefined options -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto:wght@400;700&family=Open+Sans:wght@400;700&family=Noto+Sans+Khmer:wght@400;700&family=Hanuman:wght@400;700&family=Koh+Santepheap:wght@400;700&family=Moul:wght@400&family=Battambang:wght@400;700&family=Content:wght@400;700&family=Kantumruy+Pro:wght@440;700&family=Koulen:wght@400&family=Odor+Mean+Chey:wght@400&family=Preahvihear:wght@400&family=Suwannaphum:wght@400&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text */
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        .card {
            background-color: #2d3748; /* Slightly lighter dark */
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }
        input[type="file"],
        input[type="text"],
        input[type="number"],
        input[type="range"],
        input[type="color"],
        select,
        textarea { /* Added textarea */
            background-color: #4a5568;
            border: 1px solid #6b7280;
            color: #e2e8f0;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            width: 100%;
            box-sizing: border-box;
        }
        button {
            background-color: #63b3ed; /* Blue */
            color: #1a202c;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        button:hover {
            background-color: #4299e1; /* Darker blue on hover */
        }
        canvas {
            background-color: #000;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: block;
            margin-top: 2rem;
            max-width: 100%; /* Ensure canvas is responsive */
            height: auto; /* Maintain aspect ratio */
        }
        .message-box {
            background-color: #2d3748;
            border: 1px solid #63b3ed;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            display: none; /* Hidden by default */
        }
        .recording-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background-color: red;
            border-radius: 50%;
            margin-left: 8px;
            animation: pulse 1.5s infinite alternate;
        }
        @keyframes pulse {
            0% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        details {
            margin-top: 1rem;
            background-color: #334155;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            border: 1px solid #475569;
        }
        summary {
            font-weight: 600;
            cursor: pointer;
            padding: 0.5rem 0;
            color: #cbd5e1;
        }
        summary:hover {
            color: #e2e8f0;
        }
        .grid-cols-2-dense {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
        .font-input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .animation-control-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .animation-control-group input[type="checkbox"] {
            width: auto;
            margin-right: 0.5rem;
        }
        .animation-mode-select {
            width: 100px; /* Smaller width for mode select */
        }
    </style>
</head>
<body class="antialiased">
    <div class="container min-h-screen flex flex-col items-center justify-center">
        <h1 class="text-4xl font-bold text-center mb-8">កម្មវិធីមើលជាមុនវីដេអូ Recode</h1>

        <div class="card w-full lg:w-3/4 xl:w-2/3 mb-8">
            <p class="text-sm text-yellow-300 mb-4">
                <span class="font-bold">ចំណាំ:</span> កម្មវិធីនេះនឹងបង្កើតការមើលជាមុននៅក្នុង browser របស់អ្នកប៉ុណ្ណោះ។ វាមិនអាចបង្កើតឯកសារវីដេអូ MP4 ពិតប្រាកដបានទេ ដោយសារការរឹតបន្តឹងរបស់ browser និងតម្រូវការដំណើរការ server ។ វីដេអូដែលបានថតនឹងជាទម្រង់ WebM ។
            </p>

            <!-- General Controls (Audio, Video Format, FPS) -->
            <h2 class="text-2xl font-bold mb-4">ការកំណត់ទូទៅ</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div>
                    <label for="audioFile" class="block text-sm font-medium mb-2">ផ្ទុកឡើងបទចម្រៀង (MP3/WAV)</label>
                    <input type="file" id="audioFile" accept="audio/*" class="mb-4">
                </div>
                <div>
                    <label for="videoFormat" class="block text-sm font-medium mb-2">ទម្រង់វីដេអូ</label>
                    <select id="videoFormat" class="mb-4">
                        <option value="16:9">វីដេអូធម្មតា (16:9)</option>
                        <option value="9:16">Reel/Short (9:16)</option>
                        <option value="1:1">ការ៉េ (1:1)</option>
                    </select>
                </div>
                <div>
                    <label for="fps" class="block text-sm font-medium mb-2">FPS (ស៊ុមក្នុងមួយវិនាទី)</label>
                    <input type="number" id="fps" value="30" min="1" max="60" class="mb-4">
                </div>
                <!-- Global Volume Control -->
                <div class="col-span-1">
                    <label for="globalVolume" class="block text-sm font-medium mb-2">កម្រិតសំឡេង</label>
                    <input type="range" id="globalVolume" min="0" max="1" step="0.01" value="1">
                </div>
            </div>

            <!-- Element Specific Controls -->
            <h2 class="text-2xl font-bold mb-4">ការកំណត់ធាតុ</h2>

            <!-- Main Image/Background Section -->
            <details open>
                <summary>រូបភាពផ្ទៃខាងក្រោយ/រូបភាពសំខាន់</summary>
                <div class="mt-4">
                    <label for="imageFile" class="block text-sm font-medium mb-2">ផ្ទុកឡើងរូបភាព (ផ្ទៃខាងក្រោយ/រូបភាពសំខាន់)</label>
                    <input type="file" id="imageFile" accept="image/*" class="mb-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div><label class="block text-sm mb-1">ទីតាំង X</label><input type="number" id="mainImagePosX" value="0"></div>
                        <div><label class="block text-sm mb-1">ទីតាំង Y</label><input type="number" id="mainImagePosY" value="0"></div>
                        <div><label class="block text-sm mb-1">ទំហំ (Scale)</label><input type="range" id="mainImageScale" min="0.1" max="2" step="0.01" value="1"></div>
                        <div><label class="block text-sm mb-1">បង្វិល (Degrees)</label><input type="number" id="mainImageRotation" value="0" min="-360" max="360"></div>
                        <div><label class="block text-sm mb-1">តម្លាភាព (Opacity)</label><input type="range" id="mainImageOpacity" min="0" max="1" step="0.01" value="1"></div>
                        <div><label class="block text-sm mb-1">ពណ៌គែម (Stroke Color)</label><input type="color" id="mainImageStrokeColor" value="#ffffff"></div>
                        <div><label class="block text-sm mb-1">កម្រាស់គែម (Stroke Thickness)</label><input type="number" id="mainImageStrokeThickness" value="0" min="0" max="20"></div>
                        <div><label class="block text-sm mb-1">ពណ៌ស្រមោល (Shadow Color)</label><input type="color" id="mainImageShadowColor" value="#000000"></div>
                        <div><label class="block text-sm mb-1">តម្លាភាពស្រមោល</label><input type="range" id="mainImageShadowOpacity" min="0" max="1" step="0.01" value="0"></div>
                        <div><label class="block text-sm mb-1">ភាពព្រាលស្រមោល (Bluriness)</label><input type="number" id="mainImageShadowBlur" value="0" min="0" max="50"></div>
                        <div><label class="block text-sm mb-1">ចម្ងាយស្រមោល (Distance)</label><input type="number" id="mainImageShadowDistance" value="0" min="0" max="50"></div>
                        <div><label class="block text-sm mb-1">មុំស្រមោល (Angle)</label><input type="number" id="mainImageShadowAngle" value="45" min="0" max="360"></div>
                       
                        <!-- Animation Effects for Main Image -->
                        <div class="col-span-2">
                            <details>
                                <summary>ប្រភេទចលនា Effects</summary>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                    <div class="animation-control-group">
                                        <input type="checkbox" id="mainImageAnimScaleEnabled" checked>
                                        <label for="mainImageAnimScaleEnabled" class="block text-sm mb-1">កម្លាំងញាក់ទំហំ (Scale)</label>
                                        <input type="range" id="mainImageAnimScaleIntensity" min="0" max="0.2" step="0.01" value="0.1"> <!-- Increased default -->
                                        <select id="mainImageAnimScaleMode" class="animation-mode-select">
                                            <option value="Direct">Direct</option>
                                            <option value="Oscillate">Oscillate</option>
                                        </select>
                                    </div>
                                    <div class="animation-control-group">
                                        <input type="checkbox" id="mainImageAnimRotationEnabled">
                                        <label for="mainImageAnimRotationEnabled" class="block text-sm mb-1">កម្លាំងញាក់បង្វិល (Rotation)</label>
                                        <input type="number" id="mainImageAnimRotationIntensity" value="0" min="0" max="100">
                                        <select id="mainImageAnimRotationMode" class="animation-mode-select">
                                            <option value="Direct">Direct</option>
                                            <option value="Oscillate">Oscillate</option>
                                        </select>
                                    </div>
                                    <div class="animation-control-group">
                                        <input type="checkbox" id="mainImageAnimOffsetXEnabled">
                                        <label for="mainImageAnimOffsetXEnabled" class="block text-sm mb-1">កម្លាំងញាក់ X Offset</label>
                                        <input type="number" id="mainImageAnimOffsetXIntensity" value="0" min="0" max="50">
                                        <select id="mainImageAnimOffsetXMode" class="animation-mode-select">
                                            <option value="Direct">Direct</option>
                                            <option value="Oscillate">Oscillate</option>
                                        </select>
                                    </div>
                                    <div class="animation-control-group">
                                        <input type="checkbox" id="mainImageAnimOffsetYEnabled">
                                        <label for="mainImageAnimOffsetYEnabled" class="block text-sm mb-1">កម្លាំងញាក់ Y Offset</label>
                                        <input type="number" id="mainImageAnimOffsetYIntensity" value="0" min="0" max="50">
                                        <select id="mainImageAnimOffsetYMode" class="animation-mode-select">
                                            <option value="Direct">Direct</option>
                                            <option value="Oscillate">Oscillate</option>
                                            <option value="Bounce">Bounce</option>
                                        </select>
                                    </div>
                                    <div class="animation-control-group">
                                        <input type="checkbox" id="mainImageAnimBlurEnabled">
                                        <label for="mainImageAnimBlurEnabled" class="block text-sm mb-1">កម្លាំងញាក់ព្រាល (Blur)</label>
                                        <input type="number" id="mainImageAnimBlurIntensity" value="0" min="0" max="20">
                                        <select id="mainImageAnimBlurMode" class="animation-mode-select">
                                            <option value="Direct">Direct</option>
                                            <option value="Oscillate">Oscillate</option>
                                        </select>
                                    </div>
                                    <div class="animation-control-group">
                                        <input type="checkbox" id="mainImageAnimOpacityEnabled">
                                        <label for="mainImageAnimOpacityEnabled" class="block text-sm mb-1">កម្លាំងញាក់តម្លាភាព (Opacity)</label>
                                        <input type="range" id="mainImageAnimOpacityIntensity" min="0" max="0.5" step="0.01" value="0">
                                        <select id="mainImageAnimOpacityMode" class="animation-mode-select">
                                            <option value="Direct">Direct</option>
                                            <option value="Oscillate">Oscillate</option>
                                        </select>
                                    </div>
                                </div>
                            </details>
                        </div>
                    </div>
                </div>
            </details>

            <!-- Moving Image Section -->
            <details>
                <summary>រូបភាពធ្វើចលនា (Moving Image)</summary>
                <div class="mt-4">
                    <label for="movingImageFile" class="block text-sm font-medium mb-2">ផ្ទុកឡើងរូបភាពធ្វើចលនា</label>
                    <input type="file" id="movingImageFile" accept="image/*" class="mb-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div><label class="block text-sm mb-1">ទីតាំង X</label><input type="number" id="movingImagePosX" value="0"></div>
                        <div><label class="block text-sm mb-1">ទីតាំង Y</label><input type="number" id="movingImagePosY" value="0"></div>
                        <div><label class="block text-sm mb-1">ទំហំ (Scale)</label><input type="range" id="movingImageScale" min="0.1" max="2" step="0.01" value="0.5"></div>
                        <div><label class="block text-sm mb-1">បង្វិល (Degrees)</label><input type="number" id="movingImageRotation" value="0" min="-360" max="360"></div>
                        <div><label class="block text-sm mb-1">តម្លាភាព (Opacity)</label><input type="range" id="movingImageOpacity" min="0" max="1" step="0.01" value="1"></div>
                        <div><label class="block text-sm mb-1">ពណ៌គែម (Stroke Color)</label><input type="color" id="movingImageStrokeColor" value="#ffffff"></div>
                        <div><label class="block text-sm mb-1">កម្រាស់គែម (Stroke Thickness)</label><input type="number" id="movingImageStrokeThickness" value="0" min="0" max="20"></div>
                        <div><label class="block text-sm mb-1">ពណ៌ស្រមោល (Shadow Color)</label><input type="color" id="movingImageShadowColor" value="#000000"></div>
                        <div><label class="block text-sm mb-1">តម្លាភាពស្រមោល</label><input type="range" id="movingImageShadowOpacity" min="0" max="1" step="0.01" value="0"></div>
                        <div><label class="block text-sm mb-1">ភាពព្រាលស្រមោល (Bluriness)</label><input type="number" id="movingImageShadowBlur" value="0" min="0" max="50"></div>
                        <div><label class="block text-sm mb-1">ចម្ងាយស្រមោល (Distance)</label><input type="number" id="movingImageShadowDistance" value="0" min="0" max="50"></div>
                        <div><label class="block text-sm mb-1">មុំស្រមោល (Angle)</label><input type="number" id="movingImageShadowAngle" value="45" min="0" max="360"></div>
                       
                        <!-- Animation Effects for Moving Image -->
                        <div class="col-span-2">
                            <details>
                                <summary>ប្រភេទចលនា Effects</summary>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                    <div class="animation-control-group">
                                        <input type="checkbox" id="movingImageAnimScaleEnabled" checked>
                                        <label for="movingImageAnimScaleEnabled" class="block text-sm mb-1">កម្លាំងញាក់ទំហំ (Scale)</label>
                                        <input type="range" id="movingImageAnimScaleIntensity" min="0" max="0.2" step="0.01" value="0.15"> <!-- Increased default -->
                                        <select id="movingImageAnimScaleMode" class="animation-mode-select">
                                            <option value="Direct">Direct</option>
                                            <option value="Oscillate">Oscillate</option>
                                        </select>
                                    </div>
                                    <div class="animation-control-group">
                                        <input type="checkbox" id="movingImageAnimRotationEnabled">
                                        <label for="movingImageAnimRotationEnabled" class="block text-sm mb-1">កម្លាំងញាក់បង្វិល (Rotation)</label>
                                        <input type="number" id="movingImageAnimRotationIntensity" value="0" min="0" max="100">
                                        <select id="movingImageAnimRotationMode" class="animation-mode-select">
                                            <option value="Direct">Direct</option>
                                            <option value="Oscillate">Oscillate</option>
                                        </select>
                                    </div>
                                    <div class="animation-control-group">
                                        <input type="checkbox" id="movingImageAnimOffsetXEnabled">
                                        <label for="movingImageAnimOffsetXEnabled" class="block text-sm mb-1">កម្លាំងញាក់ X Offset</label>
                                        <input type="number" id="movingImageAnimOffsetXIntensity" value="0" min="0" max="50">
                                        <select id="movingImageAnimOffsetXMode" class="animation-mode-select">
                                            <option value="Direct">Direct</option>
                                            <option value="Oscillate">Oscillate</option>
                                        </select>
                                    </div>
                                    <div class="animation-control-group">
                                        <input type="checkbox" id="movingImageAnimOffsetYEnabled">
                                        <label for="movingImageAnimOffsetYEnabled" class="block text-sm mb-1">កម្លាំងញាក់ Y Offset</label>
                                        <input type="number" id="movingImageAnimOffsetYIntensity" value="0" min="0" max="50">
                                        <select id="movingImageAnimOffsetYMode" class="animation-mode-select">
                                            <option value="Direct">Direct</option>
                                            <option value="Oscillate">Oscillate</option>
                                            <option value="Bounce">Bounce</option>
                                        </select>
                                    </div>
                                    <div class="animation-control-group">
                                        <input type="checkbox" id="movingImageAnimBlurEnabled">
                                        <label for="movingImageAnimBlurEnabled" class="block text-sm mb-1">កម្លាំងញាក់ព្រាល (Blur)</label>
                                        <input type="number" id="movingImageAnimBlurIntensity" value="0" min="0" max="20">
                                        <select id="movingImageAnimBlurMode" class="animation-mode-select">
                                            <option value="Direct">Direct</option>
                                            <option value="Oscillate">Oscillate</option>
                                        </select>
                                    </div>
                                    <div class="animation-control-group">
                                        <input type="checkbox" id="movingImageAnimOpacityEnabled">
                                        <label for="movingImageAnimOpacityEnabled" class="block text-sm mb-1">កម្លាំងញាក់តម្លាភាព (Opacity)</label>
                                        <input type="range" id="movingImageAnimOpacityIntensity" min="0" max="0.5" step="0.01" value="0">
                                        <select id="movingImageAnimOpacityMode" class="animation-mode-select">
                                            <option value="Direct">Direct</option>
                                            <option value="Oscillate">Oscillate</option>
                                        </select>
                                    </div>
                                </div>
                            </details>
                        </div>
                    </div>
                </div>
            </details>

            <!-- Logo Section -->
            <details>
                <summary>ឡូហ្គោ</summary>
                <div class="mt-4">
                    <label for="logoFile" class="block text-sm font-medium mb-2">ផ្ទុកឡើងឡូហ្គោ (ស្រេចចិត្ត)</label>
                    <input type="file" id="logoFile" accept="image/*" class="mb-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div><label class="block text-sm mb-1">ទីតាំង X</label><input type="number" id="logoPosX" value="0"></div>
                        <div><label class="block text-sm mb-1">ទីតាំង Y</label><input type="number" id="logoPosY" value="0"></div>
                        <div><label class="block text-sm mb-1">ទំហំ (Scale)</label><input type="range" id="logoScale" min="0.1" max="2" step="0.01" value="1"></div>
                        <div><label class="block text-sm mb-1">បង្វិល (Degrees)</label><input type="number" id="logoRotation" value="0" min="-360" max="360"></div>
                        <div><label class="block text-sm mb-1">តម្លាភាព (Opacity)</label><input type="range" id="logoOpacity" min="0" max="1" step="0.01" value="1"></div>
                        <div><label class="block text-sm mb-1">ពណ៌គែម (Stroke Color)</label><input type="color" id="logoStrokeColor" value="#ffffff"></div>
                        <div><label class="block text-sm mb-1">កម្រាស់គែម (Stroke Thickness)</label><input type="number" id="logoStrokeThickness" value="0" min="0" max="20"></div>
                        <div><label class="block text-sm mb-1">ពណ៌ស្រមោល (Shadow Color)</labe><input type="color" id="logoShadowColor" value="#000000"></div>
                        <div><label class="block text-sm mb-1">តម្លាភាពស្រមោល</label><input type="range" id="logoShadowOpacity" min="0" max="1" step="0.01" value="0"></div>
                        <div><label class="block text-sm mb-1">ភាពព្រាលស្រមោល (Bluriness)</label><input type="number" id="logoShadowBlur" value="0" min="0" max="50"></div>
                        <div><label class="block text-sm mb-1">ចម្ងាយស្រមោល (Distance)</label><input type="number" id="logoShadowDistance" value="0" min="0" max="50"></div>
                        <div><label class="block text-sm mb-1">មុំស្រមោល (Angle)</label><input type="number" id="logoShadowAngle" value="45" min="0" max="360"></div>
                       
                        <!-- Animation Effects for Logo -->
                        <div class="col-span-2">
                            <details>
                                <summary>ប្រភេទចលនា Effects</summary>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                    <div class="animation-control-group">
                                        <input type="checkbox" id="logoAnimScaleEnabled" checked>
                                        <label for="logoAnimScaleEnabled" class="block text-sm mb-1">កម្លាំងញាក់ទំហំ (Scale)</label>
                                        <input type="range" id="logoAnimScaleIntensity" min="0" max="0.2" step="0.01" value="0.2"> <!-- Increased default -->
                                        <select id="logoAnimScaleMode" class="animation-mode-select">
                                            <option value="Direct">Direct</option>
                                            <option value="Oscillate">Oscillate</option>
                                        </select>
                                    </div>
                                    <div class="animation-control-group">
                                        <input type="checkbox" id="logoAnimRotationEnabled">
                                        <label for="logoAnimRotationEnabled" class="block text-sm mb-1">កម្លាំងញាក់បង្វិល (Rotation)</label>
                                        <input type="number" id="logoAnimRotationIntensity" value="0" min="0" max="100">
                                        <select id="logoAnimRotationMode" class="animation-mode-select">
                                            <option value="Direct">Direct</option>
                                            <option value="Oscillate">Oscillate</option>
                                        </select>
                                    </div>
                                    <div class="animation-control-group">
                                        <input type="checkbox" id="logoAnimOffsetXEnabled">
                                        <label for="logoAnimOffsetXEnabled" class="block text-sm mb-1">កម្លាំងញាក់ X Offset</label>
                                        <input type="number" id="logoAnimOffsetXIntensity" value="0" min="0" max="50">
                                        <select id="logoAnimOffsetXMode" class="animation-mode-select">
                                            <option value="Direct">Direct</option>
                                            <option value="Oscillate">Oscillate</option>
                                        </select>
                                    </div>
                                    <div class="animation-control-group">
                                        <input type="checkbox" id="logoAnimOffsetYEnabled">
                                        <label for="logoAnimOffsetYEnabled" class="block text-sm mb-1">កម្លាំងញាក់ Y Offset</label>
                                        <input type="number" id="logoAnimOffsetYIntensity" value="0" min="0" max="50">
                                        <select id="logoAnimOffsetYMode" class="animation-mode-select">
                                            <option value="Direct">Direct</option>
                                            <option value="Oscillate">Oscillate</option>
                                            <option value="Bounce">Bounce</option>
                                        </select>
                                    </div>
                                    <div class="animation-control-group">
                                        <input type="checkbox" id="logoAnimBlurEnabled">
                                        <label for="logoAnimBlurEnabled" class="block text-sm mb-1">កម្លាំងញាក់ព្រាល (Blur)</label>
                                        <input type="number" id="logoAnimBlurIntensity" value="0" min="0" max="20">
                                        <select id="logoAnimBlurMode" class="animation-mode-select">
                                            <option value="Direct">Direct</option>
                                            <option value="Oscillate">Oscillate</option>
                                        </select>
                                    </div>
                                    <div class="animation-control-group">
                                        <input type="checkbox" id="logoAnimOpacityEnabled">
                                        <label for="logoAnimOpacityEnabled" class="block text-sm mb-1">កម្លាំងញាក់តម្លាភាព (Opacity)</label>
                                        <input type="range" id="logoAnimOpacityIntensity" min="0" max="0.5" step="0.01" value="0">
                                        <select id="logoAnimOpacityMode" class="animation-mode-select">
                                            <option value="Direct">Direct</option>
                                            <option value="Oscillate">Oscillate</option>
                                        </select>
                                    </div>
                                </div>
                            </details>
                        </div>
                    </div>
                </div>
            </details>

            <!-- Title Section -->
            <details>
                <summary>ចំណងជើង</summary>
                <div class="mt-4">
                    <label for="videoTitle" class="block text-sm font-medium mb-2">ចំណងជើងវីដេអូ</label>
                    <textarea id="videoTitle" placeholder="បញ្ចូលចំណងជើងវីដេអូ" rows="3" class="mb-4"></textarea> <!-- Changed to textarea -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div class="font-input-group">
                            <label class="block text-sm mb-1">ពុម្ពអក្សរ (Font)</label>
                            <select id="titleFontFamilySelect">
                                <option value="Inter">Inter</option>
                                <option value="Roboto">Roboto</option>
                                <option value="Open Sans">Open Sans</option>
                                <option value="Noto Sans Khmer">Noto Sans Khmer</option>
                                <option value="Hanuman">Hanuman</option>
                                <option value="Koh Santepheap">Koh Santepheap</option>
                                <option value="Moul">Moul</option>
                                <option value="Battambang">Battambang</option>
                                <option value="Content">Content</option>
                                <option value="Kantumruy Pro">Kantumruy Pro</option>
                                <option value="Koulen">Koulen</option>
                                <option value="Odor Mean Chey">Odor Mean Chey</option>
                                <option value="Preahvihear">Preahvihear</option>
                                <option value="Suwannaphum">Suwannaphum</option>
                                <option value="custom-upload">ផ្ទាល់ខ្លួន (ផ្ទុកឡើង)</option>
                                <option value="custom-url">ផ្ទាល់ខ្លួន (URL)</option>
                            </select>
                            <input type="file" id="titleFontUpload" accept=".ttf,.otf,.woff,.woff2" class="hidden mt-2">
                            <input type="text" id="titleFontUrl" placeholder="បញ្ចូល URL ពុម្ពអក្សរ (CSS)" class="hidden mt-2">
                            <input type="text" id="titleCustomFontName" placeholder="ឈ្មោះពុម្ពអក្សរពី URL" class="hidden mt-2">
                        </div>
                        <div><label class="block text-sm mb-1">ទំហំពុម្ពអក្សរ (Size)</label><input type="number" id="titleFontSize" value="30" min="10" max="200"></div>
                        <div>
                            <label class="block text-sm mb-1">រចនាប័ទ្ម (Style)</label>
                            <select id="titleFontStyle">
                                <option value="normal">ធម្មតា</option>
                                <option value="bold">ដិត</option>
                                <option value="italic">ទ្រេត</option>
                                <option value="bold italic">ដិត & ទ្រេត</option>
                            </select>
                        </div>
                        <div><label class="block text-sm mb-1">ពណ៌ (Color)</label><input type="color" id="titleColor" value="#ffffff"></div>
                        <div><label class="block text-sm mb-1">កម្ពស់បន្ទាត់ (Line Height)</label><input type="range" id="titleLineHeight" min="0.5" max="2.5" step="0.1" value="1.2"></div>
                        <div>
                            <label class="block text-sm mb-1">តម្រឹម (Alignment)</label>
                            <select id="titleAlignment">
                                <option value="left">ឆ្វេង</option>
                                <option value="center">កណ្តាល</option>
                                <option value="right">ស្តាំ</option>
                            </select>
                        </div>
                        <div><label class="block text-sm mb-1">ទីតាំង X</label><input type="number" id="titlePosX" value="0.5" step="0.01"></div>
                        <div><label class="block text-sm mb-1">ទីតាំង Y</label><input type="number" id="titlePosY" value="0.15" step="0.01"></div>
                        <div><label class="block text-sm mb-1">ទំហំ (Scale)</label><input type="range" id="titleScale" min="0.1" max="2" step="0.01" value="1"></div>
                        <div><label class="block text-sm mb-1">បង្វិល (Degrees)</label><input type="number" id="titleRotation" value="0" min="-360" max="360"></div>
                        <div><label class="block text-sm mb-1">តម្លាភាព (Opacity)</label><input type="range" id="titleOpacity" min="0" max="1" step="0.01" value="1"></div>
                        <div><label class="block text-sm mb-1">ពណ៌គែម (Stroke Color)</label><input type="color" id="titleStrokeColor" value="#ffffff"></div>
                        <div><label class="block text-sm mb-1">កម្រាស់គែម (Stroke Thickness)</label><input type="number" id="titleStrokeThickness" value="0" min="0" max="20"></div>
                        <div class="col-span-2"><h4 class="font-medium mt-2">ផ្ទៃខាងក្រោយអត្ថបទ</h4></div>
                        <div><label class="block text-sm mb-1">ពណ៌ផ្ទៃខាងក្រោយ</label><input type="color" id="titleBgColor" value="#000000"></div>
                        <div><label class="block text-sm mb-1">តម្លាភាពផ្ទៃខាងក្រោយ</label><input type="range" id="titleBgOpacity" min="0" max="1" step="0.01" value="0"></div>
                        <div><label class="block text-sm mb-1">ជ្រុងមូល (Rounded Rect)</label><input type="number" id="titleBgRoundedRect" value="0" min="0" max="50"></div>
                        <div><label class="block text-sm mb-1">កម្ពស់ផ្ទៃខាងក្រោយ</label><input type="range" id="titleBgHeight" min="0.5" max="2" step="0.01" value="1"></div>
                        <div><label class="block text-sm mb-1">ទទឹងផ្ទៃខាងក្រោយ</label><input type="range" id="titleBgWidth" min="0.5" max="2" step="0.01" value="1"></div>
                        <div><label class="block text-sm mb-1">X Offset ផ្ទៃខាងក្រោយ</label><input type="number" id="titleBgOffsetX" value="0"></div>
                        <div><label class="block text-sm mb-1">Y Offset ផ្ទៃខាងក្រោយ</label><input type="number" id="titleBgOffsetY" value="0"></div>
                        <div class="col-span-2"><h4 class="font-medium mt-2">ស្រមោលអត្ថបទ</h4></div>
                        <div><label class="block text-sm mb-1">ពណ៌ស្រមោល</label><input type="color" id="titleShadowColor" value="#000000"></div>
                        <div><label class="block text-sm mb-1">តម្លាភាពស្រមោល</label><input type="range" id="titleShadowOpacity" min="0" max="1" step="0.01" value="0"></div>
                        <div><label class="block text-sm mb-1">ភាពព្រាលស្រមោល (Bluriness)</label><input type="number" id="titleShadowBlur" value="0" min="0" max="50"></div>
                        <div><label class="block text-sm mb-1">ចម្ងាយស្រមោល (Distance)</label><input type="number" id="titleShadowDistance" value="0" min="0" max="50"></div>
                        <div><label class="block text-sm mb-1">មុំស្រមោល (Angle)</label><input type="number" id="titleShadowAngle" value="45" min="0" max="360"></div>
                       
                        <!-- Animation Effects for Title -->
                        <div class="col-span-2">
                            <details>
                                <summary>ប្រភេទចលនា Effects</summary>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                    <div class="animation-control-group">
                                        <input type="checkbox" id="titleAnimScaleEnabled" checked>
                                        <label for="titleAnimScaleEnabled" class="block text-sm mb-1">កម្លាំងញាក់ទំហំ (Scale)</label>
                                        <input type="range" id="titleAnimScaleIntensity" min="0" max="15" step="0.01" value="1.5"> <!-- Max and default value increased -->
                                        <select id="titleAnimScaleMode" class="animation-mode-select">
                                            <option value="Direct">Direct</option>
                                            <option value="Oscillate">Oscillate</option>
                                        </select>
                                    </div>
                                    <div class="animation-control-group">
                                        <input type="checkbox" id="titleAnimRotationEnabled">
                                        <label for="titleAnimRotationEnabled" class="block text-sm mb-1">កម្លាំងញាក់បង្វិល (Rotation)</label>
                                        <input type="number" id="titleAnimRotationIntensity" value="0" min="0" max="100">
                                        <select id="titleAnimRotationMode" class="animation-mode-select">
                                            <option value="Direct">Direct</option>
                                            <option value="Oscillate">Oscillate</option>
                                        </select>
                                    </div>
                                    <div class="animation-control-group">
                                        <input type="checkbox" id="titleAnimOffsetXEnabled">
                                        <label for="titleAnimOffsetXEnabled" class="block text-sm mb-1">កម្លាំងញាក់ X Offset</label>
                                        <input type="number" id="titleAnimOffsetXIntensity" value="0" min="0" max="50">
                                        <select id="titleAnimOffsetXMode" class="animation-mode-select">
                                            <option value="Direct">Direct</option>
                                            <option value="Oscillate">Oscillate</option>
                                        </select>
                                    </div>
                                    <div class="animation-control-group">
                                        <input type="checkbox" id="titleAnimOffsetYEnabled">
                                        <label for="titleAnimOffsetYEnabled" class="block text-sm mb-1">កម្លាំងញាក់ Y Offset</label>
                                        <input type="number" id="titleAnimOffsetYIntensity" value="0" min="0" max="50">
                                        <select id="titleAnimOffsetYMode" class="animation-mode-select">
                                            <option value="Direct">Direct</option>
                                            <option value="Oscillate">Oscillate</option>
                                            <option value="Bounce">Bounce</option>
                                        </select>
                                    </div>
                                    <div class="animation-control-group">
                                        <input type="checkbox" id="titleAnimBlurEnabled">
                                        <label for="titleAnimBlurEnabled" class="block text-sm mb-1">កម្លាំងញាក់ព្រាល (Blur)</label>
                                        <input type="number" id="titleAnimBlurIntensity" value="0" min="0" max="20">
                                        <select id="titleAnimBlurMode" class="animation-mode-select">
                                            <option value="Direct">Direct</option>
                                            <option value="Oscillate">Oscillate</option>
                                        </select>
                                    </div>
                                    <div class="animation-control-group">
                                        <input type="checkbox" id="titleAnimOpacityEnabled">
                                        <label for="titleAnimOpacityEnabled" class="block text-sm mb-1">កម្លាំងញាក់តម្លាភាព (Opacity)</label>
                                        <input type="range" id="titleAnimOpacityIntensity" min="0" max="0.5" step="0.01" value="0">
                                        <select id="titleAnimOpacityMode" class="animation-mode-select">
                                            <option value="Direct">Direct</option>
                                            <option value="Oscillate">Oscillate</option>
                                        </select>
                                    </div>
                                </div>
                            </details>
                        </div>
                    </div>
                </div>
            </details>

            <!-- Text Section -->
            <details>
                <summary>អត្ថបទ</summary>
                <div class="mt-4">
                    <label for="videoText" class="block text-sm font-medium mb-2">អត្ថបទ</label>
                    <textarea id="videoText" placeholder="បញ្ចូលអត្ថបទ" rows="5" class="mb-4"></textarea> <!-- Changed to textarea -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div class="font-input-group">
                            <label class="block text-sm mb-1">ពុម្ពអក្សរ (Font)</label>
                            <select id="textFontFamilySelect">
                                <option value="Inter">Inter</option>
                                <option value="Roboto">Roboto</option>
                                <option value="Open Sans">Open Sans</option>
                                <option value="Noto Sans Khmer">Noto Sans Khmer</option>
                                <option value="Hanuman">Hanuman</option>
                                <option value="Koh Santepheap">Koh Santepheap</option>
                                <option value="Moul">Moul</option>
                                <option value="Battambang">Battambang</option>
                                <option value="Content">Content</option>
                                <option value="Kantumruy Pro">Kantumruy Pro</option>
                                <option value="Koulen">Koulen</option>
                                <option value="Odor Mean Chey">Odor Mean Chey</option>
                                <option value="Preahvihear">Preahvihear</option>
                                <option value="Suwannaphum">Suwannaphum</option>
                                <option value="custom-upload">ផ្ទាល់ខ្លួន (ផ្ទុកឡើង)</option>
                                <option value="custom-url">ផ្ទាល់ខ្លួន (URL)</option>
                            </select>
                            <input type="file" id="textFontUpload" accept=".ttf,.otf,.woff,.woff2" class="hidden mt-2">
                            <input type="text" id="textFontUrl" placeholder="បញ្ចូល URL ពុម្ពអក្សរ (CSS)" class="hidden mt-2">
                            <input type="text" id="textCustomFontName" placeholder="ឈ្មោះពុម្ពអក្សរពី URL" class="hidden mt-2">
                        </div>
                        <div><label class="block text-sm mb-1">ទំហំពុម្ពអក្សរ (Size)</label><input type="number" id="textFontSize" value="20" min="10" max="200"></div>
                        <div>
                            <label class="block text-sm mb-1">រចនាប័ទ្ម (Style)</label>
                            <select id="textFontStyle">
                                <option value="normal">ធម្មតា</option>
                                <option value="bold">ដិត</option>
                                <option value="italic">ទ្រេត</option>
                                <option value="bold italic">ដិត & ទ្រេត</option>
                            </select>
                        </div>
                        <div><label class="block text-sm mb-1">ពណ៌ (Color)</label><input type="color" id="textColor" value="#cccccc"></div>
                        <div><label class="block text-sm mb-1">កម្ពស់បន្ទាត់ (Line Height)</label><input type="range" id="textLineHeight" min="0.5" max="2.5" step="0.1" value="1.2"></div>
                        <div>
                            <label class="block text-sm mb-1">តម្រឹម (Alignment)</label>
                            <select id="textAlign" value="center">
                                <option value="left">ឆ្វេង</option>
                                <option value="center">កណ្តាល</option>
                                <option value="right">ស្តាំ</option>
                            </select>
                        </div>
                        <div><label class="block text-sm mb-1">ទីតាំង X</label><input type="number" id="textPosX" value="0.5" step="0.01"></div>
                        <div><label class="block text-sm mb-1">ទីតាំង Y</label><input type="number" id="textPosY" value="0.85" step="0.01"></div>
                        <div><label class="block text-sm mb-1">ទំហំ (Scale)</label><input type="range" id="textScale" min="0.1" max="2" step="0.01" value="1"></div>
                        <div><label class="block text-sm mb-1">បង្វិល (Degrees)</label><input type="number" id="textRotation" value="0" min="-360" max="360"></div>
                        <div><label class="block text-sm mb-1">តម្លាភាព (Opacity)</label><input type="range" id="textOpacity" min="0" max="1" step="0.01" value="1"></div>
                        <div><label class="block text-sm mb-1">ពណ៌គែម (Stroke Color)</label><input type="color" id="textStrokeColor" value="#ffffff"></div>
                        <div><label class="block text-sm mb-1">កម្រាស់គែម (Stroke Thickness)</label><input type="number" id="textStrokeThickness" value="0" min="0" max="20"></div>
                        <div class="col-span-2"><h4 class="font-medium mt-2">ផ្ទៃខាងក្រោយអត្ថបទ</h4></div>
                        <div><label class="block text-sm mb-1">ពណ៌ផ្ទៃខាងក្រោយ</label><input type="color" id="textBgColor" value="#000000"></div>
                        <div><label class="block text-sm mb-1">តម្លាភាពផ្ទៃខាងក្រោយ</label><input type="range" id="textBgOpacity" min="0" max="1" step="0.01" value="0"></div>
                        <div><label class="block text-sm mb-1">ជ្រុងមូល (Rounded Rect)</label><input type="number" id="textBgRoundedRect" value="0" min="0" max="50"></div>
                        <div><label class="block text-sm mb-1">កម្ពស់ផ្ទៃខាងក្រោយ</label><input type="range" id="textBgHeight" min="0.5" max="2" step="0.01" value="1"></div>
                        <div><label class="block text-sm mb-1">ទទឹងផ្ទៃខាងក្រោយ</label><input type="range" id="textBgWidth" min="0.5" max="2" step="0.01" value="1"></div>
                        <div><label class="block text-sm mb-1">X Offset ផ្ទៃខាងក្រោយ</label><input type="number" id="textBgOffsetX" value="0"></div>
                        <div><label class="block text-sm mb-1">Y Offset ផ្ទៃខាងក្រោយ</label><input type="number" id="textBgOffsetY" value="0"></div>
                        <div class="col-span-2"><h4 class="font-medium mt-2">ស្រមោលអត្ថបទ</h4></div>
                        <div><label class="block text-sm mb-1">ពណ៌ស្រមោល</label><input type="color" id="textShadowColor" value="#000000"></div>
                        <div><label class="block text-sm mb-1">តម្លាភាពស្រមោល</label><input type="range" id="textShadowOpacity" min="0" max="1" step="0.01" value="0"></div>
                        <div><label class="block text-sm mb-1">ភាពព្រាលស្រមោល (Bluriness)</label><input type="number" id="textShadowBlur" value="0" min="0" max="50"></div>
                        <div><label class="block text-sm mb-1">ចម្ងាយស្រមោល (Distance)</label><input type="number" id="textShadowDistance" value="0" min="0" max="50"></div>
                        <div><label class="block text-sm mb-1">មុំស្រមោល (Angle)</label><input type="number" id="textShadowAngle" value="45" min="0" max="360"></div>
                       
                        <!-- Animation Effects for Text -->
                        <div class="col-span-2">
                            <details>
                                <summary>ប្រភេទចលនា Effects</summary>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                    <div class="animation-control-group">
                                        <input type="checkbox" id="textAnimScaleEnabled" checked>
                                        <label for="textAnimScaleEnabled" class="block text-sm mb-1">កម្លាំងញាក់ទំហំ (Scale)</label>
                                        <input type="range" id="textAnimScaleIntensity" min="0" max="15" step="0.01" value="1"> <!-- Max and default value increased -->
                                        <select id="textAnimScaleMode" class="animation-mode-select">
                                            <option value="Direct">Direct</option>
                                            <option value="Oscillate">Oscillate</option>
                                        </select>
                                    </div>
                                    <div class="animation-control-group">
                                        <input type="checkbox" id="textAnimRotationEnabled">
                                        <label for="textAnimRotationEnabled" class="block text-sm mb-1">កម្លាំងញាក់បង្វិល (Rotation)</label>
                                        <input type="number" id="textAnimRotationIntensity" value="0" min="0" max="100">
                                        <select id="textAnimRotationMode" class="animation-mode-select">
                                            <option value="Direct">Direct</option>
                                            <option value="Oscillate">Oscillate</option>
                                        </select>
                                    </div>
                                    <div class="animation-control-group">
                                        <input type="checkbox" id="textAnimOffsetXEnabled">
                                        <label for="textAnimOffsetXEnabled" class="block text-sm mb-1">កម្លាំងញាក់ X Offset</label>
                                        <input type="number" id="textAnimOffsetXIntensity" value="0" min="0" max="50">
                                        <select id="textAnimOffsetXMode" class="animation-mode-select">
                                            <option value="Direct">Direct</option>
                                            <option value="Oscillate">Oscillate</option>
                                        </select>
                                    </div>
                                    <div class="animation-control-group">
                                        <input type="checkbox" id="textAnimOffsetYEnabled">
                                        <label for="textAnimOffsetYEnabled" class="block text-sm mb-1">កម្លាំងញាក់ Y Offset</label>
                                        <input type="number" id="textAnimOffsetYIntensity" value="0" min="0" max="50">
                                        <select id="textAnimOffsetYMode" class="animation-mode-select">
                                            <option value="Direct">Direct</option>
                                            <option value="Oscillate">Oscillate</option>
                                            <option value="Bounce">Bounce</option>
                                        </select>
                                    </div>
                                    <div class="animation-control-group">
                                        <input type="checkbox" id="textAnimBlurEnabled">
                                        <label for="textAnimBlurEnabled" class="block text-sm mb-1">កម្លាំងញាក់ព្រាល (Blur)</label>
                                        <input type="number" id="textAnimBlurIntensity" value="0" min="0" max="20">
                                        <select id="textAnimBlurMode" class="animation-mode-select">
                                            <option value="Direct">Direct</option>
                                            <option value="Oscillate">Oscillate</option>
                                        </select>
                                    </div>
                                    <div class="animation-control-group">
                                        <input type="checkbox" id="textAnimOpacityEnabled">
                                        <label for="textAnimOpacityEnabled" class="block text-sm mb-1">កម្លាំងញាក់តម្លាភាព (Opacity)</label>
                                        <input type="range" id="textAnimOpacityIntensity" min="0" max="0.5" step="0.01" value="0">
                                        <select id="textAnimOpacityMode" class="animation-mode-select">
                                            <option value="Direct">Direct</option>
                                            <option value="Oscillate">Oscillate</option>
                                        </select>
                                    </div>
                                </div>
                            </details>
                        </div>
                    </div>
                </div>
            </details>

            <!-- Visualizer Section (NEW) -->
            <details>
                <summary>Visualizer</summary>
                <div class="mt-4">
                    <div class="animation-control-group mb-4">
                        <input type="checkbox" id="visualizerEnabled" checked>
                        <label for="visualizerEnabled" class="block text-sm font-medium">បើក Visualizer</label>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div><label class="block text-sm mb-1">ទីតាំង X (0-1)</label><input type="range" id="visualizerPosX" min="0" max="1" step="0.01" value="0.5"></div>
                        <div><label class="block text-sm mb-1">ទីតាំង Y (0-1)</label><input type="range" id="visualizerPosY" min="0" max="1" step="0.01" value="0.7"></div>
                        <div><label class="block text-sm mb-1">ទទឹង (0-1)</label><input type="range" id="visualizerWidth" min="0.1" max="1" step="0.01" value="0.6"></div>
                        <div><label class="block text-sm mb-1">កម្ពស់មូលដ្ឋាន</label><input type="number" id="visualizerHeight" value="50" min="10" max="200"></div>
                        <div><label class="block text-sm mb-1">ទំហំ (Scale)</label><input type="range" id="visualizerScale" min="0.1" max="2" step="0.01" value="1"></div>
                        <div><label class="block text-sm mb-1">បង្វិល (Degrees)</label><input type="number" id="visualizerRotation" value="0" min="-360" max="360"></div>
                        <div><label class="block text-sm mb-1">តម្លាភាព (Opacity)</label><input type="range" id="visualizerOpacity" min="0" max="1" step="0.01" value="1"></div>
                        <div><label class="block text-sm mb-1">ពណ៌ (Color)</label><input type="color" id="visualizerColor" value="#63b3ed"></div>
                        <div><label class="block text-sm mb-1">ពណ៌គែម (Stroke Color)</label><input type="color" id="visualizerStrokeColor" value="#63b3ed"></div>
                        <div><label class="block text-sm mb-1">កម្រាស់គែម (Stroke Thickness)</label><input type="number" id="visualizerStrokeThickness" value="2" min="0" max="20"></div>
                        <div>
                            <label class="block text-sm mb-1">តម្រឹម (Alignment)</label>
                            <select id="visualizerAlignment">
                                <option value="left">ឆ្វេង</option>
                                <option value="center">កណ្តាល</option>
                                <option value="right">ស្តាំ</option>
                            </select>
                        </div>
                        <div><label class="block text-sm mb-1">ពណ៌ស្រមោល (Shadow Color)</label><input type="color" id="visualizerShadowColor" value="#000000"></div>
                        <div><label class="block text-sm mb-1">តម្លាភាពស្រមោល</label><input type="range" id="visualizerShadowOpacity" min="0" max="1" step="0.01" value="0"></div>
                        <div><label class="block text-sm mb-1">ភាពព្រាលស្រមោល (Bluriness)</label><input type="number" id="visualizerShadowBlur" value="0" min="0" max="50"></div>
                        <div><label class="block text-sm mb-1">ចម្ងាយស្រមោល (Distance)</label><input type="number" id="visualizerShadowDistance" value="0" min="0" max="50"></div>
                        <div><label class="block text-sm mb-1">មុំស្រមោល (Angle)</label><input type="number" id="visualizerShadowAngle" value="45" min="0" max="360"></div>
                       
                        <!-- Animation Effects for Visualizer -->
                        <div class="col-span-2">
                            <details>
                                <summary>ប្រភេទចលនា Effects</summary>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                    <div class="animation-control-group">
                                        <input type="checkbox" id="visualizerAnimScaleEnabled" checked>
                                        <label for="visualizerAnimScaleEnabled" class="block text-sm mb-1">កម្លាំងញាក់ទំហំ (Scale)</label>
                                        <input type="range" id="visualizerAnimScaleIntensity" min="0" max="0.5" step="0.01" value="0.8"> <!-- Increased default -->
                                        <select id="visualizerAnimScaleMode" class="animation-mode-select">
                                            <option value="Direct">Direct</option>
                                            <option value="Oscillate">Oscillate</option>
                                        </select>
                                    </div>
                                    <div class="animation-control-group">
                                        <input type="checkbox" id="visualizerAnimRotationEnabled">
                                        <label for="visualizerAnimRotationEnabled" class="block text-sm mb-1">កម្លាំងញាក់បង្វិល (Rotation)</label>
                                        <input type="number" id="visualizerAnimRotationIntensity" value="0" min="0" max="100">
                                        <select id="visualizerAnimRotationMode" class="animation-mode-select">
                                            <option value="Direct">Direct</option>
                                            <option value="Oscillate">Oscillate</option>
                                        </select>
                                    </div>
                                    <div class="animation-control-group">
                                        <input type="checkbox" id="visualizerAnimOffsetXEnabled">
                                        <label for="visualizerAnimOffsetXEnabled" class="block text-sm mb-1">កម្លាំងញាក់ X Offset</label>
                                        <input type="number" id="visualizerAnimOffsetXIntensity" value="0" min="0" max="50">
                                        <select id="visualizerAnimOffsetXMode" class="animation-mode-select">
                                            <option value="Direct">Direct</option>
                                            <option value="Oscillate">Oscillate</option>
                                        </select>
                                    </div>
                                    <div class="animation-control-group">
                                        <input type="checkbox" id="visualizerAnimOffsetYEnabled" checked>
                                        <label for="visualizerAnimOffsetYEnabled" class="block text-sm mb-1">កម្លាំងញាក់ Y Offset</label>
                                        <input type="number" id="visualizerAnimOffsetYIntensity" value="40"> <!-- Increased default -->
                                        <select id="visualizerAnimOffsetYMode" class="animation-mode-select">
                                            <option value="Direct">Direct</option>
                                            <option value="Oscillate">Oscillate</option>
                                            <option value="Bounce">Bounce</option>
                                        </select>
                                    </div>
                                    <div class="animation-control-group">
                                        <input type="checkbox" id="visualizerAnimBlurEnabled">
                                        <label for="visualizerAnimBlurEnabled" class="block text-sm mb-1">កម្លាំងញាក់ព្រាល (Blur)</label>
                                        <input type="number" id="visualizerAnimBlurIntensity" value="0" min="0" max="20">
                                        <select id="visualizerAnimBlurMode" class="animation-mode-select">
                                            <option value="Direct">Direct</option>
                                            <option value="Oscillate">Oscillate</option>
                                        </select>
                                    </div>
                                    <div class="animation-control-group">
                                        <input type="checkbox" id="visualizerAnimOpacityEnabled" checked>
                                        <label for="visualizerAnimOpacityEnabled" class="block text-sm mb-1">កម្លាំងញាក់តម្លាភាព (Opacity)</label>
                                        <input type="range" id="visualizerAnimOpacityIntensity" min="0" max="0.5" step="0.01" value="0.8"> <!-- Increased default -->
                                        <select id="visualizerAnimOpacityMode" class="animation-mode-select">
                                            <option value="Direct">Direct</option>
                                            <option value="Oscillate">Oscillate</option>
                                        </select>
                                    </div>
                                </div>
                            </details>
                        </div>
                    </div>
                </div>
            </details>
        </div>
       
        <!-- Controls below Canvas -->
        <div class="flex flex-col sm:flex-row justify-center gap-4 mt-6 w-full lg:w-3/4 xl:w-2/3">
            <button id="playPauseButton" class="flex-1 bg-blue-600 hover:bg-blue-800 text-white">លេង/ផ្អាក</button>
            <button id="recordButton" class="flex-1 bg-red-500 hover:bg-red-700 text-white">
                ថតវីដេអូ <span id="recordingIndicator" class="recording-indicator hidden"></span>
            </button>
            <button id="downloadImageButton" class="flex-1 bg-green-500 hover:bg-green-700 text-white">ទាញយករូបភាព</button>
        </div>
        <div class="flex flex-col sm:flex-row justify-center gap-4 mt-4 w-full lg:w-3/4 xl:w-2/3">
             <button id="generatePreview" class="flex-1">បង្កើតការមើលជាមុន</button>
        </div>


        <div id="messageBox" class="message-box w-full lg:w-3/4 xl:w-2/3"></div>

        <canvas id="videoCanvas" class="w-full lg:w-3/4 xl:w-2/3"></canvas>
    </div>

    <script>
        // Global variables for Firebase configuration, if available
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Canvas and context
        const canvas = document.getElementById('videoCanvas');
        const ctx = canvas.getContext('2d');

        // UI elements
        const audioFileInput = document.getElementById('audioFile');
        const imageFileInput = document.getElementById('imageFile');
        const movingImageFileInput = document.getElementById('movingImageFile');
        const logoFileInput = document.getElementById('logoFile');
        const videoTitleInput = document.getElementById('videoTitle');
        const videoTextInput = document.getElementById('videoText');
        const videoFormatSelect = document.getElementById('videoFormat');
        const fpsInput = document.getElementById('fps');
        const globalVolumeInput = document.getElementById('globalVolume'); // New volume control
        const generateButton = document.getElementById('generatePreview');
        const recordButton = document.getElementById('recordButton');
        const downloadImageButton = document.getElementById('downloadImageButton');
        const playPauseButton = document.getElementById('playPauseButton'); // New play/pause button
        const messageBox = document.getElementById('messageBox');
        const recordingIndicator = document.getElementById('recordingIndicator');

        // Audio variables
        let audioContext;
        let analyser;
        let source;
        let gainNode; // New gain node for volume control
        let audioBuffer;
        let dataArray;
        let bufferLength;
        let isPlaying = false; // Track if audio is currently playing

        // Image variables
        let mainImage = new Image();
        let movingImage = new Image();
        let logoImage = new Image();
        let mainImageLoaded = false;
        let movingImageLoaded = false;
        let logoImageLoaded = false;

        // Animation variables
        let animationFrameId;
        let lastFrameTime = 0;
        let fpsInterval = 1000 / 30; // Default FPS

        // Recording variables
        let mediaRecorder;
        let recordedChunks = [];
        let isRecording = false;

        // --- Styling Settings Object ---
        const settings = {
            mainImage: {
                positionX: 0,
                positionY: 0,
                scale: 1,
                rotation: 0, // in degrees
                opacity: 1,
                strokeColor: '#ffffff',
                strokeThickness: 0,
                shadowColor: '#000000',
                shadowOpacity: 0,
                shadowBlur: 0,
                shadowDistance: 0,
                shadowAngle: 45, // in degrees
                // Sound-reactive animation intensities
                animations: {
                    scale: { enabled: true, intensity: 0.1, mode: 'Direct' }, // Increased default
                    rotation: { enabled: false, intensity: 0, mode: 'Direct' },
                    offsetX: { enabled: false, intensity: 0, mode: 'Direct' },
                    offsetY: { enabled: false, intensity: 0, mode: 'Direct' },
                    blur: { enabled: false, intensity: 0, mode: 'Direct' },
                    opacity: { enabled: false, intensity: 0, mode: 'Direct' }
                }
            },
            movingImage: {
                positionX: 0,
                positionY: 0,
                scale: 0.5, // Default smaller scale
                rotation: 0,
                opacity: 1,
                strokeColor: '#ffffff',
                strokeThickness: 0,
                shadowColor: '#000000',
                shadowOpacity: 0,
                shadowBlur: 0,
                shadowDistance: 0,
                shadowAngle: 45,
                animations: {
                    scale: { enabled: true, intensity: 0.15, mode: 'Direct' }, // Increased default
                    rotation: { enabled: false, intensity: 0, mode: 'Direct' },
                    offsetX: { enabled: false, intensity: 0, mode: 'Direct' },
                    offsetY: { enabled: false, intensity: 0, mode: 'Direct' },
                    blur: { enabled: false, intensity: 0, mode: 'Direct' },
                    opacity: { enabled: false, intensity: 0, mode: 'Direct' }
                }
            },
            logo: {
                positionX: 0,
                positionY: 0,
                scale: 1,
                rotation: 0,
                opacity: 1,
                strokeColor: '#ffffff',
                strokeThickness: 0,
                shadowColor: '#000000',
                shadowOpacity: 0,
                shadowBlur: 0,
                shadowDistance: 0,
                shadowAngle: 45,
                animations: {
                    scale: { enabled: true, intensity: 0.2, mode: 'Direct' }, // Increased default
                    rotation: { enabled: false, intensity: 0, mode: 'Direct' },
                    offsetX: { enabled: false, intensity: 0, mode: 'Direct' },
                    offsetY: { enabled: false, intensity: 0, mode: 'Direct' },
                    blur: { enabled: false, intensity: 0, mode: 'Direct' },
                    opacity: { enabled: false, intensity: 0, mode: 'Direct' }
                }
            },
            title: {
                fontFamily: 'Inter',
                customFontFamily: '',
                fontSize: 30,
                fontStyle: 'normal',
                color: '#ffffff',
                lineHeight: 1.2,
                alignment: 'center',
                positionX: 0.5,
                positionY: 0.15,
                scale: 1,
                rotation: 0,
                opacity: 1,
                strokeColor: '#ffffff',
                strokeThickness: 0,
                bgColor: '#000000',
                bgOpacity: 0,
                bgRoundedRect: 0,
                bgHeight: 1,
                bgWidth: 1,
                bgOffsetX: 0,
                bgOffsetY: 0,
                shadowColor: '#000000',
                shadowOpacity: 0,
                shadowBlur: 0,
                shadowDistance: 0,
                shadowAngle: 45,
                animations: {
                    scale: { enabled: true, intensity: 1.5, mode: 'Direct' }, // Increased default to 1.5
                    rotation: { enabled: false, intensity: 0, mode: 'Direct' },
                    offsetX: { enabled: false, intensity: 0, mode: 'Direct' },
                    offsetY: { enabled: false, intensity: 0, mode: 'Direct' },
                    blur: { enabled: false, intensity: 0, mode: 'Direct' },
                    opacity: { enabled: false, intensity: 0, mode: 'Direct' }
                }
            },
            text: {
                fontFamily: 'Inter',
                customFontFamily: '',
                fontSize: 20,
                fontStyle: 'normal',
                color: '#cccccc',
                lineHeight: 1.2,
                alignment: 'center',
                positionX: 0.5,
                positionY: 0.85,
                scale: 1,
                rotation: 0,
                opacity: 1,
                strokeColor: '#ffffff',
                strokeThickness: 0,
                bgColor: '#000000',
                bgOpacity: 0,
                bgRoundedRect: 0,
                bgHeight: 1,
                bgWidth: 1,
                bgOffsetX: 0,
                bgOffsetY: 0,
                shadowColor: '#000000',
                shadowOpacity: 0,
                shadowBlur: 0,
                shadowDistance: 0,
                shadowAngle: 45,
                animations: {
                    scale: { enabled: true, intensity: 1, mode: 'Direct' }, // Increased default to 1
                    rotation: { enabled: false, intensity: 0, mode: 'Direct' },
                    offsetX: { enabled: false, intensity: 0, mode: 'Direct' },
                    offsetY: { enabled: false, intensity: 0, mode: 'Direct' },
                    blur: { enabled: false, intensity: 0, mode: 'Direct' },
                    opacity: { enabled: false, intensity: 0, mode: 'Direct' }
                }
            },
            visualizer: {
                enabled: true,
                positionX: 0.5,
                positionY: 0.7,
                width: 0.6,
                height: 50,
                scale: 1,
                rotation: 0,
                opacity: 1,
                color: '#63b3ed',
                strokeColor: '#63b3ed',
                strokeThickness: 2,
                alignment: 'center',
                shadowColor: '#000000',
                shadowOpacity: 0,
                shadowBlur: 0,
                shadowDistance: 0,
                shadowAngle: 45,
                animations: {
                    scale: { enabled: true, intensity: 0.8, mode: 'Direct' }, // Increased default
                    rotation: { enabled: false, intensity: 0, mode: 'Direct' },
                    offsetX: { enabled: false, intensity: 0, mode: 'Direct' },
                    offsetY: { enabled: true, intensity: 40, mode: 'Direct' }, // Increased default
                    blur: { enabled: false, intensity: 0, mode: 'Direct' },
                    opacity: { enabled: true, intensity: 0.8, mode: 'Direct' } // Increased default
                }
            },
            global: {
                volume: 1 // Global volume setting
            }
        };

        // Helper to update settings from UI
        function setupSettingListener(elementId, settingPath, type = 'number') {
            const element = document.getElementById(elementId);
            if (element) {
                element.addEventListener('input', () => {
                    let value;
                    if (type === 'number' || type === 'range') {
                        value = parseFloat(element.value);
                    } else if (type === 'color' || type === 'text' || type === 'select' || type === 'textarea') { // Added textarea
                        value = element.value;
                    } else if (type === 'checkbox') {
                        value = element.checked;
                    }
                   
                    const pathParts = settingPath.split('.');
                    let currentSetting = settings;
                    for (let i = 0; i < pathParts.length - 1; i++) {
                        currentSetting = currentSetting[pathParts[i]];
                    }
                    currentSetting[pathParts[pathParts.length - 1]] = value;

                    // Specific update for volume
                    if (settingPath === 'global.volume' && gainNode) {
                        gainNode.gain.value = value;
                    }

                    drawCanvas(audioBuffer ? getNormalizedAudioValue() : 0); // Redraw on setting change
                });
            }
        }

        /**
         * Dynamically loads a custom font from a URL (data URL or external URL).
         * @param {string} fontName - The CSS font-family name to use.
         * @param {string} fontUrl - The URL of the font file (data URL or external URL).
         * @param {string} format - The format of the font (e.g., 'truetype', 'opentype', 'woff', 'woff2').
         */
        function loadCustomFont(fontName, fontUrl, format) {
            const style = document.createElement('style');
            style.innerHTML = `
                @font-face {
                    font-family: '${fontName}';
                    src: url('${fontUrl}') format('${format}');
                    font-display: swap;
                }
            `;
            document.head.appendChild(style);
        }

        /**
         * Dynamically loads a font stylesheet from a URL.
         * @param {string} url - The URL of the CSS stylesheet.
         */
        function loadFontStylesheet(url) {
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = url;
            document.head.appendChild(link);
        }

        // --- Setup all styling listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            // General Controls
            setupSettingListener('globalVolume', 'global.volume', 'range');

            // Main Image
            setupSettingListener('mainImagePosX', 'mainImage.positionX');
            setupSettingListener('mainImagePosY', 'mainImage.positionY');
            setupSettingListener('mainImageScale', 'mainImage.scale', 'range');
            setupSettingListener('mainImageRotation', 'mainImage.rotation');
            setupSettingListener('mainImageOpacity', 'mainImage.opacity', 'range');
            setupSettingListener('mainImageStrokeColor', 'mainImage.strokeColor', 'color');
            setupSettingListener('mainImageStrokeThickness', 'mainImage.strokeThickness');
            setupSettingListener('mainImageShadowColor', 'mainImage.shadowColor', 'color');
            setupSettingListener('mainImageShadowOpacity', 'mainImage.shadowOpacity', 'range');
            setupSettingListener('mainImageShadowBlur', 'mainImage.shadowBlur');
            setupSettingListener('mainImageShadowDistance', 'mainImage.shadowDistance');
            setupSettingListener('mainImageShadowAngle', 'mainImage.shadowAngle');
            setupSettingListener('mainImageAnimScaleEnabled', 'mainImage.animations.scale.enabled', 'checkbox');
            setupSettingListener('mainImageAnimScaleIntensity', 'mainImage.animations.scale.intensity', 'range');
            setupSettingListener('mainImageAnimScaleMode', 'mainImage.animations.scale.mode', 'select');
            setupSettingListener('mainImageAnimRotationEnabled', 'mainImage.animations.rotation.enabled', 'checkbox');
            setupSettingListener('mainImageAnimRotationIntensity', 'mainImage.animations.rotation.intensity');
            setupSettingListener('mainImageAnimRotationMode', 'mainImage.animations.rotation.mode', 'select');
            setupSettingListener('mainImageAnimOffsetXEnabled', 'mainImage.animations.offsetX.enabled', 'checkbox');
            setupSettingListener('mainImageAnimOffsetXIntensity', 'mainImage.animations.offsetX.intensity');
            setupSettingListener('mainImageAnimOffsetXMode', 'mainImage.animations.offsetX.mode', 'select');
            setupSettingListener('mainImageAnimOffsetYEnabled', 'mainImage.animations.offsetY.enabled', 'checkbox');
            setupSettingListener('mainImageAnimOffsetYIntensity', 'mainImage.animations.offsetY.intensity');
            setupSettingListener('mainImageAnimOffsetYMode', 'mainImage.animations.offsetY.mode', 'select');
            setupSettingListener('mainImageAnimBlurEnabled', 'mainImage.animations.blur.enabled', 'checkbox');
            setupSettingListener('mainImageAnimBlurIntensity', 'mainImage.animations.blur.intensity');
            setupSettingListener('mainImageAnimBlurMode', 'mainImage.animations.blur.mode', 'select');
            setupSettingListener('mainImageAnimOpacityEnabled', 'mainImage.animations.opacity.enabled', 'checkbox');
            setupSettingListener('mainImageAnimOpacityIntensity', 'mainImage.animations.opacity.intensity', 'range');
            setupSettingListener('mainImageAnimOpacityMode', 'mainImage.animations.opacity.mode', 'select');

            // Moving Image
            setupSettingListener('movingImagePosX', 'movingImage.positionX');
            setupSettingListener('movingImagePosY', 'movingImage.positionY');
            setupSettingListener('movingImageScale', 'movingImage.scale', 'range');
            setupSettingListener('movingImageRotation', 'movingImage.rotation');
            setupSettingListener('movingImageOpacity', 'movingImage.opacity', 'range');
            setupSettingListener('movingImageStrokeColor', 'movingImage.strokeColor', 'color');
            setupSettingListener('movingImageStrokeThickness', 'movingImage.strokeThickness');
            setupSettingListener('movingImageShadowColor', 'movingImage.shadowColor', 'color');
            setupSettingListener('movingImageShadowOpacity', 'movingImage.shadowOpacity', 'range');
            setupSettingListener('movingImageShadowBlur', 'movingImage.shadowBlur');
            setupSettingListener('movingImageShadowDistance', 'movingImage.shadowDistance');
            setupSettingListener('movingImageShadowAngle', 'movingImage.shadowAngle');
            setupSettingListener('movingImageAnimScaleEnabled', 'movingImage.animations.scale.enabled', 'checkbox');
            setupSettingListener('movingImageAnimScaleIntensity', 'movingImage.animations.scale.intensity', 'range');
            setupSettingListener('movingImageAnimScaleMode', 'movingImage.animations.scale.mode', 'select');
            setupSettingListener('movingImageAnimRotationEnabled', 'movingImage.animations.rotation.enabled', 'checkbox');
            setupSettingListener('movingImageAnimRotationIntensity', 'movingImage.animations.rotation.intensity');
            setupSettingListener('movingImageAnimRotationMode', 'movingImage.animations.rotation.mode', 'select');
            setupSettingListener('movingImageAnimOffsetXEnabled', 'movingImage.animations.offsetX.enabled', 'checkbox');
            setupSettingListener('movingImageAnimOffsetXIntensity', 'movingImage.animations.offsetX.intensity');
            setupSettingListener('movingImageAnimOffsetXMode', 'movingImage.animations.offsetX.mode', 'select');
            setupSettingListener('movingImageAnimOffsetYEnabled', 'movingImage.animations.offsetY.enabled', 'checkbox');
            setupSettingListener('movingImageAnimOffsetYIntensity', 'movingImage.animations.offsetY.intensity');
            setupSettingListener('movingImageAnimOffsetYMode', 'movingImage.animations.offsetY.mode', 'select');
            setupSettingListener('movingImageAnimBlurEnabled', 'movingImage.animations.blur.enabled', 'checkbox');
            setupSettingListener('movingImageAnimBlurIntensity', 'movingImage.animations.blur.intensity');
            setupSettingListener('movingImageAnimBlurMode', 'movingImage.animations.blur.mode', 'select');
            setupSettingListener('movingImageAnimOpacityEnabled', 'movingImage.animations.opacity.enabled', 'checkbox');
            setupSettingListener('movingImageAnimOpacityIntensity', 'movingImage.animations.opacity.intensity', 'range');
            setupSettingListener('movingImageAnimOpacityMode', 'movingImage.animations.opacity.mode', 'select');

            // Logo
            setupSettingListener('logoPosX', 'logo.positionX');
            setupSettingListener('logoPosY', 'logo.positionY');
            setupSettingListener('logoScale', 'logo.scale', 'range');
            setupSettingListener('logoRotation', 'logo.rotation');
            setupSettingListener('logoOpacity', 'logo.opacity', 'range');
            setupSettingListener('logoStrokeColor', 'logo.strokeColor', 'color');
            setupSettingListener('logoStrokeThickness', 'logo.strokeThickness');
            setupSettingListener('logoShadowColor', 'logo.shadowColor', 'color');
            setupSettingListener('logoShadowOpacity', 'logo.shadowOpacity', 'range');
            setupSettingListener('logoShadowBlur', 'logo.shadowBlur');
            setupSettingListener('logoShadowDistance', 'logo.shadowDistance');
            setupSettingListener('logoShadowAngle', 'logo.shadowAngle');
            setupSettingListener('logoAnimScaleEnabled', 'logo.animations.scale.enabled', 'checkbox');
            setupSettingListener('logoAnimScaleIntensity', 'logo.animations.scale.intensity', 'range');
            setupSettingListener('logoAnimScaleMode', 'logo.animations.scale.mode', 'select');
            setupSettingListener('logoAnimRotationEnabled', 'logo.animations.rotation.enabled', 'checkbox');
            setupSettingListener('logoAnimRotationIntensity', 'logo.animations.rotation.intensity');
            setupSettingListener('logoAnimRotationMode', 'logo.animations.rotation.mode', 'select');
            setupSettingListener('logoAnimOffsetXEnabled', 'logo.animations.offsetX.enabled', 'checkbox');
            setupSettingListener('logoAnimOffsetXIntensity', 'logo.animations.offsetX.intensity');
            setupSettingListener('logoAnimOffsetXMode', 'logo.animations.offsetX.mode', 'select');
            setupSettingListener('logoAnimOffsetYEnabled', 'logo.animations.offsetY.enabled', 'checkbox');
            setupSettingListener('logoAnimOffsetYIntensity', 'logo.animations.offsetY.intensity');
            setupSettingListener('logoAnimOffsetYMode', 'logo.animations.offsetY.mode', 'select');
            setupSettingListener('logoAnimBlurEnabled', 'logo.animations.blur.enabled', 'checkbox');
            setupSettingListener('logoAnimBlurIntensity', 'logo.animations.blur.intensity');
            setupSettingListener('logoAnimBlurMode', 'logo.animations.blur.mode', 'select');
            setupSettingListener('logoAnimOpacityEnabled', 'logo.animations.opacity.enabled', 'checkbox');
            setupSettingListener('logoAnimOpacityIntensity', 'logo.animations.opacity.intensity', 'range');
            setupSettingListener('logoAnimOpacityMode', 'logo.animations.opacity.mode', 'select');

            // Title
            const titleFontFamilySelect = document.getElementById('titleFontFamilySelect');
            const titleFontUpload = document.getElementById('titleFontUpload');
            const titleFontUrl = document.getElementById('titleFontUrl');
            const titleCustomFontName = document.getElementById('titleCustomFontName');
            const titleTargetSettings = settings.title;

            titleFontFamilySelect.addEventListener('change', () => {
                titleFontUpload.classList.add('hidden');
                titleFontUrl.classList.add('hidden');
                titleCustomFontName.classList.add('hidden');
                titleTargetSettings.customFontFamily = ''; // Clear custom font name

                if (titleFontFamilySelect.value === 'custom-upload') {
                    titleFontUpload.classList.remove('hidden');
                    titleTargetSettings.fontFamily = 'custom-title-uploaded-font'; // Placeholder name, will be replaced on file load
                } else if (titleFontFamilySelect.value === 'custom-url') {
                    titleFontUrl.classList.remove('hidden');
                    titleCustomFontName.classList.remove('hidden');
                    titleTargetSettings.fontFamily = titleCustomFontName.value || 'custom-title-url-font'; // Use user-defined name or placeholder
                } else {
                    titleTargetSettings.fontFamily = titleFontFamilySelect.value;
                }
                drawCanvas(audioBuffer ? getNormalizedAudioValue() : 0);
            });

            titleFontUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const fontName = `custom-title-uploaded-font-${Date.now()}`; // Unique name
                        let format = 'truetype'; // Default
                        if (file.name.endsWith('.otf')) format = 'opentype';
                        else if (file.name.endsWith('.woff')) format = 'woff';
                        else if (file.name.endsWith('.woff2')) format = 'woff2';

                        loadCustomFont(fontName, event.target.result, format);
                        titleTargetSettings.fontFamily = fontName;
                        showMessage('ពុម្ពអក្សរផ្ទាល់ខ្លួនបានផ្ទុកឡើងដោយជោគជ័យ។', 'success');
                        drawCanvas(audioBuffer ? getNormalizedAudioValue() : 0);
                    };
                    reader.readAsDataURL(file);
                }
            });

            titleFontUrl.addEventListener('input', () => {
                if (titleFontUrl.value) {
                    loadFontStylesheet(titleFontUrl.value);
                    titleTargetSettings.fontFamily = titleCustomFontName.value || 'custom-title-url-font';
                    showMessage('URL ពុម្ពអក្សរបានផ្ទុក។ ត្រូវប្រាកដថាឈ្មោះពុម្ពអក្សរត្រឹមត្រូវ។', 'info');
                }
                drawCanvas(audioBuffer ? getNormalizedAudioValue() : 0);
            });

            titleCustomFontName.addEventListener('input', () => {
                titleTargetSettings.fontFamily = titleCustomFontName.value || 'custom-title-url-font';
                drawCanvas(audioBuffer ? getNormalizedAudioValue() : 0);
            });

            setupSettingListener('titleFontSize', 'title.fontSize');
            setupSettingListener('titleFontStyle', 'title.fontStyle', 'select');
            setupSettingListener('titleColor', 'title.color', 'color');
            setupSettingListener('titleLineHeight', 'title.lineHeight', 'range');
            setupSettingListener('titleAlignment', 'title.alignment', 'select');
            setupSettingListener('titlePosX', 'title.positionX', 'range');
            setupSettingListener('titlePosY', 'title.positionY', 'range');
            setupSettingListener('titleScale', 'title.scale', 'range');
            setupSettingListener('titleRotation', 'title.rotation');
            setupSettingListener('titleOpacity', 'title.opacity', 'range');
            setupSettingListener('titleStrokeColor', 'title.strokeColor', 'color');
            setupSettingListener('titleStrokeThickness', 'title.strokeThickness');
            setupSettingListener('titleBgColor', 'title.bgColor', 'color');
            setupSettingListener('titleBgOpacity', 'title.bgOpacity', 'range');
            setupSettingListener('titleBgRoundedRect', 'title.bgRoundedRect');
            setupSettingListener('titleBgHeight', 'title.bgHeight', 'range');
            setupSettingListener('titleBgWidth', 'title.bgWidth', 'range');
            setupSettingListener('titleBgOffsetX', 'title.bgOffsetX');
            setupSettingListener('titleBgOffsetY', 'title.bgOffsetY');
            setupSettingListener('titleShadowColor', 'title.shadowColor', 'color');
            setupSettingListener('titleShadowOpacity', 'title.shadowOpacity', 'range');
            setupSettingListener('titleShadowBlur', 'title.shadowBlur');
            setupSettingListener('titleShadowDistance', 'title.shadowDistance');
            setupSettingListener('titleShadowAngle', 'title.shadowAngle');
            setupSettingListener('titleAnimScaleEnabled', 'title.animations.scale.enabled', 'checkbox');
            setupSettingListener('titleAnimScaleIntensity', 'title.animations.scale.intensity', 'range');
            setupSettingListener('titleAnimScaleMode', 'title.animations.scale.mode', 'select');
            setupSettingListener('titleAnimRotationEnabled', 'title.animations.rotation.enabled', 'checkbox');
            setupSettingListener('titleAnimRotationIntensity', 'title.animations.rotation.intensity');
            setupSettingListener('titleAnimRotationMode', 'title.animations.rotation.mode', 'select');
            setupSettingListener('titleAnimOffsetXEnabled', 'title.animations.offsetX.enabled', 'checkbox');
            setupSettingListener('titleAnimOffsetXIntensity', 'title.animations.offsetX.intensity');
            setupSettingListener('titleAnimOffsetXMode', 'title.animations.offsetX.mode', 'select');
            setupSettingListener('titleAnimOffsetYEnabled', 'title.animations.offsetY.enabled', 'checkbox');
            setupSettingListener('titleAnimOffsetYIntensity', 'title.animations.offsetY.intensity');
            setupSettingListener('titleAnimOffsetYMode', 'title.animations.offsetY.mode', 'select');
            setupSettingListener('titleAnimBlurEnabled', 'title.animations.blur.enabled', 'checkbox');
            setupSettingListener('titleAnimBlurIntensity', 'title.animations.blur.intensity');
            setupSettingListener('titleAnimBlurMode', 'title.animations.blur.mode', 'select');
            setupSettingListener('titleAnimOpacityEnabled', 'title.animations.opacity.enabled', 'checkbox');
            setupSettingListener('titleAnimOpacityIntensity', 'title.animations.opacity.intensity', 'range');
            setupSettingListener('titleAnimOpacityMode', 'title.animations.opacity.mode', 'select');

            // Text
            const textFontFamilySelect = document.getElementById('textFontFamilySelect');
            const textFontUpload = document.getElementById('textFontUpload');
            const textFontUrl = document.getElementById('textFontUrl');
            const textCustomFontName = document.getElementById('textCustomFontName');
            const textTargetSettings = settings.text;

            textFontFamilySelect.addEventListener('change', () => {
                textFontUpload.classList.add('hidden');
                textFontUrl.classList.add('hidden');
                textCustomFontName.classList.add('hidden');
                textTargetSettings.customFontFamily = ''; // Clear custom font name

                if (textFontFamilySelect.value === 'custom-upload') {
                    textFontUpload.classList.remove('hidden');
                    textTargetSettings.fontFamily = 'custom-text-uploaded-font'; // Placeholder name, will be replaced on file load
                } else if (textFontFamilySelect.value === 'custom-url') {
                    textFontUrl.classList.remove('hidden');
                    textCustomFontName.classList.remove('hidden');
                    textTargetSettings.fontFamily = textCustomFontName.value || 'custom-text-url-font'; // Use user-defined name or placeholder
                } else {
                    textTargetSettings.fontFamily = textFontFamilySelect.value;
                }
                drawCanvas(audioBuffer ? getNormalizedAudioValue() : 0);
            });

            textFontUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const fontName = `custom-text-uploaded-font-${Date.now()}`; // Unique name
                        let format = 'truetype'; // Default
                        if (file.name.endsWith('.otf')) format = 'opentype';
                        else if (file.name.endsWith('.woff')) format = 'woff';
                        else if (file.name.endsWith('.woff2')) format = 'woff2';

                        loadCustomFont(fontName, event.target.result, format);
                        textTargetSettings.fontFamily = fontName;
                        showMessage('ពុម្ពអក្សរផ្ទាល់ខ្លួនបានផ្ទុកឡើងដោយជោគជ័យ។', 'success');
                        drawCanvas(audioBuffer ? getNormalizedAudioValue() : 0);
                    };
                    reader.readAsDataURL(file);
                }
            });

            textFontUrl.addEventListener('input', () => {
                if (textFontUrl.value) {
                    loadFontStylesheet(textFontUrl.value);
                    textTargetSettings.fontFamily = textCustomFontName.value || 'custom-text-url-font';
                    showMessage('URL ពុម្ពអក្សរបានផ្ទុក។ ត្រូវប្រាកដថាឈ្មោះពុម្ពអក្សរត្រឹមត្រូវ។', 'info');
                }
                drawCanvas(audioBuffer ? getNormalizedAudioValue() : 0);
            });

            textCustomFontName.addEventListener('input', () => {
                textTargetSettings.fontFamily = textCustomFontName.value || 'custom-text-url-font';
                drawCanvas(audioBuffer ? getNormalizedAudioValue() : 0);
            });

            setupSettingListener('textFontSize', 'text.fontSize');
            setupSettingListener('textFontStyle', 'text.fontStyle', 'select');
            setupSettingListener('textColor', 'text.color', 'color');
            setupSettingListener('textLineHeight', 'text.lineHeight', 'range');
            setupSettingListener('textAlign', 'text.alignment', 'select');
            setupSettingListener('textPosX', 'text.positionX', 'range');
            setupSettingListener('textPosY', 'text.positionY', 'range');
            setupSettingListener('textScale', 'text.scale', 'range');
            setupSettingListener('textRotation', 'text.rotation');
            setupSettingListener('textOpacity', 'text.opacity', 'range');
            setupSettingListener('textStrokeColor', 'text.strokeColor', 'color');
            setupSettingListener('textStrokeThickness', 'text.strokeThickness');
            setupSettingListener('textBgColor', 'text.bgColor', 'color');
            setupSettingListener('textBgOpacity', 'text.bgOpacity', 'range');
            setupSettingListener('textBgRoundedRect', 'text.bgRoundedRect');
            setupSettingListener('textBgHeight', 'text.bgHeight', 'range');
            setupSettingListener('textBgWidth', 'text.bgWidth', 'range');
            setupSettingListener('textBgOffsetX', 'text.bgOffsetX');
            setupSettingListener('textBgOffsetY', 'text.bgOffsetY');
            setupSettingListener('textShadowColor', 'text.shadowColor', 'color');
            setupSettingListener('textShadowOpacity', 'text.shadowOpacity', 'range');
            setupSettingListener('textShadowBlur', 'text.shadowBlur');
            setupSettingListener('textShadowDistance', 'text.shadowDistance');
            setupSettingListener('textShadowAngle', 'text.shadowAngle');
            setupSettingListener('textAnimScaleEnabled', 'text.animations.scale.enabled', 'checkbox');
            setupSettingListener('textAnimScaleIntensity', 'text.animations.scale.intensity', 'range');
            setupSettingListener('textAnimScaleMode', 'text.animations.scale.mode', 'select');
            setupSettingListener('textAnimRotationEnabled', 'text.animations.rotation.enabled', 'checkbox');
            setupSettingListener('textAnimRotationIntensity', 'text.animations.rotation.intensity');
            setupSettingListener('textAnimRotationMode', 'text.animations.rotation.mode', 'select');
            setupSettingListener('textAnimOffsetXEnabled', 'text.animations.offsetX.enabled', 'checkbox');
            setupSettingListener('textAnimOffsetXIntensity', 'text.animations.offsetX.intensity');
            setupSettingListener('textAnimOffsetXMode', 'text.animations.offsetX.mode', 'select');
            setupSettingListener('textAnimOffsetYEnabled', 'text.animations.offsetY.enabled', 'checkbox');
            setupSettingListener('textAnimOffsetYIntensity', 'text.animations.offsetY.intensity');
            setupSettingListener('textAnimOffsetYMode', 'text.animations.offsetY.mode', 'select');
            setupSettingListener('textAnimBlurEnabled', 'text.animations.blur.enabled', 'checkbox');
            setupSettingListener('textAnimBlurIntensity', 'text.animations.blur.intensity');
            setupSettingListener('textAnimBlurMode', 'text.animations.blur.mode', 'select');
            setupSettingListener('textAnimOpacityEnabled', 'text.animations.opacity.enabled', 'checkbox');
            setupSettingListener('textAnimOpacityIntensity', 'text.animations.opacity.intensity', 'range');
            setupSettingListener('textAnimOpacityMode', 'text.animations.opacity.mode', 'select');

            // Visualizer
            setupSettingListener('visualizerEnabled', 'visualizer.enabled', 'checkbox');
            setupSettingListener('visualizerPosX', 'visualizer.positionX', 'range');
            setupSettingListener('visualizerPosY', 'visualizer.positionY', 'range');
            setupSettingListener('visualizerWidth', 'visualizer.width', 'range');
            setupSettingListener('visualizerHeight', 'visualizer.height');
            setupSettingListener('visualizerScale', 'visualizer.scale', 'range');
            setupSettingListener('visualizerRotation', 'visualizer.rotation');
            setupSettingListener('visualizerOpacity', 'visualizer.opacity', 'range');
            setupSettingListener('visualizerColor', 'visualizer.color', 'color');
            setupSettingListener('visualizerStrokeColor', 'visualizer.strokeColor', 'color');
            setupSettingListener('visualizerStrokeThickness', 'visualizer.strokeThickness');
            setupSettingListener('visualizerAlignment', 'visualizer.alignment', 'select');
            setupSettingListener('visualizerShadowColor', 'visualizer.shadowColor', 'color');
            setupSettingListener('visualizerShadowOpacity', 'visualizer.shadowOpacity', 'range');
            setupSettingListener('visualizerShadowBlur', 'visualizer.shadowBlur');
            setupSettingListener('visualizerShadowDistance', 'visualizer.shadowDistance');
            setupSettingListener('visualizerShadowAngle', 'visualizer.shadowAngle');
            setupSettingListener('visualizerAnimScaleEnabled', 'visualizer.animations.scale.enabled', 'checkbox');
            setupSettingListener('visualizerAnimScaleIntensity', 'visualizer.animations.scale.intensity', 'range');
            setupSettingListener('visualizerAnimScaleMode', 'visualizer.animations.scale.mode', 'select');
            setupSettingListener('visualizerAnimRotationEnabled', 'visualizer.animations.rotation.enabled', 'checkbox');
            setupSettingListener('visualizerAnimRotationIntensity', 'visualizer.animations.rotation.intensity');
            setupSettingListener('visualizerAnimRotationMode', 'visualizer.animations.rotation.mode', 'select');
            setupSettingListener('visualizerAnimOffsetXEnabled', 'visualizer.animations.offsetX.enabled', 'checkbox');
            setupSettingListener('visualizerAnimOffsetXIntensity', 'visualizer.animations.offsetX.intensity');
            setupSettingListener('visualizerAnimOffsetXMode', 'visualizer.animations.offsetX.mode', 'select');
            setupSettingListener('visualizerAnimOffsetYEnabled', 'visualizer.animations.offsetY.enabled', 'checkbox');
            setupSettingListener('visualizerAnimOffsetYIntensity', 'visualizer.animations.offsetY.intensity');
            setupSettingListener('visualizerAnimOffsetYMode', 'visualizer.animations.offsetY.mode', 'select');
            setupSettingListener('visualizerAnimBlurEnabled', 'visualizer.animations.blur.enabled', 'checkbox');
            setupSettingListener('visualizerAnimBlurIntensity', 'visualizer.animations.blur.intensity');
            setupSettingListener('visualizerAnimBlurMode', 'visualizer.animations.blur.mode', 'select');
            setupSettingListener('visualizerAnimOpacityEnabled', 'visualizer.animations.opacity.enabled', 'checkbox');
            setupSettingListener('visualizerAnimOpacityIntensity', 'visualizer.animations.opacity.intensity', 'range');
            setupSettingListener('visualizerAnimOpacityMode', 'visualizer.animations.opacity.mode', 'select');
        });


        // --- Utility Functions ---

        /**
         * Displays a message in the message box.
         * @param {string} message - The message to display.
         * @param {string} type - 'success', 'error', 'info'.
         */
        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.style.display = 'block';
            messageBox.className = 'message-box w-full lg:w-3/4 xl:w-2/3'; // Reset classes
            if (type === 'error') {
                messageBox.classList.add('border-red-500', 'bg-red-900');
            } else if (type === 'success') {
                messageBox.classList.add('border-green-500', 'bg-green-900');
            } else {
                messageBox.classList.add('border-blue-500', 'bg-blue-900');
            }
        }

        /**
         * Hides the message box.
         */
        function hideMessageBox() {
            messageBox.style.display = 'none';
        }

        /**
         * Sets the canvas dimensions based on the selected video format.
         */
        function setCanvasDimensions() {
            const format = videoFormatSelect.value;
            const maxWidth = canvas.parentElement.clientWidth; // Get parent width
            let width, height;

            if (format === '16:9') {
                width = maxWidth;
                height = maxWidth / (16 / 9);
            } else if (format === '9:16') {
                width = maxWidth * (9 / 16);
                height = maxWidth; // Max height for reels/shorts
                if (height > window.innerHeight * 0.7) { // Limit height to avoid overflow
                    height = window.innerHeight * 0.7;
                    width = height * (9 / 16);
                }
            } else { // 1:1
                width = maxWidth;
                height = maxWidth;
            }

            // Ensure dimensions are integers
            canvas.width = Math.floor(width);
            canvas.height = Math.floor(height);
        }

        /**
         * Calculates the normalized audio value (0-1).
         */
        function getNormalizedAudioValue() {
            if (!analyser || !dataArray) return 0;
            analyser.getByteFrequencyData(dataArray);
            let sum = 0;
            for (let i = 0; i < bufferLength; i++) {
                sum += dataArray[i];
            }
            const average = sum / bufferLength;
            return average / 255; // Normalize to 0-1
        }

        // --- Event Listeners for File Inputs ---

        audioFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        // Close existing audio context if any
                        if (audioContext) {
                            audioContext.close();
                        }
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        // Create gain node for volume control
                        gainNode = audioContext.createGain();
                        gainNode.gain.value = settings.global.volume; // Set initial volume
                        gainNode.connect(audioContext.destination);

                        audioBuffer = await audioContext.decodeAudioData(e.target.result);
                        showMessage('បទចម្រៀងបានផ្ទុកឡើងដោយជោគជ័យ។', 'success');
                        // Reset play/pause state when new audio is loaded
                        isPlaying = false;
                        playPauseButton.textContent = 'លេង';
                        drawCanvas(0); // Draw static canvas until played
                    } catch (error) {
                        showMessage('បរាជ័យក្នុងការផ្ទុកបទចម្រៀង: ' + error.message, 'error');
                        console.error('Error decoding audio:', error);
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        });

        imageFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    mainImage.src = e.target.result;
                    mainImage.onload = () => {
                        mainImageLoaded = true;
                        showMessage('រូបភាពផ្ទៃខាងក្រោយបានផ្ទុកឡើងដោយជោគជ័យ។', 'success');
                        drawCanvas(audioBuffer ? getNormalizedAudioValue() : 0); // Redraw with new image
                    };
                    mainImage.onerror = () => {
                        mainImageLoaded = false;
                        showMessage('បរាជ័យក្នុងការផ្ទុករូបភាពផ្ទៃខាងក្រោយ។', 'error');
                    };
                };
                reader.readAsDataURL(file);
            }
        });

        movingImageFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    movingImage.src = e.target.result;
                    movingImage.onload = () => {
                        movingImageLoaded = true;
                        showMessage('រូបភាពធ្វើចលនាបានផ្ទុកឡើងដោយជោគជ័យ។', 'success');
                        drawCanvas(audioBuffer ? getNormalizedAudioValue() : 0); // Redraw with new image
                    };
                    movingImage.onerror = () => {
                        movingImageLoaded = false;
                        showMessage('បរាជ័យក្នុងការផ្ទុករូបភាពធ្វើចលនា។', 'error');
                    };
                };
                reader.readAsDataURL(file);
            }
        });

        logoFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    logoImage.src = e.target.result;
                    logoImage.onload = () => {
                        logoImageLoaded = true;
                        showMessage('ឡូហ្គោបានផ្ទុកឡើងដោយជោគជ័យ។', 'success');
                        drawCanvas(audioBuffer ? getNormalizedAudioValue() : 0); // Redraw with new logo
                    };
                    logoImage.onerror = () => {
                        logoImageLoaded = false;
                        showMessage('បរាជ័យក្នុងការផ្ទុកឡូហ្គោ។', 'error');
                    };
                };
                reader.readAsDataURL(file);
            }
        });

        videoFormatSelect.addEventListener('change', setCanvasDimensions);
        window.addEventListener('resize', setCanvasDimensions); // Adjust canvas on window resize

        // --- Audio Visualization and Canvas Drawing ---

        /**
         * Draws a rounded rectangle path.
         * @param {CanvasRenderingContext2D} ctx - The canvas rendering context.
         * @param {number} x - The x-coordinate of the upper-left corner of the rectangle.
         * @param {number} y - The y-coordinate of the upper-left corner of the rectangle.
         * @param {number} width - The width of the rectangle.
         * @param {number} height - The height of the rectangle.
         * @param {number} radius - The corner radius.
         */
        function roundRect(ctx, x, y, width, height, radius) {
            if (width < 2 * radius) radius = width / 2;
            if (height < 2 * radius) radius = height / 2;
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.arcTo(x + width, y, x + width, y + height, radius);
            ctx.arcTo(x + width, y + height, x, y + height, radius);
            ctx.arcTo(x, y + height, x, y, radius);
            ctx.arcTo(x, y, x + width, y, radius);
            ctx.closePath();
        }

        /**
         * Applies shadow properties to the context.
         * @param {CanvasRenderingContext2D} ctx - The canvas rendering context.
         * @param {object} shadowSettings - Object containing shadow properties.
         */
        function applyShadow(ctx, shadowSettings) {
            if (shadowSettings.shadowOpacity > 0 && (shadowSettings.shadowBlur > 0 || shadowSettings.shadowDistance > 0)) {
                ctx.shadowColor = `rgba(${parseInt(shadowSettings.shadowColor.slice(1, 3), 16)}, ${parseInt(shadowSettings.shadowColor.slice(3, 5), 16)}, ${parseInt(shadowSettings.shadowColor.slice(5, 7), 16)}, ${shadowSettings.shadowOpacity})`;
                ctx.shadowBlur = shadowSettings.shadowBlur;
                const angleRad = shadowSettings.shadowAngle * Math.PI / 180;
                ctx.shadowOffsetX = Math.cos(angleRad) * shadowSettings.shadowDistance;
                ctx.shadowOffsetY = Math.sin(angleRad) * shadowSettings.shadowDistance;
            } else {
                ctx.shadowColor = 'rgba(0,0,0,0)';
                ctx.shadowBlur = 0;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 0;
            }
        }

        /**
         * Calculates animated value based on mode.
         * @param {number} baseValue - The base value.
         * @param {number} audioValue - Normalized audio value (0-1).
         * @param {object} animSettings - Animation settings for a specific property (e.g., scale, rotation).
         * @param {boolean} isAngle - True if the value is an angle (for rotation).
         */
        function getAnimatedValue(baseValue, audioValue, animSettings, isAngle = false) {
            if (!animSettings.enabled || animSettings.intensity === 0) {
                return baseValue;
            }

            let animatedValue = 0;
            switch (animSettings.mode) {
                case 'Direct':
                    animatedValue = baseValue + audioValue * animSettings.intensity;
                    break;
                case 'Oscillate':
                    // Use sin wave for oscillation. Scale audioValue to a larger range for more cycles.
                    // For angles, ensure it oscillates around the base angle.
                    animatedValue = baseValue + Math.sin(audioValue * Math.PI * 2) * animSettings.intensity;
                    break;
                case 'Bounce': // Primarily for Y-offset, makes it only move in one direction (e.g., up)
                    // The bounce effect should always be positive (upwards) from the base position
                    animatedValue = baseValue - Math.abs(Math.sin(audioValue * Math.PI)) * animSettings.intensity;
                    break;
                default:
                    animatedValue = baseValue;
            }
            return animatedValue;
        }

        /**
         * Draws all elements on the canvas.
         * @param {number} audioValue - A value derived from audio frequency data to drive animation.
         */
        function drawCanvas(audioValue = 0) {
            ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear canvas

            // Draw background or main image
            ctx.save();
            applyShadow(ctx, settings.mainImage);

            let currentScaleBg = settings.mainImage.scale;
            let currentRotationBg = settings.mainImage.rotation;
            let currentOffsetXBg = settings.mainImage.positionX;
            let currentOffsetYBg = settings.mainImage.positionY;
            let currentBlurBg = 0;
            let currentOpacityBg = settings.mainImage.opacity;

            currentScaleBg = getAnimatedValue(currentScaleBg, audioValue, settings.mainImage.animations.scale);
            currentRotationBg = getAnimatedValue(currentRotationBg, audioValue, settings.mainImage.animations.rotation, true);
            currentOffsetXBg = getAnimatedValue(currentOffsetXBg, audioValue, settings.mainImage.animations.offsetX);
            currentOffsetYBg = getAnimatedValue(currentOffsetYBg, audioValue, settings.mainImage.animations.offsetY);
            currentBlurBg = getAnimatedValue(currentBlurBg, audioValue, settings.mainImage.animations.blur);
            currentOpacityBg = getAnimatedValue(currentOpacityBg, audioValue, settings.mainImage.animations.opacity);
            currentOpacityBg = Math.max(0, Math.min(settings.mainImage.opacity, currentOpacityBg)); // Clamp opacity within its base value

            ctx.globalAlpha = currentOpacityBg;
            ctx.filter = `blur(${currentBlurBg}px)`;

            ctx.translate(canvas.width / 2 + currentOffsetXBg, canvas.height / 2 + currentOffsetYBg);
            ctx.rotate(currentRotationBg * Math.PI / 180);
            ctx.scale(currentScaleBg, currentScaleBg);

            if (mainImageLoaded) {
                ctx.drawImage(mainImage, -canvas.width / 2, -canvas.height / 2, canvas.width, canvas.height);
            } else {
                ctx.fillStyle = '#333'; // Default background color
                ctx.fillRect(-canvas.width / 2, -canvas.height / 2, canvas.width, canvas.height);
            }

            if (settings.mainImage.strokeThickness > 0) {
                ctx.strokeStyle = settings.mainImage.strokeColor;
                ctx.lineWidth = settings.mainImage.strokeThickness;
                ctx.strokeRect(-canvas.width / 2, -canvas.height / 2, canvas.width, canvas.height);
            }
            ctx.restore();

            // Draw Moving Image
            if (movingImageLoaded) {
                const movingImageSettings = settings.movingImage;
                ctx.save();
                applyShadow(ctx, movingImageSettings);

                let currentScaleMoving = movingImageSettings.scale;
                let currentRotationMoving = movingImageSettings.rotation;
                let currentOffsetXMoving = movingImageSettings.positionX;
                let currentOffsetYMoving = movingImageSettings.positionY;
                let currentBlurMoving = 0;
                let currentOpacityMoving = movingImageSettings.opacity;

                currentScaleMoving = getAnimatedValue(currentScaleMoving, audioValue, movingImageSettings.animations.scale);
                currentRotationMoving = getAnimatedValue(currentRotationMoving, audioValue, movingImageSettings.animations.rotation, true);
                currentOffsetXMoving = getAnimatedValue(currentOffsetXMoving, audioValue, movingImageSettings.animations.offsetX);
                currentOffsetYMoving = getAnimatedValue(currentOffsetYMoving, audioValue, movingImageSettings.animations.offsetY);
                currentBlurMoving = getAnimatedValue(currentBlurMoving, audioValue, movingImageSettings.animations.blur);
                currentOpacityMoving = getAnimatedValue(currentOpacityMoving, audioValue, movingImageSettings.animations.opacity);
                currentOpacityMoving = Math.max(0, Math.min(movingImageSettings.opacity, currentOpacityMoving));

                ctx.globalAlpha = currentOpacityMoving;
                ctx.filter = `blur(${currentBlurMoving}px)`;

                const imgWidth = movingImage.width * currentScaleMoving;
                const imgHeight = movingImage.height * currentScaleMoving;

                let imgX = (canvas.width / 2) + currentOffsetXMoving;
                let imgY = (canvas.height / 2) + currentOffsetYMoving;

                ctx.translate(imgX, imgY);
                ctx.rotate(currentRotationMoving * Math.PI / 180);
               
                ctx.drawImage(movingImage, -imgWidth / 2, -imgHeight / 2, imgWidth, imgHeight);

                if (movingImageSettings.strokeThickness > 0) {
                    ctx.strokeStyle = movingImageSettings.strokeColor;
                    ctx.lineWidth = movingImageSettings.strokeThickness;
                    ctx.strokeRect(-imgWidth / 2, -imgHeight / 2, imgWidth, imgHeight);
                }
                ctx.restore();
            }


            // Draw title
            const title = videoTitleInput.value;
            if (title) {
                const titleSettings = settings.title;
                ctx.save();
                applyShadow(ctx, titleSettings);

                let currentFontSizeTitle = titleSettings.fontSize;
                let currentScaleTitle = titleSettings.scale; // Base scale for the element
                let currentRotationTitle = titleSettings.rotation;
                let currentOffsetXTitle = 0;
                let currentOffsetYTitle = 0;
                let currentBlurTitle = 0;
                let currentOpacityTitle = titleSettings.opacity;

                // Apply scale animation to the overall element scale, not just font size
                currentScaleTitle = getAnimatedValue(currentScaleTitle, audioValue, titleSettings.animations.scale);
                currentRotationTitle = getAnimatedValue(currentRotationTitle, audioValue, titleSettings.animations.rotation, true);
                currentOffsetXTitle = getAnimatedValue(currentOffsetXTitle, audioValue, titleSettings.animations.offsetX);
                currentOffsetYTitle = getAnimatedValue(currentOffsetYTitle, audioValue, titleSettings.animations.offsetY);
                currentBlurTitle = getAnimatedValue(currentBlurTitle, audioValue, titleSettings.animations.blur);
                currentOpacityTitle = getAnimatedValue(currentOpacityTitle, audioValue, titleSettings.animations.opacity);
                currentOpacityTitle = Math.max(0, Math.min(titleSettings.opacity, currentOpacityTitle));

                ctx.globalAlpha = currentOpacityTitle;
                ctx.filter = `blur(${currentBlurTitle}px)`;

                const fontToUse = titleSettings.fontFamily.startsWith('custom-title-uploaded-font') || titleSettings.fontFamily.startsWith('custom-title-url-font') ? titleSettings.fontFamily : `'${titleSettings.fontFamily}'`;
                // Font size remains fixed, scaling is done via ctx.scale
                ctx.font = `${titleSettings.fontStyle} ${currentFontSizeTitle}px ${fontToUse}, sans-serif`;
                ctx.textAlign = titleSettings.alignment;
                ctx.fillStyle = titleSettings.color;

                let textX = canvas.width * titleSettings.positionX + currentOffsetXTitle;
                let textY = canvas.height * titleSettings.positionY + currentOffsetYTitle;

                ctx.translate(textX, textY);
                ctx.rotate(currentRotationTitle * Math.PI / 180);
                ctx.scale(currentScaleTitle, currentScaleTitle); // Apply animated scale here

                const lines = title.split('\n');
                let currentLineY = 0;

                // For text background (adjust calculations for the new scaling)
                if (titleSettings.bgOpacity > 0) {
                    const textWidths = lines.map(line => ctx.measureText(line).width);
                    const maxTextWidth = Math.max(...textWidths);
                    const textHeight = currentFontSizeTitle * titleSettings.lineHeight * lines.length; // Approximate total height

                    const bgWidth = maxTextWidth * titleSettings.bgWidth;
                    const bgHeight = textHeight * titleSettings.bgHeight;

                    let bgX = 0;
                    if (titleSettings.alignment === 'center') {
                        bgX = -bgWidth / 2;
                    } else if (titleSettings.alignment === 'right') {
                        bgX = -bgWidth;
                    }
                    bgX += titleSettings.bgOffsetX;
                    const bgY = -textHeight / 2 + titleSettings.bgOffsetY; // Center vertically on text

                    ctx.fillStyle = `rgba(${parseInt(titleSettings.bgColor.slice(1, 3), 16)}, ${parseInt(titleSettings.bgColor.slice(3, 5), 16)}, ${parseInt(titleSettings.bgColor.slice(5, 7), 16)}, ${titleSettings.bgOpacity})`;
                    roundRect(ctx, bgX, bgY, bgWidth, bgHeight, titleSettings.bgRoundedRect);
                    ctx.fill();
                }

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    currentLineY = (-currentFontSizeTitle * titleSettings.lineHeight * (lines.length - 1) / 2) + (i * currentFontSizeTitle * titleSettings.lineHeight);
                    ctx.fillText(line, 0, currentLineY);
                    if (titleSettings.strokeThickness > 0) {
                        ctx.strokeStyle = titleSettings.strokeColor;
                        ctx.lineWidth = titleSettings.strokeThickness;
                        ctx.strokeText(line, 0, currentLineY);
                    }
                }
                ctx.restore();
            }

            // Draw text
            const text = videoTextInput.value;
            if (text) {
                const textSettings = settings.text;
                ctx.save();
                applyShadow(ctx, textSettings);

                let currentFontSizeText = textSettings.fontSize;
                let currentScaleText = textSettings.scale; // Base scale for the element
                let currentRotationText = textSettings.rotation;
                let currentOffsetXText = 0;
                let currentOffsetYText = 0;
                let currentBlurText = 0;
                let currentOpacityText = textSettings.opacity;

                // Apply scale animation to the overall element scale, not just font size
                currentScaleText = getAnimatedValue(currentScaleText, audioValue, textSettings.animations.scale);
                currentRotationText = getAnimatedValue(currentRotationText, audioValue, textSettings.animations.rotation, true);
                currentOffsetXText = getAnimatedValue(currentOffsetXText, audioValue, textSettings.animations.offsetX);
                currentOffsetYText = getAnimatedValue(currentOffsetYText, audioValue, textSettings.animations.offsetY);
                currentBlurText = getAnimatedValue(currentBlurText, audioValue, textSettings.animations.blur);
                currentOpacityText = getAnimatedValue(currentOpacityText, audioValue, textSettings.animations.opacity);
                currentOpacityText = Math.max(0, Math.min(textSettings.opacity, currentOpacityText));

                ctx.globalAlpha = currentOpacityText;
                ctx.filter = `blur(${currentBlurText}px)`;

                const fontToUse = textSettings.fontFamily.startsWith('custom-text-uploaded-font') || textSettings.fontFamily.startsWith('custom-text-url-font') ? textSettings.fontFamily : `'${textSettings.fontFamily}'`;
                // Font size remains fixed, scaling is done via ctx.scale
                ctx.font = `${textSettings.fontStyle} ${currentFontSizeText}px ${fontToUse}, sans-serif`;
                ctx.textAlign = textSettings.alignment;
                ctx.fillStyle = textSettings.color;

                let textX = canvas.width * textSettings.positionX + currentOffsetXText;
                let textY = canvas.height * textSettings.positionY + currentOffsetYText;

                ctx.translate(textX, textY);
                ctx.rotate(currentRotationText * Math.PI / 180);
                ctx.scale(currentScaleText, currentScaleText); // Apply animated scale here

                const lines = text.split('\n');
                let currentLineY = 0;

                if (textSettings.bgOpacity > 0) {
                    const textWidths = lines.map(line => ctx.measureText(line).width);
                    const maxTextWidth = Math.max(...textWidths);
                    const textHeight = currentFontSizeText * textSettings.lineHeight * lines.length;

                    const bgWidth = maxTextWidth * textSettings.bgWidth;
                    const bgHeight = textHeight * textSettings.bgHeight;

                    let bgX = 0;
                    if (textSettings.alignment === 'center') {
                        bgX = -bgWidth / 2;
                    } else if (textSettings.alignment === 'right') {
                        bgX = -bgWidth;
                    }
                    bgX += textSettings.bgOffsetX;
                    const bgY = -textHeight / 2 + textSettings.bgOffsetY;

                    ctx.fillStyle = `rgba(${parseInt(textSettings.bgColor.slice(1, 3), 16)}, ${parseInt(textSettings.bgColor.slice(3, 5), 16)}, ${parseInt(textSettings.bgColor.slice(5, 7), 16)}, ${textSettings.bgOpacity})`;
                    roundRect(ctx, bgX, bgY, bgWidth, bgHeight, textSettings.bgRoundedRect);
                    ctx.fill();
                }

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    currentLineY = (-currentFontSizeText * textSettings.lineHeight * (lines.length - 1) / 2) + (i * currentFontSizeText * textSettings.lineHeight);
                    ctx.fillText(line, 0, currentLineY);
                    if (textSettings.strokeThickness > 0) {
                        ctx.strokeStyle = textSettings.strokeColor;
                        ctx.lineWidth = textSettings.strokeThickness;
                        ctx.strokeText(line, 0, currentLineY);
                    }
                }
                ctx.restore();
            }

            // Draw logo
            if (logoImageLoaded) {
                const logoSettings = settings.logo;
                ctx.save();
                applyShadow(ctx, logoSettings);

                let currentScaleLogo = logoSettings.scale;
                let currentRotationLogo = logoSettings.rotation;
                let currentOffsetXLogo = logoSettings.positionX;
                let currentOffsetYLogo = logoSettings.positionY;
                let currentBlurLogo = 0;
                let currentOpacityLogo = logoSettings.opacity;

                currentScaleLogo = getAnimatedValue(currentScaleLogo, audioValue, logoSettings.animations.scale);
                currentRotationLogo = getAnimatedValue(currentRotationLogo, audioValue, logoSettings.animations.rotation, true);
                currentOffsetXLogo = getAnimatedValue(currentOffsetXLogo, audioValue, logoSettings.animations.offsetX);
                currentOffsetYLogo = getAnimatedValue(currentOffsetYLogo, audioValue, logoSettings.animations.offsetY);
                currentBlurLogo = getAnimatedValue(currentBlurLogo, audioValue, logoSettings.animations.blur);
                currentOpacityLogo = getAnimatedValue(currentOpacityLogo, audioValue, logoSettings.animations.opacity);
                currentOpacityLogo = Math.max(0, Math.min(logoSettings.opacity, currentOpacityLogo));

                ctx.globalAlpha = currentOpacityLogo;
                ctx.filter = `blur(${currentBlurLogo}px)`;

                const logoSize = (80 * currentScaleLogo); // Base logo size * animated scale
                let logoX = canvas.width - logoSize - 20 + currentOffsetXLogo;
                let logoY = 20 + currentOffsetYLogo;

                ctx.translate(logoX + logoSize / 2, logoY + logoSize / 2);
                ctx.rotate(currentRotationLogo * Math.PI / 180);
               
                ctx.drawImage(logoImage, -logoSize / 2, -logoSize / 2, logoSize, logoSize);

                if (logoSettings.strokeThickness > 0) {
                    ctx.strokeStyle = logoSettings.strokeColor;
                    ctx.lineWidth = logoSettings.strokeThickness;
                    ctx.strokeRect(-logoSize / 2, -logoSize / 2, logoSize, logoSize);
                }
                ctx.restore();
            }

            // Draw audio visualization bar
            const visualizerSettings = settings.visualizer;
            if (audioBuffer && visualizerSettings.enabled) {
                ctx.save();
                applyShadow(ctx, visualizerSettings);

                let currentScaleViz = visualizerSettings.scale;
                let currentRotationViz = visualizerSettings.rotation;
                let currentOffsetXViz = 0; // Will be added to base X
                let currentOffsetYViz = 0; // Will be added to base Y
                let currentBlurViz = 0;
                let currentOpacityViz = visualizerSettings.opacity;

                // Apply sound-reactive animations to these temporary variables
                currentScaleViz = getAnimatedValue(currentScaleViz, audioValue, visualizerSettings.animations.scale);
                currentRotationViz = getAnimatedValue(currentRotationViz, audioValue, visualizerSettings.animations.rotation, true);
                currentOffsetXViz = getAnimatedValue(currentOffsetXViz, audioValue, visualizerSettings.animations.offsetX);
                currentOffsetYViz = getAnimatedValue(currentOffsetYViz, audioValue, visualizerSettings.animations.offsetY);
                currentBlurViz = getAnimatedValue(currentBlurViz, audioValue, visualizerSettings.animations.blur);
                currentOpacityViz = getAnimatedValue(currentOpacityViz, audioValue, visualizerSettings.animations.opacity);
                currentOpacityViz = Math.max(0, Math.min(visualizerSettings.opacity, currentOpacityViz));

                ctx.globalAlpha = currentOpacityViz;
                ctx.filter = `blur(${currentBlurViz}px)`;

                // Calculate base dimensions
                const baseBarWidth = canvas.width * visualizerSettings.width * currentScaleViz;
                const baseBarHeight = visualizerSettings.height * currentScaleViz;

                // The bar's height itself is directly driven by audioValue
                const animatedBarHeight = baseBarHeight + (audioValue * 50); // Original audio reactivity combined with new scale

                // Calculate base position relative to canvas
                let vizX = canvas.width * visualizerSettings.positionX + currentOffsetXViz;
                let vizY = canvas.height * visualizerSettings.positionY + currentOffsetYViz;

                // Adjust for alignment before translation
                if (visualizerSettings.alignment === 'center') {
                    vizX -= baseBarWidth / 2;
                } else if (visualizerSettings.alignment === 'right') {
                    vizX -= baseBarWidth;
                }

                // Translate to the center of the bar for rotation and drawing
                ctx.translate(vizX + baseBarWidth / 2, vizY + animatedBarHeight / 2);
                ctx.rotate(currentRotationViz * Math.PI / 180);

                // Draw the bar (centered around the new origin)
                ctx.fillStyle = visualizerSettings.color;
                ctx.fillRect(-baseBarWidth / 2, -animatedBarHeight / 2, baseBarWidth, animatedBarHeight);

                if (visualizerSettings.strokeThickness > 0) {
                    ctx.strokeStyle = visualizerSettings.strokeColor;
                    ctx.lineWidth = visualizerSettings.strokeThickness;
                    ctx.strokeRect(-baseBarWidth / 2, -animatedBarHeight / 2, baseBarWidth, animatedBarHeight);
                }
                ctx.restore();
            }
        }

        /**
         * The main animation loop.
         */
        function animate(currentTime) {
            animationFrameId = requestAnimationFrame(animate);

            if (!audioContext || !analyser || !dataArray || !isPlaying) {
                drawCanvas(0); // Draw static if no audio or not playing
                return;
            }

            const elapsed = currentTime - lastFrameTime;
            const currentFpsInterval = 1000 / parseInt(fpsInput.value || 30);

            if (elapsed > currentFpsInterval) {
                lastFrameTime = currentTime - (elapsed % currentFpsInterval);
                drawCanvas(getNormalizedAudioValue());
            }
        }

        /**
         * Starts the audio playback and visualization.
         */
        async function startAudioVisualization() {
            if (!audioBuffer) {
                showMessage('សូមផ្ទុកឡើងបទចម្រៀងជាមុនសិន។', 'error');
                return;
            }
            if (!audioContext) { // Ensure audioContext is initialized
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                gainNode = audioContext.createGain();
                gainNode.gain.value = settings.global.volume;
                gainNode.connect(audioContext.destination);
            }

            // Resume audio context if it's suspended (common for user interaction requirement)
            if (audioContext.state === 'suspended') {
                await audioContext.resume();
            }

            // Stop previous playback if any
            if (source) {
                source.stop();
                source.disconnect();
            }
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }

            // Create new source and analyser
            source = audioContext.createBufferSource();
            source.buffer = audioBuffer;

            analyser = audioContext.createAnalyser();
            analyser.fftSize = 256; // Fast Fourier Transform size
            bufferLength = analyser.frequencyBinCount;
            dataArray = new Uint8Array(bufferLength);

            source.connect(analyser);
            analyser.connect(gainNode); // Connect analyser to gainNode for volume control

            source.loop = false; // Set to false so onended event fires
            source.onended = () => { // Stop recording when audio ends
                if (isRecording) {
                    stopRecording();
                }
                pauseAudio(); // Also pause preview when audio ends
                showMessage('បទចម្រៀងបានបញ្ចប់។', 'info');
            };
            source.start(0); // Play immediately

            isPlaying = true;
            playPauseButton.textContent = 'ផ្អាក';
            showMessage('កំពុងបង្កើតការមើលជាមុន...', 'info');
            lastFrameTime = performance.now(); // Initialize lastFrameTime
            animate(lastFrameTime); // Start animation loop
        }

        /**
         * Pauses the audio playback and visualization.
         */
        function pauseAudio() {
            if (source && audioContext && audioContext.state !== 'closed') {
                source.stop();
                source.disconnect();
                // Do not close audioContext if recording might still be active or user might want to resume
            }
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            isPlaying = false;
            playPauseButton.textContent = 'លេង';
            drawCanvas(0); // Draw static canvas when paused
        }

        // --- Recording Functions ---

        /**
         * Starts recording the canvas.
         */
        function startRecording() {
            if (!canvas.captureStream) {
                showMessage('Browser របស់អ្នកមិនគាំទ្រការថតវីដេអូទេ។', 'error');
                return;
            }
            if (!audioBuffer) {
                showMessage('សូមផ្ទុកឡើងបទចម្រៀងជាមុនសិន ដើម្បីថតវីដេអូជាមួយសំឡេង។', 'error');
                return;
            }

            // Ensure audioContext and gainNode are initialized
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                gainNode = audioContext.createGain();
                gainNode.gain.value = settings.global.volume;
                gainNode.connect(audioContext.destination);
            }

            // Resume audio context if it's suspended
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }

            // Get a MediaStream from the canvas
            const stream = canvas.captureStream(parseInt(fpsInput.value || 30)); // Capture at selected FPS

            // Disconnect existing source from destination to avoid double audio during recording setup
            if (source) {
                source.stop();
                source.disconnect();
            }
            // Recreate and reconnect source for recording
            source = audioContext.createBufferSource();
            source.buffer = audioBuffer;
            source.loop = false; // Crucial for onended to fire
            source.onended = () => {
                if (isRecording) {
                    stopRecording();
                }
                pauseAudio(); // Also pause preview when audio ends
                showMessage('បទចម្រៀងបានបញ្ចប់។', 'info');
            };

            analyser = audioContext.createAnalyser();
            analyser.fftSize = 256;
            bufferLength = analyser.frequencyBinCount;
            dataArray = new Uint8Array(bufferLength);

            source.connect(analyser);
            analyser.connect(gainNode); // Connect analyser to gainNode for volume control

            const audioDestination = audioContext.createMediaStreamDestination();
            source.connect(audioDestination); // Connect audio source to recording destination
            stream.addTrack(audioDestination.stream.getAudioTracks()[0]);

            source.start(0); // Start audio playback for recording


            recordedChunks = [];
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm; codecs=vp8,opus' }); // WebM format

            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };

            mediaRecorder.onstop = () => {
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                document.body.appendChild(a);
                a.style = 'display: none';
                a.href = url;
                a.download = 'recode_video_preview.webm';
                a.click();
                window.URL.revokeObjectURL(url);
                showMessage('វីដេអូ WebM ត្រូវបានទាញយកដោយជោគជ័យ។', 'success');
                recordButton.textContent = 'ថតវីដេអូ';
                recordingIndicator.classList.add('hidden');
                isRecording = false;
                // Stop audio playback if it was looping for recording
                if (source && audioContext && audioContext.state !== 'closed') {
                    source.stop();
                    source.disconnect();
                    audioContext.close(); // Close context to release resources
                    audioContext = null; // Reset audio context
                }
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                    animationFrameId = null;
                }
                drawCanvas(0); // Draw static canvas after recording stops
            };

            mediaRecorder.onerror = (event) => {
                showMessage('មានបញ្ហាក្នុងការថតវីដេអូ: ' + event.error.name, 'error');
                console.error('MediaRecorder Error:', event.error);
                recordButton.textContent = 'ថតវីដេអូ';
                recordingIndicator.classList.add('hidden');
                isRecording = false;
                if (source && audioContext && audioContext.state !== 'closed') {
                    source.stop();
                    source.disconnect();
                    audioContext.close();
                    audioContext = null;
                }
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                    animationFrameId = null;
                }
                drawCanvas(0);
            };

            mediaRecorder.start();
            isRecording = true;
            recordButton.textContent = 'បញ្ឈប់ការថត';
            recordingIndicator.classList.remove('hidden');
            showMessage('កំពុងថតវីដេអូ...', 'info');
            lastFrameTime = performance.now(); // Ensure animation starts/continues for recording
            animate(lastFrameTime);
        }

        /**
         * Stops recording the canvas.
         */
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
        }

        // --- Image Download Function ---

        /**
         * Downloads the current canvas content as a PNG image.
         */
        function downloadImage() {
            const dataURL = canvas.toDataURL('image/png');
            const a = document.createElement('a');
            a.href = dataURL;
            a.download = 'recode_image_snapshot.png';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showMessage('រូបភាពត្រូវបានទាញយកដោយជោគជ័យ។', 'success');
        }

        // --- Main Logic ---

        generateButton.addEventListener('click', () => {
            hideMessageBox();
            startAudioVisualization();
        });

        playPauseButton.addEventListener('click', () => {
            hideMessageBox();
            if (isPlaying) {
                pauseAudio();
            } else {
                startAudioVisualization();
            }
        });

        recordButton.addEventListener('click', () => {
            hideMessageBox();
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        });

        downloadImageButton.addEventListener('click', downloadImage);

        // Initial setup
        setCanvasDimensions();
        drawCanvas(); // Draw initial static canvas


        // Optional: Implement Firebase for future features (e.g., saving user preferences)
        // This part is commented out as it's not directly required for the core functionality
        // but shows how Firebase would be integrated if persistence was needed.
        /*
        let db, auth;
        let currentUserId = null;

        async function initializeFirebase() {
            try {
                if (firebaseConfig) {
                    const app = firebase.initializeApp(firebaseConfig);
                    db = firebase.firestore.getFirestore(app);
                    auth = firebase.auth.getAuth(app);

                    if (initialAuthToken) {
                        await firebase.auth.signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await firebase.auth.signInAnonymously(auth);
                    }

                    firebase.auth.onAuthStateChanged(auth, (user) => {
                        if (user) {
                            currentUserId = user.uid;
                            console.log("Firebase initialized. User ID:", currentUserId);
                            // You can now safely perform Firestore operations
                        } else {
                            currentUserId = null;
                            console.log("No user signed in.");
                        }
                    });
                } else {
                    console.warn("Firebase config not provided. Persistence features will be unavailable.");
                }
            } catch (error) {
                console.error("Error initializing Firebase:", error);
            }
        }

        // Call Firebase initialization on window load
        window.addEventListener('load', initializeFirebase);
        */
    </script>
</body>
</html>
