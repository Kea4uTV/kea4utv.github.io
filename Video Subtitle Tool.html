<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Subtitle Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Angkor&family=Battambang&family=Bayon&family=Chenla&family=Content&family=Dangrek&family=Fasthand&family=Freehand&family=Hanuman&family=Kdam+Thmor+Pro&family=Kantumruy+Pro&family=Khmer+Siamreap&family=Koulen&family=Moul&family=Moulpali&family=Nokora&family=Noto+Sans+Khmer:wght@400;600&family=Noto+Serif+Khmer:wght@400;600&family=Odor+Mean+Chey&family=Preahvihear&family=Suwannaphum&family=Metal&display=swap');
        
        body {
            font-family: 'Noto Serif Khmer', sans-serif;
            background-color: #f3f4f6;
        }
        #videoCanvas {
            min-height: 400px;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: all 0.5s ease-in-out;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        .subtitle-container {
            position: absolute;
            bottom: 2.5%;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 15px;
            border-radius: 8px;
            transition: all 0.3s ease-in-out;
            max-width: 90%;
            word-break: break-word;
        }
        .subtitle-text {
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            font-size: 2.5rem;
            text-align: center;
            font-weight: 600;
            line-height: 1.2;
            word-spacing: 0.1em;
            letter-spacing: 0.05em;
        }
        .subtitle-line {
            display: block;
            margin: 0;
            padding: 0;
        }
        .subtitle-text span {
            transition: all 0.2s ease-in-out;
            display: inline-block;
        }
        .btn-primary {
            background-color: #1e40af;
            color: white;
            padding: 12px 24px;
            border-radius: 9999px;
            transition: background-color 0.3s ease-in-out;
        }
        .btn-primary:hover {
            background-color: #1e3a8a;
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #4b5563;
            padding: 8px 16px;
            border-radius: 8px;
            transition: background-color 0.3s ease-in-out;
        }
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        .btn-secondary.active {
            background-color: #d1d5db;
            color: #1f2937;
        }
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .control-group {
            display: flex;
            flex-direction: column;
        }
        .control-group label {
            margin-bottom: 4px;
            font-weight: 600;
            color: #4b5563;
        }
        .control-group select,
        .control-group input[type="file"],
        .control-group button,
        .control-group textarea,
        .control-group input[type="color"],
        .control-group input[type="range"] {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #d1d5db;
        }
        .control-group select:focus,
        .control-group input[type="file"]:focus,
        .control-group button:focus,
        .control-group textarea:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.5);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center p-4 min-h-screen">

    <div class="card p-6 w-full max-w-5xl">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">Video Subtitle Tool</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <!-- Resolution Control -->
            <div class="control-group">
                <label for="resolution-select">Resolution</label>
                <select id="resolution-select">
                    <optgroup label="Landscape (16:9)">
                        <option value="7680x4320">4320p (8K)</option>
                        <option value="3840x2160">2160p (4K)</option>
                        <option value="2560x1440">1440p (2K)</option>
                        <option value="1920x1080" selected>1080p (HD)</option>
                        <option value="1280x720">720p (HD)</option>
                        <option value="854x480">480p (SD)</option>
                        <option value="640x360">360p (SD)</option>
                        <option value="426x240">240p (SD)</option>
                    </optgroup>
                    <optgroup label="Portrait (9:16)">
                        <option value="2160x3840">2160p (4K)</option>
                        <option value="1080x1920">1080p (HD)</option>
                        <option value="720x1280">720p (HD)</option>
                        <option value="480x854">480p (SD)</option>
                    </optgroup>
                    <optgroup label="Square (1:1)">
                        <option value="2160x2160">2160x2160</option>
                        <option value="1080x1080">1080x1080</option>
                        <option value="720x720">720x720</option>
                        <option value="480x480">480x480</option>
                    </optgroup>
                </select>
            </div>
            
            <!-- Background Mode Control -->
            <div class="control-group">
                <label for="bg-mode-select">Background Mode</label>
                <select id="bg-mode-select">
                    <option value="fill">Fill</option>
                    <option value="fit">Fit</option>
                    <option value="stretch">Stretch</option>
                    <option value="tile">Tile</option>
                    <option value="center">Center</option>
                </select>
            </div>

            <!-- Background Image Input -->
            <div class="control-group">
                <label for="background-image-input">Background Image</label>
                <input type="file" id="background-image-input" accept="image/*">
            </div>
        </div>

        <!-- Video Canvas and Subtitle Area -->
        <div id="videoCanvas" class="bg-gray-200 w-full relative mb-2 rounded-lg overflow-hidden flex items-center justify-center">
            <div id="subtitle-container" class="subtitle-container">
                <div id="subtitle-display" class="subtitle-text"></div>
            </div>
        </div>
        <p id="resolution-info" class="text-center text-sm text-gray-500 mb-4"></p>

        <!-- Subtitle and Audio Controls -->
        <div class="flex flex-col gap-4">
            <!-- Audio Input -->
            <div class="control-group">
                <label for="audio-input">Upload Audio (បញ្ចូលសំឡេង)</label>
                <input type="file" id="audio-input" accept="audio/*">
            </div>
            <div id="audio-controls-container" class="hidden">
                <div class="flex items-center gap-4">
                    <audio id="audio-player" controls class="w-full"></audio>
                    <span id="time-display" class="text-sm font-mono text-gray-600 w-24">00:00.00</span>
                    <button id="copy-time-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg whitespace-nowrap">ចម្លងពេលវេលា (Copy Time)</button>
                </div>
            </div>

            <!-- Subtitle Styling Controls -->
            <div id="subtitle-controls-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 p-4 mt-4 border border-gray-200 rounded-lg">
                <h3 class="text-xl font-bold col-span-full mb-2">Subtitle Controls (ការកំណត់ចំណងជើងរង)</h3>
                
                <!-- Layout & Position -->
                <div class="col-span-full">
                    <h4 class="text-lg font-bold mb-2">ប្លង់ & ទីតាំង (Layout & Position)</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- Vertical Position -->
                        <div class="control-group">
                            <label for="vertical-position-slider">ទីតាំងបញ្ឈរ (Vertical Position)</label>
                            <input type="range" id="vertical-position-slider" min="0" max="100" value="10" step="1">
                        </div>
                        <!-- Horizontal Position -->
                        <div class="control-group">
                            <label for="horizontal-position-slider">ទីតាំងផ្ដេក (Horizontal Position)</label>
                            <input type="range" id="horizontal-position-slider" min="0" max="100" value="50" step="1">
                        </div>
                    </div>
                </div>

                <!-- Font Selection -->
                <div class="control-group">
                    <label for="font-family-select">ពុម្ពអក្សរ (Font Family)</label>
                    <select id="font-family-select">
                        <option value="'Noto Serif Khmer', sans-serif">Noto Serif Khmer (ខ្មែរ)</option>
                        <option value="'Noto Sans Khmer', sans-serif">Noto Sans Khmer (ខ្មែរ)</option>
                        <option value="'Hanuman', serif">Hanuman (ខ្មែរ)</option>
                        <option value="'Kantumruy Pro', sans-serif">Kantumruy Pro (ខ្មែរ)</option>
                        <option value="'Battambang', serif">Battambang</option>
                        <option value="'Suwannaphum', serif">Suwannaphum</option>
                        <option value="'Preahvihear', sans-serif">Preahvihear</option>
                        <option value="'Khmer Siamreap', sans-serif">Khmer Siamreap</option>
                        <option value="'Content', serif">Content</option>
                        <option value="'Moul', serif">Moul</option>
                        <option value="'Koulen', sans-serif">Koulen</option>
                        <option value="'Metal', sans-serif">Metal</option>
                        <option value="'Bayon', serif">Bayon</option>
                        <option value="'Angkor', serif">Angkor</option>
                        <option value="'Nokora', sans-serif">Nokora</option>
                        <option value="'Odor Mean Chey', sans-serif">Odor Mean Chey</option>
                        <option value="'Moulpali', sans-serif">Moulpali</option>
                        <option value="'Chenla', serif">Chenla</option>
                        <option value="'Kdam Thmor Pro', sans-serif">Kdam Thmor Pro</option>
                        <option value="'Dangrek', sans-serif">Dangrek</option>
                        <option value="'Freehand', sans-serif">Freehand</option>
                        <option value="'Fasthand', sans-serif">Fasthand</option>
                        <option value="Arial, sans-serif">Arial</option>
                        <option value="Times New Roman, serif">Times New Roman</option>
                        <option value="Courier New, monospace">Courier New</option>
                    </select>
                </div>

                <!-- Custom Font Upload -->
                <div class="control-group">
                    <label for="font-upload-input">Upload Font (.ttf, .otf)</label>
                    <input type="file" id="font-upload-input" accept=".ttf,.otf">
                </div>
                
                <!-- Font Size -->
                <div class="control-group">
                    <label for="font-size-slider">ទំហំពុម្ពអក្សរ (Font Size)</label>
                    <input type="range" id="font-size-slider" min="0.5" max="3" value="1" step="0.1">
                </div>

                <!-- Text Color -->
                <div class="control-group">
                    <label for="text-color-picker">ពណ៌អក្សរ (Text Color)</label>
                    <input type="color" id="text-color-picker" value="#ffffff" class="h-10">
                </div>

                <!-- Box Color -->
                <div class="control-group">
                    <label for="box-color-picker">ពណ៌ផ្ទៃខាងក្រោយ (Box Color)</label>
                    <input type="color" id="box-color-picker" value="#000000" class="h-10">
                </div>
                
                <!-- Box Opacity -->
                <div class="control-group">
                    <label for="box-opacity-slider">ភាពថ្លា (Opacity)</label>
                    <input type="range" id="box-opacity-slider" min="0" max="1" value="0.5" step="0.05">
                </div>

                <!-- Spacing and Alignment Controls -->
                <div class="control-group col-span-full">
                    <h4 class="text-lg font-bold mb-2">គម្លាត និងការតម្រឹម (Spacing & Alignment)</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- Character Spacing -->
                        <div class="control-group">
                            <label for="character-spacing-slider">គម្លាតអក្សរ (Character Spacing)</label>
                            <input type="range" id="character-spacing-slider" min="0" max="20" value="0" step="0.5">
                        </div>

                        <!-- Line Spacing -->
                        <div class="control-group">
                            <label for="line-spacing-slider">គម្លាតបន្ទាត់ (Line Spacing)</label>
                            <input type="range" id="line-spacing-slider" min="1.0" max="3.0" value="1.2" step="0.1">
                        </div>
                    </div>
                    <!-- Alignment Buttons -->
                    <div class="control-group mt-4">
                        <label>ការតម្រឹម (Alignment)</label>
                        <div class="flex gap-2">
                            <button id="align-left-btn" class="flex-1 btn-secondary" data-align="left">ឆ្វេង (Left)</button>
                            <button id="align-center-btn" class="flex-1 btn-secondary active" data-align="center">កណ្តាល (Center)</button>
                            <button id="align-right-btn" class="flex-1 btn-secondary" data-align="right">ស្តាំ (Right)</button>
                        </div>
                    </div>
                </div>

                <!-- Box Roundedness -->
                <div class="control-group">
                    <label for="box-rounded-slider">ជ្រុងមូល (Rounded Corners)</label>
                    <input type="range" id="box-rounded-slider" min="0" max="24" value="8" step="1">
                </div>
                
                <!-- Shadow Blur -->
                <div class="control-group">
                    <label for="shadow-blur-slider">ភាពព្រាលស្រមោល (Shadow Blur)</label>
                    <input type="range" id="shadow-blur-slider" min="0" max="20" value="10" step="1">
                </div>

                <!-- Shadow Color -->
                <div class="control-group">
                    <label for="shadow-color-picker">ពណ៌ស្រមោល (Shadow Color)</label>
                    <input type="color" id="shadow-color-picker" value="#000000" class="h-10">
                </div>
            </div>

            <!-- Highlight Styling Controls -->
            <div id="highlight-controls-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 p-4 mt-4 border border-gray-200 rounded-lg">
                <h3 class="text-xl font-bold col-span-full mb-2">ការបន្លិចពាក្យ (Highlight Word)</h3>
                
                <!-- Highlight Font Selection -->
                <div class="control-group">
                    <label for="highlight-font-select">ពុម្ពអក្សរ (Font Family)</label>
                    <select id="highlight-font-select">
                        <option value="'Noto Serif Khmer', sans-serif">Noto Serif Khmer (ខ្មែរ)</option>
                        <option value="'Noto Sans Khmer', sans-serif">Noto Sans Khmer (ខ្មែរ)</option>
                        <option value="'Hanuman', serif">Hanuman (ខ្មែរ)</option>
                        <option value="'Kantumruy Pro', sans-serif">Kantumruy Pro (ខ្មែរ)</option>
                        <option value="'Battambang', serif">Battambang</option>
                        <option value="'Suwannaphum', serif">Suwannaphum</option>
                        <option value="'Preahvihear', sans-serif">Preahvihear</option>
                        <option value="'Khmer Siamreap', sans-serif">Khmer Siamreap</option>
                        <option value="'Content', serif">Content</option>
                        <option value="'Moul', serif">Moul</option>
                        <option value="'Koulen', sans-serif">Koulen</option>
                        <option value="'Metal', sans-serif">Metal</option>
                        <option value="'Bayon', serif">Bayon</option>
                        <option value="'Angkor', serif">Angkor</option>
                        <option value="'Nokora', sans-serif">Nokora</option>
                        <option value="'Odor Mean Chey', sans-serif">Odor Mean Chey</option>
                        <option value="'Moulpali', sans-serif">Moulpali</option>
                        <option value="'Chenla', serif">Chenla</option>
                        <option value="'Kdam Thmor Pro', sans-serif">Kdam Thmor Pro</option>
                        <option value="'Dangrek', sans-serif">Dangrek</option>
                        <option value="'Freehand', sans-serif">Freehand</option>
                        <option value="'Fasthand', sans-serif">Fasthand</option>
                        <option value="Arial, sans-serif">Arial</option>
                        <option value="Times New Roman, serif">Times New Roman</option>
                        <option value="Courier New, monospace">Courier New</option>
                    </select>
                </div>

                <!-- Custom Highlight Font Upload -->
                <div class="control-group">
                    <label for="highlight-font-upload-input">Upload Font (.ttf, .otf)</label>
                    <input type="file" id="highlight-font-upload-input" accept=".ttf,.otf">
                </div>

                <div class="control-group flex-row items-center gap-2">
                    <input type="checkbox" id="highlight-bold-checkbox">
                    <label for="highlight-bold-checkbox" class="mb-0">អក្សរដិត</label>
                </div>
                <div class="control-group flex-row items-center gap-2">
                    <input type="checkbox" id="highlight-italic-checkbox">
                    <label for="highlight-italic-checkbox" class="mb-0">អក្សរទ្រេត</label>
                </div>
                <div class="control-group flex-row items-center gap-2">
                    <input type="checkbox" id="highlight-underline-checkbox">
                    <label for="highlight-underline-checkbox" class="mb-0">គូសបន្ទាត់ក្រោម</label>
                </div>
                <div class="control-group">
                    <label for="highlight-color-picker">ពណ៌បន្លិច</label>
                    <input type="color" id="highlight-color-picker" value="#FFD700" class="h-10">
                </div>
            </div>

            <!-- Subtitle JSON Input -->
            <div class="control-group mt-4">
                <label for="subtitle-text-input" class="text-xl font-bold text-gray-800">Enter Your Subtitle JSON Here (បញ្ចូលទិន្នន័យ JSON ចំណងជើងរងរបស់អ្នកនៅទីនេះ)</label>
                <textarea id="subtitle-text-input" rows="10" class="w-full rounded-lg border-gray-300 font-mono text-sm resize-none"></textarea>
                <small class="text-gray-500 mt-1">
                    <span class="font-bold">JSON Format (ទម្រង់ JSON):</span><br>
                    Please use the following JSON format to add subtitles with timing and styling:<br>
                    <pre class="bg-gray-100 p-2 rounded mt-2">
[
  {
    "startTime": 0.5,
    "endTime": 3.0,
    "lines": [
      {
        "text": "ខ្ញុំបានបង្កើតឧបករណ៍គំរូមួយ",
        "words": [
          { "text": "ខ្ញុំ", "time": 0.5 },
          { "text": "បាន", "time": 0.7 },
          { "text": "បង្កើត", "time": 1.0, "color": "red", "size": 1.2 },
          { "text": "ឧបករណ៍", "time": 1.3 },
          { "text": "គំរូមួយ", "time": 1.7 }
        ]
      },
      {
        "text": "សម្រាប់ធ្វើវីដេអូ",
        "words": [
          { "text": "សម្រាប់", "time": 2.1, "color": "cyan", "size": 1.3 },
          { "text": "ធ្វើ", "time": 2.4 },
          { "text": "វីដេអូ", "time": 2.7 }
        ]
      }
    ]
  }
]</pre>
                </small>
            </div>
        </div>

        <div class="flex gap-4 mt-6">
            <button id="play-btn" class="flex-1 btn-primary">Play</button>
            <button id="record-btn" class="flex-1 btn-primary">Record</button>
            <button id="save-btn" class="flex-1 btn-primary">Save (រក្សាទុក)</button>
            <button id="load-btn" class="flex-1 btn-primary">Load (ផ្ទុក)</button>
        </div>
        <div id="loading-indicator" class="flex justify-center mt-4 hidden">
            <div class="loader"></div>
            <span class="ml-2 text-gray-600">កំពុងផ្ទុក...</span>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- UI Elements ---
            const videoCanvas = document.getElementById('videoCanvas');
            const subtitleContainer = document.getElementById('subtitle-container');
            const resolutionSelect = document.getElementById('resolution-select');
            const bgModeSelect = document.getElementById('bg-mode-select');
            const bgImageInput = document.getElementById('background-image-input');
            const audioInput = document.getElementById('audio-input');
            const subtitleTextInput = document.getElementById('subtitle-text-input');
            const subtitleDisplay = document.getElementById('subtitle-display');
            const playBtn = document.getElementById('play-btn');
            const recordBtn = document.getElementById('record-btn');
            const resolutionInfo = document.getElementById('resolution-info');
            const audioControlsContainer = document.getElementById('audio-controls-container');
            const audioPlayer = document.getElementById('audio-player');
            const timeDisplay = document.getElementById('time-display');
            const copyTimeBtn = document.getElementById('copy-time-btn');
            const loadingIndicator = document.getElementById('loading-indicator');
            
            // --- UI Control Elements ---
            const verticalPositionSlider = document.getElementById('vertical-position-slider');
            const horizontalPositionSlider = document.getElementById('horizontal-position-slider');
            const fontFamilySelect = document.getElementById('font-family-select');
            const fontUploadInput = document.getElementById('font-upload-input');
            const fontSizeSlider = document.getElementById('font-size-slider');
            const textColorPicker = document.getElementById('text-color-picker');
            const boxColorPicker = document.getElementById('box-color-picker');
            const boxOpacitySlider = document.getElementById('box-opacity-slider');
            const boxRoundedSlider = document.getElementById('box-rounded-slider');
            const shadowBlurSlider = document.getElementById('shadow-blur-slider');
            const shadowColorPicker = document.getElementById('shadow-color-picker');
            const highlightFontSelect = document.getElementById('highlight-font-select');
            const highlightFontUploadInput = document.getElementById('highlight-font-upload-input');
            const highlightBoldCheckbox = document.getElementById('highlight-bold-checkbox');
            const highlightItalicCheckbox = document.getElementById('highlight-italic-checkbox');
            const highlightUnderlineCheckbox = document.getElementById('highlight-underline-checkbox');
            const highlightColorPicker = document.getElementById('highlight-color-picker');
            const characterSpacingSlider = document.getElementById('character-spacing-slider');
            const lineSpacingSlider = document.getElementById('line-spacing-slider');
            const alignLeftBtn = document.getElementById('align-left-btn');
            const alignCenterBtn = document.getElementById('align-center-btn');
            const alignRightBtn = document.getElementById('align-right-btn');
            
            // --- Local Storage UI Elements ---
            const saveBtn = document.getElementById('save-btn');
            const loadBtn = document.getElementById('load-btn');

            // --- State Variables ---
            let subtitles = [];
            let isRecording = false;
            let mediaRecorder = null;
            let recordedChunks = [];
            let currentSubtitleIndex = -1;
            let bgImageBase64 = null;
            let audioDataBase64 = null;

            // --- Event Listeners ---
            resolutionSelect.addEventListener('change', updateCanvasResolution);
            bgModeSelect.addEventListener('change', updateBackgroundMode);
            bgImageInput.addEventListener('change', handleBgImageChange);
            audioInput.addEventListener('change', handleAudioChange);
            subtitleTextInput.addEventListener('input', parseSubtitles);
            playBtn.addEventListener('click', togglePlayback);
            recordBtn.addEventListener('click', startAutoRecording);
            
            // Listen for audio events to manage recording automatically
            audioPlayer.addEventListener('play', startRecording);
            audioPlayer.addEventListener('pause', stopRecording);
            audioPlayer.addEventListener('ended', stopRecording);
            audioPlayer.addEventListener('timeupdate', () => {
                animateSubtitles();
                updateTimeDisplay();
            });
            
            copyTimeBtn.addEventListener('click', copyCurrentTime);

            // New UI Control Listeners
            verticalPositionSlider.addEventListener('input', updateSubtitlePosition);
            horizontalPositionSlider.addEventListener('input', updateSubtitlePosition);
            fontFamilySelect.addEventListener('change', applySubtitleStyles);
            fontUploadInput.addEventListener('change', handleFontUpload);
            fontSizeSlider.addEventListener('input', applySubtitleStyles);
            textColorPicker.addEventListener('input', applySubtitleStyles);
            boxColorPicker.addEventListener('input', applySubtitleStyles);
            boxOpacitySlider.addEventListener('input', applySubtitleStyles);
            boxRoundedSlider.addEventListener('input', applySubtitleStyles);
            shadowBlurSlider.addEventListener('input', applySubtitleStyles);
            shadowColorPicker.addEventListener('input', applySubtitleStyles);
            characterSpacingSlider.addEventListener('input', applySubtitleStyles);
            lineSpacingSlider.addEventListener('input', applySubtitleStyles);
            alignLeftBtn.addEventListener('click', () => updateAlignment('left'));
            alignCenterBtn.addEventListener('click', () => updateAlignment('center'));
            alignRightBtn.addEventListener('click', () => updateAlignment('right'));
            
            // Highlight controls
            highlightFontSelect.addEventListener('change', animateSubtitles);
            highlightFontUploadInput.addEventListener('change', handleFontUpload);
            highlightBoldCheckbox.addEventListener('change', animateSubtitles);
            highlightItalicCheckbox.addEventListener('change', animateSubtitles);
            highlightUnderlineCheckbox.addEventListener('change', animateSubtitles);
            highlightColorPicker.addEventListener('input', animateSubtitles);
            
            // Local Storage Listeners
            saveBtn.addEventListener('click', saveProject);
            loadBtn.addEventListener('click', loadProject);

            // --- Initial Setup ---
            updateCanvasResolution();
            
            subtitleTextInput.value = JSON.stringify([
                {
                    "startTime": 0.5,
                    "endTime": 3.0,
                    "lines": [
                        {
                            "text": "ខ្ញុំបានបង្កើតឧបករណ៍គំរូមួយ",
                            "words": [
                                { "text": "ខ្ញុំ", "time": 0.5 },
                                { "text": "បាន", "time": 0.7 },
                                { "text": "បង្កើត", "time": 1.0, "color": "red", "size": 1.2 },
                                { "text": "ឧបករណ៍", "time": 1.3 },
                                { "text": "គំរូមួយ", "time": 1.7 }
                            ]
                        },
                        {
                            "text": "សម្រាប់ធ្វើវីដេអូ",
                            "words": [
                                { "text": "សម្រាប់", "time": 2.1, "color": "cyan", "size": 1.3 },
                                { "text": "ធ្វើ", "time": 2.4 },
                                { "text": "វីដេអូ", "time": 2.7 }
                            ]
                        }
                    ]
                },
                {
                    "startTime": 3.2,
                    "endTime": 6.5,
                    "lines": [
                        {
                            "text": "ដោយមានចំណងជើងរង",
                            "words": [
                                { "text": "ដោយមាន", "time": 3.2 },
                                { "text": "ចំណងជើងរង", "time": 3.7, "color": "yellow", "size": 1.5 }
                            ]
                        },
                        {
                            "text": "និងផ្ទៃខាងក្រោយដ៏ស្រស់ស្អាត។",
                            "words": [
                                { "text": "និង", "time": 4.1 },
                                { "text": "ផ្ទៃខាងក្រោយ", "time": 4.4, "color": "lime", "size": 1.2 },
                                { "text": "ដ៏", "time": 4.9 },
                                { "text": "ស្រស់ស្អាត។", "time": 5.2, "color": "orange", "size": 1.6 }
                            ]
                        }
                    ]
                }
            ], null, 2);
            parseSubtitles();
            subtitleContainer.classList.remove('hidden');
            updateAlignment('center'); // Set initial alignment

            // --- Utility Functions ---
            function showMessage(message) {
                const messageBox = document.createElement('div');
                messageBox.className = `fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50`;
                messageBox.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-xl text-center max-w-sm mx-auto">
                        <p class="text-lg">${message}</p>
                        <button onclick="this.parentElement.parentElement.remove()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-md">យល់ព្រម</button>
                    </div>
                `;
                document.body.appendChild(messageBox);
            }

            function readBlobAsBase64(blob) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            }

            function base64toBlob(base64, mimeType) {
                const byteString = atob(base64.split(',')[1]);
                const arrayBuffer = new ArrayBuffer(byteString.length);
                const intArray = new Uint8Array(arrayBuffer);
                for (let i = 0; i < byteString.length; i++) {
                    intArray[i] = byteString.charCodeAt(i);
                }
                return new Blob([intArray], { type: mimeType });
            }

            // --- Main Functions ---
            function updateCanvasResolution() {
                const [width, height] = resolutionSelect.value.split('x').map(Number);
                
                const maxWidth = videoCanvas.parentElement.offsetWidth;
                const displayRatio = maxWidth / width;
                const newWidth = width * displayRatio;
                const newHeight = height * displayRatio;

                videoCanvas.style.width = `${newWidth}px`;
                videoCanvas.style.height = `${newHeight}px`;

                videoCanvas.dataset.width = width;
                videoCanvas.dataset.height = height;

                resolutionInfo.textContent = `Display Resolution: ${width}x${height}`;

                applySubtitleStyles();
            }

            function updateBackgroundMode() {
                const mode = bgModeSelect.value;
                switch (mode) {
                    case 'fill':
                        videoCanvas.style.backgroundSize = 'cover';
                        videoCanvas.style.backgroundPosition = 'center';
                        videoCanvas.style.backgroundRepeat = 'no-repeat';
                        break;
                    case 'fit':
                        videoCanvas.style.backgroundSize = 'contain';
                        videoCanvas.style.backgroundPosition = 'center';
                        videoCanvas.style.backgroundRepeat = 'no-repeat';
                        break;
                    case 'stretch':
                        videoCanvas.style.backgroundSize = '100% 100%';
                        videoCanvas.style.backgroundPosition = 'center';
                        videoCanvas.style.backgroundRepeat = 'no-repeat';
                        break;
                    case 'tile':
                        videoCanvas.style.backgroundSize = 'auto';
                        videoCanvas.style.backgroundPosition = 'center';
                        videoCanvas.style.backgroundRepeat = 'repeat';
                        break;
                    case 'center':
                        videoCanvas.style.backgroundSize = 'auto';
                        videoCanvas.style.backgroundPosition = 'center';
                        videoCanvas.style.backgroundRepeat = 'no-repeat';
                        break;
                }
            }

            async function handleBgImageChange(event) {
                const file = event.target.files[0];
                if (file) {
                    bgImageBase64 = await readBlobAsBase64(file);
                    videoCanvas.style.backgroundImage = `url(${bgImageBase64})`;
                }
            }

            async function handleAudioChange(event) {
                const file = event.target.files[0];
                if (file) {
                    audioDataBase64 = await readBlobAsBase64(file);
                    audioPlayer.src = audioDataBase64;
                    audioControlsContainer.classList.remove('hidden');
                } else {
                    audioPlayer.removeAttribute('src');
                    audioControlsContainer.classList.add('hidden');
                }
            }
            
            function handleFontUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const fontName = file.name.replace(/\.[^/.]+$/, "");
                        const fontFace = new FontFace(fontName, e.target.result);
                        fontFace.load().then(loadedFace => {
                            document.fonts.add(loadedFace);
                            const newOption1 = new Option(fontName, fontName);
                            fontFamilySelect.add(newOption1);
                            const newOption2 = new Option(fontName, fontName);
                            highlightFontSelect.add(newOption2);
                            fontFamilySelect.value = fontName;
                            highlightFontSelect.value = fontName;
                            applySubtitleStyles();
                        }).catch(error => {
                            console.error('Failed to load font:', error);
                        });
                    };
                    reader.readAsArrayBuffer(file);
                }
            }

            function parseSubtitles() {
                try {
                    subtitles = JSON.parse(subtitleTextInput.value);
                    if (!Array.isArray(subtitles)) {
                        throw new Error('Input is not a valid JSON array.');
                    }
                    subtitleDisplay.innerHTML = '';
                    console.log('Subtitles loaded successfully.');
                } catch (e) {
                    subtitleDisplay.innerHTML = `<span style="color:red;">JSON Parsing Error: ${e.message}</span>`;
                    console.error('JSON Parsing Error:', e);
                }
            }

            function togglePlayback() {
                if (audioPlayer.paused) {
                    audioPlayer.play();
                } else {
                    audioPlayer.pause();
                }
            }
            
            function stopAnimation() {
                subtitleDisplay.innerHTML = '';
            }
            
            function updateTimeDisplay() {
                const totalSeconds = audioPlayer.currentTime;
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = Math.floor(totalSeconds % 60);
                const milliseconds = Math.floor((totalSeconds - Math.floor(totalSeconds)) * 100);
                
                const format = (num) => num.toString().padStart(2, '0');
                timeDisplay.textContent = `${format(minutes)}:${format(seconds)}.${format(milliseconds)}`;
            }

            function copyCurrentTime() {
                const timeToCopy = audioPlayer.currentTime.toFixed(2);
                const tempInput = document.createElement('input');
                document.body.appendChild(tempInput);
                tempInput.value = timeToCopy;
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                
                copyTimeBtn.textContent = 'ចម្លងហើយ! (Copied!)';
                setTimeout(() => {
                    copyTimeBtn.textContent = 'ចម្លងពេលវេលា (Copy Time)';
                }, 1000);
            }

            function updateSubtitlePosition() {
                const verticalValue = verticalPositionSlider.value;
                const horizontalValue = horizontalPositionSlider.value;
                
                const verticalPercentage = `${verticalValue}%`;
                subtitleContainer.style.bottom = verticalPercentage;
                
                const horizontalPercentage = `${horizontalValue}%`;
                subtitleContainer.style.left = horizontalPercentage;
                subtitleContainer.style.transform = `translateX(-${horizontalValue}%)`;
            }

            function applySubtitleStyles() {
                const fontFamily = fontFamilySelect.value;
                const fontSize = fontSizeSlider.value;
                const textColor = textColorPicker.value;
                const boxColor = boxColorPicker.value;
                const boxOpacity = boxOpacitySlider.value;
                const boxRounded = boxRoundedSlider.value;
                const shadowBlur = shadowBlurSlider.value;
                const shadowColor = shadowColorPicker.value;
                const characterSpacing = characterSpacingSlider.value;
                const lineHeight = lineSpacingSlider.value;

                subtitleContainer.style.backgroundColor = `rgba(${parseInt(boxColor.substring(1, 3), 16)}, ${parseInt(boxColor.substring(3, 5), 16)}, ${parseInt(boxColor.substring(5, 7), 16)}, ${boxOpacity})`;
                subtitleContainer.style.borderRadius = `${boxRounded}px`;
                subtitleContainer.style.boxShadow = `0 5px ${shadowBlur}px ${shadowColor}`;
                subtitleDisplay.style.fontFamily = fontFamily;
                
                const baseFontSize = (videoCanvas.offsetHeight / 1080) * 20;
                subtitleDisplay.style.fontSize = `${baseFontSize * fontSize}px`;
                
                subtitleDisplay.style.color = textColor;
                subtitleDisplay.style.letterSpacing = `${characterSpacing}px`;
                subtitleDisplay.style.lineHeight = `${lineHeight}`;
            }

            function updateAlignment(alignment) {
                const buttons = [alignLeftBtn, alignCenterBtn, alignRightBtn];
                buttons.forEach(btn => {
                    btn.classList.remove('active');
                });
                if (alignment === 'left') {
                    alignLeftBtn.classList.add('active');
                    subtitleDisplay.style.textAlign = 'left';
                } else if (alignment === 'center') {
                    alignCenterBtn.classList.add('active');
                    subtitleDisplay.style.textAlign = 'center';
                } else {
                    alignRightBtn.classList.add('active');
                    subtitleDisplay.style.textAlign = 'right';
                }
            }

            function animateSubtitles() {
                const currentTime = audioPlayer.currentTime;
                
                const currentSubtitle = subtitles.find(sub => currentTime >= sub.startTime && currentTime < sub.endTime);
                
                if (currentSubtitle) {
                    if (currentSubtitleIndex !== subtitles.indexOf(currentSubtitle)) {
                        currentSubtitleIndex = subtitles.indexOf(currentSubtitle);
                        subtitleDisplay.innerHTML = '';
                    }
                    
                    let subtitleHtml = '';
                    const baseFontSize = (videoCanvas.offsetHeight / 1080) * 20;
                    
                    currentSubtitle.lines.forEach(lineObj => {
                        let lineHtml = '';
                        lineObj.words.forEach(wordObj => {
                            const isHighlighted = currentTime >= wordObj.time;
                            let style = '';

                            style += `font-family: ${fontFamilySelect.value}; `;
                            style += `font-size: ${baseFontSize * fontSizeSlider.value}px; `;
                            style += `color: ${textColorPicker.value}; `;
                            style += `letter-spacing: ${characterSpacingSlider.value}px; `;
                            style += `line-height: ${lineSpacingSlider.value}; `;

                            if (isHighlighted) {
                                style += `font-family: ${highlightFontSelect.value}; `;
                                style += `color: ${highlightColorPicker.value}; `;
                                if (highlightBoldCheckbox.checked) style += `font-weight: bold; `;
                                if (highlightItalicCheckbox.checked) style += `font-style: italic; `;
                                if (highlightUnderlineCheckbox.checked) style += `text-decoration: underline; `;
                                
                                if (wordObj.color) {
                                    style += `color: ${wordObj.color}; `;
                                }
                                if (wordObj.size) {
                                    style += `font-size: ${baseFontSize * fontSizeSlider.value * wordObj.size}px; `;
                                }
                            }
                            lineHtml += `<span style="${style}">${wordObj.text} </span>`;
                        });
                        subtitleHtml += `<div class="subtitle-line">${lineHtml}</div>`;
                    });
                    subtitleDisplay.innerHTML = subtitleHtml;

                } else {
                    subtitleDisplay.innerHTML = '';
                    currentSubtitleIndex = -1;
                }
            }

            function startAutoRecording() {
                if (!audioPlayer.src) {
                    showMessage("សូមបញ្ចូលឯកសារអូឌីយ៉ូជាមុនសិន។");
                    return;
                }
                
                // Start playback to trigger the 'play' event
                audioPlayer.currentTime = 0;
                audioPlayer.play();
                recordBtn.textContent = 'Recording...';
                recordBtn.disabled = true;
                playBtn.disabled = true;
                
                showMessage("ការថតនឹងចាប់ផ្តើម។ សូមកុំបិទផ្ទាំងនេះរហូតដល់ចប់។");
            }
            
            function startRecording() {
                if (isRecording) return;
                isRecording = true;

                const targetWidth = parseInt(videoCanvas.dataset.width);
                const targetHeight = parseInt(videoCanvas.dataset.height);
                
                const stream = videoCanvas.captureStream(30);
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `video-export-${new Date().getTime()}.webm`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    recordedChunks = [];
                    
                    showMessage("ការថតបានចប់ហើយ។ វានឹងទាញយកដោយស្វ័យប្រវត្តិ។");
                    
                    // Reset UI
                    recordBtn.textContent = 'Record';
                    recordBtn.disabled = false;
                    playBtn.disabled = false;
                };

                mediaRecorder.start();
            }
            
            function stopRecording() {
                if (mediaRecorder && isRecording) {
                    isRecording = false;
                    mediaRecorder.stop();
                    // Stop all tracks to free up resources
                    mediaRecorder.stream.getTracks().forEach(track => track.stop());
                }
            }

            async function saveProject() {
                loadingIndicator.classList.remove('hidden');

                const projectData = {
                    resolution: resolutionSelect.value,
                    bgImageBase64: bgImageBase64,
                    bgMode: bgModeSelect.value,
                    audioDataBase64: audioDataBase64,
                    subtitleSettings: {
                        verticalPosition: verticalPositionSlider.value,
                        horizontalPosition: horizontalPositionSlider.value,
                        fontFamily: fontFamilySelect.value,
                        fontSize: fontSizeSlider.value,
                        textColor: textColorPicker.value,
                        boxColor: boxColorPicker.value,
                        boxOpacity: boxOpacitySlider.value,
                        boxRounded: boxRoundedSlider.value,
                        shadowBlur: shadowBlurSlider.value,
                        shadowColor: shadowColorPicker.value,
                        characterSpacing: characterSpacingSlider.value,
                        lineSpacing: lineSpacingSlider.value,
                        alignment: subtitleDisplay.style.textAlign,
                        highlightFontFamily: highlightFontSelect.value,
                        highlightBold: highlightBoldCheckbox.checked,
                        highlightItalic: highlightItalicCheckbox.checked,
                        highlightUnderline: highlightUnderlineCheckbox.checked,
                        highlightColor: highlightColorPicker.value,
                    },
                    subtitleJson: subtitleTextInput.value,
                };

                try {
                    const projectDataString = JSON.stringify(projectData);
                    localStorage.setItem('videoSubtitleProject', projectDataString);
                    showMessage("បានរក្សាទុកគម្រោងដោយជោគជ័យទៅក្នុងកុំព្យូទ័ររបស់អ្នក!");
                } catch (e) {
                    console.error("Error saving to local storage: ", e);
                    showMessage("មានកំហុសក្នុងការរក្សាទុកគម្រោង។");
                } finally {
                    loadingIndicator.classList.add('hidden');
                }
            }

            function loadProject() {
                loadingIndicator.classList.remove('hidden');

                try {
                    const projectDataString = localStorage.getItem('videoSubtitleProject');
                    if (!projectDataString) {
                        showMessage("មិនមានគម្រោងដែលបានរក្សាទុកទេ។");
                        return;
                    }
                    const data = JSON.parse(projectDataString);
                    
                    resolutionSelect.value = data.resolution;
                    updateCanvasResolution();
                    
                    bgModeSelect.value = data.bgMode;
                    updateBackgroundMode();
                    
                    if (data.bgImageBase64) {
                        bgImageBase64 = data.bgImageBase64;
                        videoCanvas.style.backgroundImage = `url(${bgImageBase64})`;
                    } else {
                        videoCanvas.style.backgroundImage = 'none';
                        bgImageBase64 = null;
                    }
                    
                    if (data.audioDataBase64) {
                        audioDataBase64 = data.audioDataBase64;
                        audioPlayer.src = audioDataBase64;
                        audioControlsContainer.classList.remove('hidden');
                    } else {
                        audioPlayer.removeAttribute('src');
                        audioControlsContainer.classList.add('hidden');
                        audioDataBase64 = null;
                    }
                    
                    subtitleTextInput.value = data.subtitleJson;
                    parseSubtitles();

                    const settings = data.subtitleSettings;
                    verticalPositionSlider.value = settings.verticalPosition;
                    horizontalPositionSlider.value = settings.horizontalPosition;
                    fontFamilySelect.value = settings.fontFamily;
                    fontSizeSlider.value = settings.fontSize;
                    textColorPicker.value = settings.textColor;
                    boxColorPicker.value = settings.boxColor;
                    boxOpacitySlider.value = settings.boxOpacity;
                    boxRoundedSlider.value = settings.boxRounded;
                    shadowBlurSlider.value = settings.shadowBlur;
                    shadowColorPicker.value = settings.shadowColor;
                    characterSpacingSlider.value = settings.characterSpacing;
                    lineSpacingSlider.value = settings.lineSpacing;
                    
                    updateAlignment(settings.alignment);
                    
                    highlightFontSelect.value = settings.highlightFontFamily;
                    highlightBoldCheckbox.checked = settings.highlightBold;
                    highlightItalicCheckbox.checked = settings.highlightItalic;
                    highlightUnderlineCheckbox.checked = settings.highlightUnderline;
                    highlightColorPicker.value = settings.highlightColor;

                    applySubtitleStyles();
                    
                    showMessage("បានផ្ទុកគម្រោងដោយជោគជ័យពីកុំព្យូទ័ររបស់អ្នក។");
                } catch (e) {
                    console.error("Error loading from local storage: ", e);
                    showMessage("មានកំហុសក្នុងការផ្ទុកគម្រោង។ ឯកសារដែលបានរក្សាទុកអាចនឹងមានបញ្ហា។");
                } finally {
                    loadingIndicator.classList.add('hidden');
                }
            }
        });
    </script>
</body>
</html>
