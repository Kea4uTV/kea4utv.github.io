<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRT Studio Recorder - Khmer TTS</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kantumruy Pro', sans-serif; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        const VOICES = [
            { id: 'Kore', name: 'Kore (ស្រទន់ - ស្រី)' },
            { id: 'Zephyr', name: 'Zephyr (បុរស)' },
            { id: 'Puck', name: 'Puck (កំប្លែង)' },
            { id: 'Charon', name: 'Charon (ចាស់ទុំ)' }
        ];

        function App() {
            const [srtInput, setSrtInput] = useState('');
            const [parsedItems, setParsedItems] = useState([]);
            const [selectedVoice, setSelectedVoice] = useState('Kore');
            const [isProcessing, setIsProcessing] = useState(false);
            const [currentProcessIndex, setCurrentProcessIndex] = useState(-1);
            const [mergedAudioUrl, setMergedAudioUrl] = useState(null);
            const [individualAudios, setIndividualAudios] = useState({});
            const audioRef = useRef(null);
            const fileInputRef = useRef(null);

            const timeToSeconds = (timeStr) => {
                if (!timeStr) return 0;
                const [hms, ms] = timeStr.split(',');
                const [h, m, s] = hms.split(':').map(Number);
                return h * 3600 + m * 60 + s + parseInt(ms) / 1000;
            };

            const parseSRT = (data) => {
                const regex = /(\d+)\r?\n(\d{2}:\d{2}:\d{2},\d{3}) --> (\d{2}:\d{2}:\d{2},\d{3})\r?\n([\s\S]*?)(?=\r?\n\r?\n|\r?\n*$)/g;
                const items = [];
                let match;
                while ((match = regex.exec(data)) !== null) {
                    const start = timeToSeconds(match[2]);
                    const end = timeToSeconds(match[3]);
                    items.push({
                        id: match[1],
                        startTime: start,
                        endTime: end,
                        duration: Math.max(0.5, end - start),
                        startStr: match[2],
                        endStr: match[3],
                        text: match[4].replace(/\r?\n/g, ' ').trim(),
                    });
                }
                if (items.length > 0) {
                    setParsedItems(items);
                    setMergedAudioUrl(null);
                    setIndividualAudios({});
                } else {
                    alert("ទម្រង់ឯកសារ SRT មិនត្រឹមត្រូវ!");
                }
            };

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const content = e.target.result;
                        setSrtInput(content);
                        parseSRT(content);
                    };
                    reader.readAsText(file);
                }
            };

            const fetchWithRetry = async (text, duration, voice, retries = 5) => {
                const apiKey = ""; 
                // We instruct the AI to respect the exact duration to match the video/SRT timing
                const prompt = `អានអត្ថបទនេះជាភាសាខ្មែរ ដោយប្រើរយៈពេលយ៉ាងពិតប្រាកដ ${duration.toFixed(2)} វិនាទី (មិនត្រូវឱ្យលើស ឬខ្វះឡើយ)៖ "${text}"`;
                
                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: prompt }] }],
                                generationConfig: {
                                    responseModalities: ["AUDIO"],
                                    speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: voice } } }
                                }
                            })
                        });

                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        const result = await response.json();
                        const inlineData = result.candidates?.[0]?.content?.parts?.[0]?.inlineData;
                        if (inlineData && inlineData.data) return inlineData;
                        throw new Error("No audio data");
                    } catch (err) {
                        if (i === retries - 1) throw err;
                        const delay = Math.pow(2, i) * 1000;
                        await new Promise(r => setTimeout(r, delay));
                    }
                }
            };

            const pcmToWav = (pcmData, sampleRate) => {
                const buffer = new ArrayBuffer(44 + pcmData.length * 2);
                const view = new DataView(buffer);
                const writeString = (offset, string) => {
                    for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
                };
                writeString(0, 'RIFF');
                view.setUint32(4, 32 + pcmData.length * 2, true);
                writeString(8, 'WAVE');
                writeString(12, 'fmt ');
                view.setUint32(16, 16, true);
                view.setUint16(20, 1, true);
                view.setUint16(22, 1, true);
                view.setUint32(24, sampleRate, true);
                view.setUint32(28, sampleRate * 2, true);
                view.setUint16(32, 2, true);
                view.setUint16(34, 16, true);
                writeString(36, 'data');
                view.setUint32(40, pcmData.length * 2, true);
                let offset = 44;
                for (let i = 0; i < pcmData.length; i++, offset += 2) view.setInt16(offset, pcmData[i], true);
                return new Blob([buffer], { type: 'audio/wav' });
            };

            const decodeAudioData = (base64) => {
                const binaryString = atob(base64);
                const len = binaryString.length;
                const bytes = new Int16Array(len / 2);
                for (let i = 0; i < len; i += 2) {
                    bytes[i / 2] = (binaryString.charCodeAt(i + 1) << 8) | binaryString.charCodeAt(i);
                }
                return bytes;
            };

            const processIndividual = async (index) => {
                const item = parsedItems[index];
                try {
                    setCurrentProcessIndex(index);
                    const inlineData = await fetchWithRetry(item.text, item.duration, selectedVoice);
                    const bytes = decodeAudioData(inlineData.data);
                    const wavBlob = pcmToWav(bytes, 24000);
                    const url = URL.createObjectURL(wavBlob);
                    setIndividualAudios(prev => ({ ...prev, [index]: url }));
                } catch (error) {
                    alert("កំហុសក្នុងការផលិតសម្លេងជួរនេះ៖ " + error.message);
                } finally {
                    setCurrentProcessIndex(-1);
                }
            };

            const processFullAudio = async () => {
                if (parsedItems.length === 0) return;
                setIsProcessing(true);
                setMergedAudioUrl(null);
                
                let allAudioChunks = [];
                let currentTimeline = 0;
                const targetSampleRate = 24000; 

                try {
                    for (let i = 0; i < parsedItems.length; i++) {
                        const item = parsedItems[i];
                        setCurrentProcessIndex(i);

                        // Add silence if there's a gap
                        if (item.startTime > currentTimeline) {
                            const silenceDuration = item.startTime - currentTimeline;
                            allAudioChunks.push(new Int16Array(Math.floor(silenceDuration * targetSampleRate)));
                        }

                        const inlineData = await fetchWithRetry(item.text, item.duration, selectedVoice);
                        const bytes = decodeAudioData(inlineData.data);
                        allAudioChunks.push(bytes);

                        currentTimeline = item.endTime;
                    }

                    const totalLength = allAudioChunks.reduce((acc, chunk) => acc + chunk.length, 0);
                    const mergedBuffer = new Int16Array(totalLength);
                    let offset = 0;
                    allAudioChunks.forEach(chunk => {
                        mergedBuffer.set(chunk, offset);
                        offset += chunk.length;
                    });

                    const wavBlob = pcmToWav(mergedBuffer, targetSampleRate);
                    setMergedAudioUrl(URL.createObjectURL(wavBlob));
                } catch (error) {
                    alert("កំហុស៖ " + error.message);
                } finally {
                    setIsProcessing(false);
                    setCurrentProcessIndex(-1);
                }
            };

            return (
                <div className="min-h-screen p-4 md:p-8">
                    <div className="max-w-4xl mx-auto space-y-6">
                        {/* Header */}
                        <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div className="flex items-center gap-4">
                                <div className="bg-indigo-600 p-3 rounded-2xl text-white shadow-lg shadow-indigo-200">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
                                </div>
                                <div>
                                    <h1 className="text-2xl font-black text-slate-800">SRT Studio Web</h1>
                                    <p className="text-slate-500 text-sm font-medium">ផលិតសម្លេងឱ្យត្រូវតាមពេលវេលា SRT</p>
                                </div>
                            </div>
                            <div className="flex gap-2">
                                <select 
                                    value={selectedVoice}
                                    onChange={(e) => setSelectedVoice(e.target.value)}
                                    className="px-4 py-2.5 rounded-xl border border-slate-200 bg-white text-sm font-bold shadow-sm focus:ring-2 focus:ring-indigo-500 outline-none"
                                >
                                    {VOICES.map(v => <option key={v.id} value={v.id}>{v.name}</option>)}
                                </select>
                            </div>
                        </div>

                        {/* Merged Action Bar */}
                        {parsedItems.length > 0 && (
                            <div className="bg-indigo-900 p-6 rounded-3xl shadow-xl flex flex-col md:flex-row items-center justify-between gap-6 text-white">
                                <div>
                                    <p className="text-indigo-200 text-xs font-bold uppercase tracking-widest">ការផលិតសម្លេងរួម</p>
                                    <h2 className="text-lg font-bold">
                                        {isProcessing ? `កំពុងផលិតជួរទី ${currentProcessIndex + 1}...` : mergedAudioUrl ? 'ផលិតសម្លេងរួមរួចរាល់!' : 'ត្រៀមផលិតសម្លេងវែង'}
                                    </h2>
                                </div>
                                <div className="flex gap-3">
                                    {!mergedAudioUrl ? (
                                        <button onClick={processFullAudio} disabled={isProcessing} className="px-8 py-3 bg-white text-indigo-900 font-black rounded-2xl hover:bg-indigo-50 transition-all shadow-lg flex items-center gap-3 disabled:opacity-50">
                                            {isProcessing ? "កំពុងដំណើរការ..." : "ផលិតសម្លេងរួមទាំងអស់"}
                                        </button>
                                    ) : (
                                        <div className="flex gap-2">
                                            <button onClick={() => {audioRef.current.src = mergedAudioUrl; audioRef.current.play();}} className="px-6 py-3 bg-green-500 text-white font-black rounded-2xl hover:bg-green-600 transition-all">ស្តាប់រួម</button>
                                            <a href={mergedAudioUrl} download="srt_full_audio.wav" className="px-6 py-3 bg-white text-indigo-900 font-black rounded-2xl hover:bg-indigo-50 transition-all shadow-lg">ទាញយករួម</a>
                                            <button onClick={() => {setMergedAudioUrl(null); setParsedItems([]); setIndividualAudios({});}} className="p-3 bg-indigo-800 text-white rounded-2xl">Reset</button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* Upload Section */}
                        {parsedItems.length === 0 && (
                            <div className="space-y-4">
                                <div className="bg-white p-12 rounded-[40px] border-4 border-dashed border-slate-200 hover:border-indigo-400 hover:bg-indigo-50/20 transition-all flex flex-col items-center justify-center gap-4 cursor-pointer" onClick={() => fileInputRef.current.click()}>
                                    <div className="p-6 bg-indigo-100 rounded-full text-indigo-600">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                                    </div>
                                    <h3 className="text-xl font-black text-slate-800">បញ្ចូលឯកសារ SRT របស់អ្នក</h3>
                                    <input type="file" ref={fileInputRef} onChange={handleFileUpload} accept=".srt" className="hidden" />
                                </div>
                                <div className="bg-white p-6 rounded-3xl border border-slate-200">
                                    <textarea value={srtInput} onChange={(e) => setSrtInput(e.target.value)} className="w-full h-32 p-4 bg-slate-50 rounded-xl border-none outline-none font-mono text-sm" placeholder="Paste SRT content here..." />
                                    <button onClick={() => parseSRT(srtInput)} className="w-full mt-4 py-3 bg-slate-900 text-white font-black rounded-xl hover:bg-black transition-all">វិភាគអត្ថបទ</button>
                                </div>
                            </div>
                        )}

                        {/* Individual Row Processing */}
                        {parsedItems.length > 0 && (
                            <div className="space-y-3 max-h-[600px] overflow-y-auto pr-2 custom-scroll">
                                <h3 className="text-sm font-bold text-slate-400 uppercase tracking-widest pl-2">បញ្ជីអត្ថបទតាមជួរ</h3>
                                {parsedItems.map((item, index) => (
                                    <div key={index} className={`bg-white p-4 rounded-2xl border-2 transition-all ${currentProcessIndex === index ? 'border-indigo-500 bg-indigo-50 shadow-md' : 'border-white shadow-sm'} flex items-center justify-between gap-4`}>
                                        <div className="flex gap-4 items-start">
                                            <div className="text-[10px] font-black text-indigo-600 bg-indigo-50 w-6 h-6 flex items-center justify-center rounded-lg">#{item.id}</div>
                                            <div>
                                                <div className="flex items-center gap-2 mb-1">
                                                    <span className="text-[10px] font-mono text-slate-400">{item.startStr} ⮕ {item.endStr}</span>
                                                    <span className="text-[10px] font-bold bg-slate-100 text-slate-600 px-2 py-0.5 rounded-full">{item.duration.toFixed(2)}s</span>
                                                </div>
                                                <p className="text-slate-800 font-bold leading-tight">{item.text}</p>
                                            </div>
                                        </div>
                                        
                                        <div className="flex items-center gap-2">
                                            {individualAudios[index] ? (
                                                <div className="flex gap-2">
                                                    <button 
                                                        onClick={() => {audioRef.current.src = individualAudios[index]; audioRef.current.play();}}
                                                        className="p-2 bg-green-100 text-green-600 rounded-xl hover:bg-green-200 transition-colors"
                                                        title="ស្តាប់"
                                                    >
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                                                    </button>
                                                    <a 
                                                        href={individualAudios[index]} 
                                                        download={`segment_${item.id}.wav`}
                                                        className="p-2 bg-slate-100 text-slate-600 rounded-xl hover:bg-slate-200 transition-colors"
                                                        title="ទាញយក"
                                                    >
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                                                    </a>
                                                </div>
                                            ) : (
                                                <button 
                                                    onClick={() => processIndividual(index)}
                                                    disabled={currentProcessIndex !== -1}
                                                    className="p-2 bg-indigo-50 text-indigo-600 rounded-xl hover:bg-indigo-100 transition-colors disabled:opacity-30"
                                                    title="ផលិតសម្លេងជួរនេះ"
                                                >
                                                    {currentProcessIndex === index ? (
                                                        <div className="w-5 h-5 border-2 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
                                                    ) : (
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
                                                    )}
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                        <audio ref={audioRef} className="hidden" />
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
