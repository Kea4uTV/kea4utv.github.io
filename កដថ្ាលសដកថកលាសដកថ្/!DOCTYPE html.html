<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- PWA Title: Used for the installed application name -->
    <title>Webcam View Only</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Custom Styles for a full-screen, minimal view */
        body {
            background-color: #000000; /* ផ្ទៃខាងក្រោយខ្មៅ */
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent scrolling */
        }
        
        #videoContainer {
            width: 100vw;
            height: 100vh;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #video {
            /* Mirror effect (like a selfie camera) */
            transform: scaleX(-1); 
            /* Video should cover the viewport without borders */
            width: 100%;
            height: 100%;
            object-fit: cover; /* Ensures video fills the screen area */
            border-radius: 0;
        }

        /* Minimal error/loading messages - only for debugging */
        #loadingMessage, #errorMessage {
            z-index: 10;
            opacity: 0.9;
        }

        /* Style for the floating settings button */
        #settingsButton {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 20;
            cursor: pointer;
            background-color: rgba(255, 255, 255, 0.2);
            transition: background-color 0.2s;
        }
        #settingsButton:hover {
            background-color: rgba(255, 255, 255, 0.4);
        }

        /* Style for the resolution selector dropdown */
        #resolutionSelector {
            position: absolute;
            bottom: 70px;
            right: 20px;
            z-index: 20;
            background-color: rgba(0, 0, 0, 0.85);
            max-height: 300px;
            overflow-y: auto;
            display: none; /* Hidden by default */
        }
        
        /* Style for resolution list items */
        .res-item {
            cursor: pointer;
            transition: background-color 0.1s;
        }
        .res-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Recording Indicator (Top Left) */
        #recordingIndicator {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: red;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.8);
            z-index: 20;
            animation: pulse 1.5s infinite; /* Pulsating effect */
            display: none;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Feedback Message Box (Temporary) */
        #feedbackMessage {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 15px;
            border-radius: 6px;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none; /* Allows clicks to pass through */
        }
    </style>
    
    <!-- PWA Metadata: Allows the app to be installed (Pop Up) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
</head>
<body>

    <!-- Video Element Container (Only the required view) -->
    <div id="videoContainer">
        <video id="video" autoplay playsinline></video>
        
        <!-- Minimal Loading Message (Hidden by default) -->
        <div id="loadingMessage" class="absolute inset-0 flex items-center justify-center bg-black hidden">
            <p class="text-white text-xs">កំពុងផ្ទុក...</p>
        </div>
        
        <!-- Minimal Error Message (Hidden by default) -->
        <div id="errorMessage" class="absolute inset-0 flex items-center justify-center bg-red-900 hidden p-4">
            <p class="text-white text-xs text-center">Camera Error / Denied</p>
        </div>
        
        <!-- Recording Indicator -->
        <div id="recordingIndicator" class="hidden"></div>
        
        <!-- Feedback Message -->
        <div id="feedbackMessage"></div>

        <!-- Download Link (Hidden by default, used for video) -->
        <a id="downloadLink" class="absolute bottom-20 left-4 z-20 bg-blue-600 hover:bg-blue-700 text-white text-xs py-2 px-4 rounded-lg hidden" download>
            ទាញយកវីដេអូដែលបានថត
        </a>
    </div>
    
    <!-- Floating Settings Button (Gear Icon) -->
    <button id="settingsButton" class="p-3 rounded-full text-white">
        <!-- Lucide Settings Icon -->
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings">
            <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.44a2 2 0 0 1-2 2h-.44a2 2 0 0 0-2 2v.44a2 2 0 0 1-2 2h-.44a2 2 0 0 0-2 2v.44a2 2 0 0 1 2 2h.44a2 2 0 0 0 2 2v.44a2 2 0 0 1 2 2h.44a2 2 0 0 0 2 2v.44a2 2 0 0 1 2 2h.44a2 2 0 0 0 2 2v-.44a2 2 0 0 1 2-2h.44a2 2 0 0 0 2-2v-.44a2 2 0 0 1 2-2h.44a2 2 0 0 0 2-2v-.44a2 2 0 0 1-2-2h-.44a2 2 0 0 0-2-2v-.44a2 2 0 0 1-2-2h-.44a2 2 0 0 0-2-2v-.44a2 2 0 0 1-2-2h-.44z"/>
            <circle cx="12" cy="12" r="3"/>
        </svg>
    </button>
    
    <!-- Resolution Selector Dropdown -->
    <div id="resolutionSelector" class="p-2 rounded-lg text-white shadow-xl">
        <div class="text-xs text-gray-400 mb-1">ជ្រើសរើសទំហំ (Resolution)</div>
        <!-- Resolution options will be populated here by JavaScript -->
    </div>

    <script>
        // Check for media device support
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            document.getElementById('errorMessage').classList.remove('hidden');
        }

        const video = document.getElementById('video');
        const videoContainer = document.getElementById('videoContainer');
        const loadingMessage = document.getElementById('loadingMessage');
        const errorMessage = document.getElementById('errorMessage');
        const settingsButton = document.getElementById('settingsButton');
        const resolutionSelector = document.getElementById('resolutionSelector');
        const recordingIndicator = document.getElementById('recordingIndicator');
        const feedbackMessage = document.getElementById('feedbackMessage');
        const downloadLink = document.getElementById('downloadLink');

        let stream = null; // To hold the camera stream
        let mediaRecorder = null;
        let recordedChunks = [];
        let isRecording = false;
        let currentResolution = { w: 1280, h: 720 }; // Keep track of current resolution
        
        // Defined resolutions based on user request (Khmer names for clarity)
        const RESOLUTIONS = [
            // Landscape (16:9)
            { group: "16:9 (Landscape)", name: "4K (3840x2160)", w: 3840, h: 2160 },
            { group: "16:9 (Landscape)", name: "2K (2560x1440)", w: 2560, h: 1440 },
            { group: "16:9 (Landscape)", name: "1080p (1920x1080)", w: 1920, h: 1080 },
            { group: "16:9 (Landscape)", name: "720p (1280x720)", w: 1280, h: 720 },
            { group: "16:9 (Landscape)", name: "480p (854x480)", w: 854, h: 480 },
            
            // Portrait (9:16)
            { group: "9:16 (Portrait)", name: "4K (2160x3840)", w: 2160, h: 3840 },
            { group: "9:16 (Portrait)", name: "1080p (1080x1920)", w: 1080, h: 1920 },
            { group: "9:16 (Portrait)", name: "720p (720x1280)", w: 720, h: 1280 },
            { group: "9:16 (Portrait)", name: "480p (480x854)", w: 480, h: 854 },

            // Square (1:1)
            { group: "1:1 (Square)", name: "2160x2160 (4K)", w: 2160, h: 2160 },
            { group: "1:1 (Square)", name: "1080x1080 (HD)", w: 1080, h: 1080 },
            { group: "1:1 (Square)", name: "720x720", w: 720, h: 720 },
            { group: "1:1 (Square)", name: "480x480", w: 480, h: 480 },
        ];
        
        // Function to show temporary feedback message
        function showFeedback(message, duration = 3000) {
            feedbackMessage.textContent = message;
            feedbackMessage.style.opacity = '1';
            
            clearTimeout(feedbackMessage.timeoutId);
            feedbackMessage.timeoutId = setTimeout(() => {
                feedbackMessage.style.opacity = '0';
            }, duration);
        }

        // #1. Function to start Webcam with specific constraints
        async function startWebcam(width, height) {
            // Stop existing stream if running
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            
            currentResolution = { w: width, h: height };

            loadingMessage.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            downloadLink.classList.add('hidden'); // Hide video download link on restart

            // Define video and audio constraints (IMPORTANT: Request microphone audio)
            const constraints = { 
                audio: true, // Explicitly request microphone audio
                video: { 
                    facingMode: "user",
                    width: { ideal: width, max: width },
                    height: { ideal: height, max: height }
                }
            };

            try {
                // Request camera access (this now includes video and microphone)
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // Set video source
                video.srcObject = stream;
                
                // When video metadata is loaded
                video.onloadedmetadata = () => {
                    video.play();
                    loadingMessage.classList.add('hidden');
                    // showFeedback(`Webcam ដំណើរការ: ${width}x${height}`, 2000);
                };

            } catch (err) {
                console.error("Error accessing the camera with resolution:", width, "x", height, err);
                loadingMessage.classList.add('hidden');
                errorMessage.classList.remove('hidden');
                // Display minimal error text, informing the user about resolution failure
                errorMessage.querySelector('p').textContent = `Camera Error / Denied. Resolution ${width}x${height} might not be supported.`;
            }
        }

        // #2. Video Recording (F1)
        function startRecording() {
            if (!stream) {
                showFeedback("Webcam មិនទាន់ដំណើរការទេ។", 3000);
                return;
            }

            recordedChunks = [];
            try {
                // Use the current stream for recording (includes audio track now)
                mediaRecorder = new MediaRecorder(stream);
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
    
                    // Show download link for a recorded video minimally
                    downloadLink.href = url;
                    downloadLink.download = `webcam_video_${new Date().toISOString()}.webm`;
                    downloadLink.classList.remove('hidden');
                    
                    showFeedback("ថតវីដេអូរួចរាល់! ចុចដើម្បីទាញយក។", 10000); // 10 seconds visibility
                };
                
                mediaRecorder.start(100); // Record 100ms chunks
    
                isRecording = true;
                recordingIndicator.classList.remove('hidden');
                showFeedback("ចាប់ផ្តើមថតវីដេអូ និងសម្លេង (F1 ដើម្បីបញ្ឈប់)", 3000); // Updated message

            } catch (e) {
                console.error("MediaRecorder failed:", e);
                showFeedback("MediaRecorder Error: មិនអាចថតបានទេ។", 5000);
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                isRecording = false;
                recordingIndicator.classList.add('hidden');
                showFeedback("បញ្ឈប់ការថតវីដេអូ...", 3000);
            }
        }

        function toggleRecording() {
            if (!stream || video.paused) {
                showFeedback("Webcam មិនទាន់ដំណើរការទេ។", 3000);
                return;
            }
            if (isRecording) {
                stopRecording();
            } else {
                // Hide previous download link if starting a new recording
                downloadLink.classList.add('hidden');
                startRecording();
            }
        }

        // #3. Photo Capture (F2)
        function capturePhoto() {
            if (!stream || video.paused) {
                showFeedback("Webcam មិនទាន់ដំណើរការទេ។", 3000);
                return;
            }
            if (isRecording) {
                showFeedback("សូមបញ្ឈប់ការថតវីដេអូសិន (F1) មុនពេលថតរូប។", 3000);
                return;
            }
            
            // 1. Create a temporary Canvas element
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = video.videoWidth;
            tempCanvas.height = video.videoHeight;
            const ctx = tempCanvas.getContext('2d');
            
            // 2. Draw the frame (with mirror effect)
            ctx.translate(tempCanvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0, tempCanvas.width, tempCanvas.height);
            
            // 3. Create download link immediately and trigger click
            tempCanvas.toBlob((blob) => {
                const dataURL = URL.createObjectURL(blob);
                const photoDownloadLink = document.createElement('a');
                photoDownloadLink.href = dataURL;
                photoDownloadLink.download = `webcam_photo_${new Date().toISOString()}.png`;
                photoDownloadLink.click(); // Programmatically click to trigger download
                URL.revokeObjectURL(dataURL); // Clean up the URL object
            }, 'image/png');

            // 4. Visual Feedback (Flash)
            const flash = document.createElement('div');
            flash.className = 'absolute inset-0 bg-white opacity-0 transition-opacity duration-75';
            videoContainer.appendChild(flash);
            // Trigger flash effect
            setTimeout(() => {
                flash.style.opacity = '0.9';
                setTimeout(() => {
                    flash.style.opacity = '0';
                    setTimeout(() => {
                        videoContainer.removeChild(flash);
                    }, 100); // Remove element after transition
                }, 75); // Flash duration
            }, 10);
            
            showFeedback("រូបភាពត្រូវបានថត និងទាញយក (F2)", 3000);
        }

        // #4. Keyboard Event Listener
        document.addEventListener('keydown', (e) => {
            if (e.key === 'F1') {
                e.preventDefault(); // Prevent browser default F1 action (Help menu)
                toggleRecording();
            } else if (e.key === 'F2') {
                e.preventDefault(); // Prevent browser default F2 action
                capturePhoto();
            }
        });

        // #5. Resolution Selector Functions (Existing Logic)
        function applyResolution(width, height) {
            startWebcam(width, height);
            resolutionSelector.style.display = 'none'; // Hide menu after selection
        }
        
        function populateResolutionSelector() {
            let lastGroup = "";
            RESOLUTIONS.forEach(res => {
                // Add group header if it changes
                if (res.group !== lastGroup) {
                    const groupHeader = document.createElement('div');
                    groupHeader.className = 'text-xs font-bold mt-2 pt-1 border-t border-gray-700 first:mt-0 first:pt-0 first:border-t-0 px-2';
                    groupHeader.textContent = res.group;
                    resolutionSelector.appendChild(groupHeader);
                    lastGroup = res.group;
                }

                const item = document.createElement('div');
                item.className = 'res-item px-2 py-1 text-sm rounded-md';
                item.textContent = res.name;
                item.dataset.width = res.w;
                item.dataset.height = res.h;
                
                item.addEventListener('click', () => {
                    applyResolution(parseInt(item.dataset.width), parseInt(item.dataset.height));
                });
                resolutionSelector.appendChild(item);
            });
        }

        // #6. PWA Manifest Generator (for installation/Pop Up feature)
        function generateManifest() {
            const manifestContent = {
                name: "Webcam View",
                short_name: "Webcam",
                description: "Simple webcam viewer with resolution control and recording shortcuts.",
                start_url: "./webcam_pwa.html",
                display: "standalone", // Key for standalone/Pop Up window (allows window resizing)
                background_color: "#000000",
                theme_color: "#000000",
                // នេះបញ្ជាក់ថាវាជាកម្មវិធី PWA ឯករាជ្យ មិនមែនជាកម្មវិធីដែលជាប់ទាក់ទងនឹង Store ទេ។
                prefer_related_applications: false, 
                icons: [
                    {
                        src: "https://placehold.co/192x192/000000/ffffff?text=W",
                        sizes: "192x192",
                        type: "image/png"
                    },
                    {
                        src: "https://placehold.co/512x512/000000/ffffff?text=W",
                        sizes: "512x512",
                        type: "image/png"
                    }
                ]
            };

            const blob = new Blob([JSON.stringify(manifestContent)], { type: 'application/json' });
            const manifestURL = URL.createObjectURL(blob);
            
            const link = document.createElement('link');
            link.rel = 'manifest';
            link.href = manifestURL;
            document.head.appendChild(link);
        }
        
        // Toggle resolution selector visibility
        settingsButton.addEventListener('click', () => {
            resolutionSelector.style.display = resolutionSelector.style.display === 'block' ? 'none' : 'block';
        });

        // Start functionalities when the page is fully loaded
        window.onload = function() {
            generateManifest(); 
            populateResolutionSelector();
            // Start with a default resolution (1080p)
            startWebcam(1920, 1080);      
        };

    </script>
</body>
</html>
