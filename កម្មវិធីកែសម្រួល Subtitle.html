<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>កម្មវិធីកែសម្រួល Subtitle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Preahvihear&display=swap');
        body {
            font-family: 'Preahvihear', sans-serif;
            background-color: #f0f4f8;
        }
        .subtitle-display {
            position: absolute;
            left: 50%;
            bottom: 5%;
            transform: translateX(-50%);
            width: 100%;
            text-align: center;
            pointer-events: none;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
            white-space: pre-wrap;
            transition: all 0.3s ease;
            min-height: 80px;
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 15px;
            height: 15px;
            background: #2563eb;
            cursor: pointer;
            border-radius: 50%;
        }
        input[type="range"]::-moz-range-thumb {
            width: 15px;
            height: 15px;
            background: #2563eb;
            cursor: pointer;
            border-radius: 50%;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center p-4 min-h-screen">

    <!-- Main Container -->
    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-4xl mx-auto flex flex-col space-y-6">

        <!-- Title -->
        <h1 class="text-3xl font-bold text-center text-blue-800">កម្មវិធីកែសម្រួល Subtitle</h1>
        <p class="text-center text-gray-600">បញ្ចូលបទចម្រៀងរបស់អ្នក និងកែសម្រួល Subtitle យ៉ាងងាយស្រួល។</p>

        <!-- Audio Player & Subtitle Display -->
        <div class="relative w-full rounded-lg overflow-hidden bg-gray-900">
            <audio id="audio-player" class="w-full" controls></audio>
            <!-- ប្រើ class subtitle-display ថ្មី -->
            <div id="subtitle-display" class="subtitle-display"></div>
        </div>

        <!-- File Inputs and Actions -->
        <div class="flex flex-col md:flex-row md:space-x-4 space-y-4 md:space-y-0">
            <div class="flex-1">
                <label for="audio-upload" class="block text-sm font-medium text-gray-700 mb-1">បញ្ចូលឯកសារសំឡេង (.mp3, .wav)</label>
                <input type="file" id="audio-upload" accept="audio/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
            </div>
            <div class="flex-1">
                <label for="subtitle-upload" class="block text-sm font-medium text-gray-700 mb-1">បញ្ចូលឯកសារ Subtitle (.json)</label>
                <input type="file" id="subtitle-upload" accept=".json" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
            </div>
            <button id="save-button" class="md:self-end px-6 py-3 bg-green-500 text-white font-semibold rounded-full shadow-lg hover:bg-green-600 transition-colors">
                រក្សាទុកឯកសារ Subtitle
            </button>
        </div>

        <!-- Subtitle Editor -->
        <div class="bg-gray-50 rounded-lg p-4 space-y-4">
            <h2 class="text-xl font-bold text-blue-700">កែសម្រួល Subtitle</h2>

            <!-- Style Controls -->
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                <div>
                    <label for="font-select" class="block text-sm font-medium text-gray-700">Font</label>
                    <select id="font-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="Preahvihear">Preahvihear</option>
                        <option value="Arial">Arial</option>
                        <option value="Times New Roman">Times New Roman</option>
                        <option value="Courier New">Courier New</option>
                    </select>
                </div>
                <div>
                    <label for="font-size" class="block text-sm font-medium text-gray-700">ទំហំអក្សរ</label>
                    <input type="range" id="font-size" min="16" max="100" value="48" class="mt-1 w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>
                <div>
                    <label for="font-color" class="block text-sm font-medium text-gray-700">ពណ៌អក្សរ</label>
                    <input type="color" id="font-color" value="#ffffff" class="mt-1 w-full h-8 rounded-md border-gray-300 shadow-sm">
                </div>
                <div>
                    <label for="vertical-pos" class="block text-sm font-medium text-gray-700">ទីតាំងបញ្ឈរ</label>
                    <input type="range" id="vertical-pos" min="0" max="50" value="5" class="mt-1 w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>
            </div>

            <!-- Subtitle List -->
            <div id="subtitle-list" class="space-y-4 max-h-80 overflow-y-auto pr-2">
                <div class="p-4 bg-gray-100 rounded-lg shadow-inner">
                    <p class="text-sm text-gray-500">បន្ថែម Subtitle ដំបូងរបស់អ្នកដោយចុចប៊ូតុង "បន្ថែម Subtitle"</p>
                </div>
            </div>

            <!-- Add Subtitle Button -->
            <div class="flex justify-center">
                <button id="add-subtitle-button" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-full shadow-lg hover:bg-blue-700 transition-colors">
                    បន្ថែម Subtitle
                </button>
            </div>

            <!-- Message Box -->
            <div id="message-box" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
                <div class="bg-white rounded-lg p-6 max-w-sm w-full text-center shadow-2xl">
                    <p id="message-text" class="text-lg font-semibold text-gray-800 mb-4">សារ</p>
                    <button id="message-ok" class="px-6 py-2 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition-colors">យល់ព្រម</button>
                </div>
            </div>
            
        </div>
    </div>

<script>
    const audioPlayer = document.getElementById('audio-player');
    const subtitleDisplay = document.getElementById('subtitle-display');
    const audioUpload = document.getElementById('audio-upload');
    const subtitleUpload = document.getElementById('subtitle-upload');
    const saveButton = document.getElementById('save-button');
    const fontSelect = document.getElementById('font-select');
    const fontSizeInput = document.getElementById('font-size');
    const fontColorInput = document.getElementById('font-color');
    const verticalPosInput = document.getElementById('vertical-pos');
    const subtitleList = document.getElementById('subtitle-list');
    const addSubtitleButton = document.getElementById('add-subtitle-button');
    
    // Message Box Elements
    const messageBox = document.getElementById('message-box');
    const messageText = document.getElementById('message-text');
    const messageOkButton = document.getElementById('message-ok');

    let subtitles = [];
    let currentSubtitleIndex = -1;

    // --- Utility Functions ---

    function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
    
    function parseTime(timeStr) {
        const parts = timeStr.split(':');
        if (parts.length === 2) {
            const minutes = parseInt(parts[0], 10);
            const seconds = parseInt(parts[1], 10);
            if (!isNaN(minutes) && !isNaN(seconds)) {
                return minutes * 60 + seconds;
            }
        }
        return 0; // Return 0 or handle error appropriately
    }

    function showMessage(text) {
        messageText.textContent = text;
        messageBox.classList.remove('hidden');
        messageBox.classList.add('flex');
    }

    messageOkButton.addEventListener('click', () => {
        messageBox.classList.remove('flex');
        messageBox.classList.add('hidden');
    });

    // --- Event Listeners ---

    audioUpload.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const url = URL.createObjectURL(file);
            audioPlayer.src = url;
            showMessage("ឯកសារសំឡេងត្រូវបានបញ្ចូលដោយជោគជ័យ។");
        }
    });

    subtitleUpload.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    subtitles = JSON.parse(e.target.result);
                    renderSubtitles();
                    showMessage("ឯកសារ Subtitle ត្រូវបានបញ្ចូលដោយជោគជ័យ។");
                } catch (err) {
                    showMessage("ឯកសារ Subtitle មានកំហុស។ សូមប្រាកដថាវាជាឯកសារ .json");
                }
            };
            reader.readAsText(file);
        }
    });

    saveButton.addEventListener('click', () => {
        if (subtitles.length === 0) {
            showMessage("គ្មាន Subtitle ណាត្រូវបានបង្កើតនៅឡើយទេ។");
            return;
        }
        const dataStr = JSON.stringify(subtitles, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'subtitles.json';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showMessage("ឯកសារ Subtitle ត្រូវបានរក្សាទុក។");
    });

    addSubtitleButton.addEventListener('click', () => {
        const newSubtitle = {
            start: audioPlayer.currentTime,
            end: audioPlayer.currentTime + 3, // Default duration
            text: 'បញ្ចូលអត្ថបទ Subtitle',
            styles: {
                fontFamily: fontSelect.value,
                fontSize: `${fontSizeInput.value}px`,
                color: fontColorInput.value,
                bottom: `${verticalPosInput.value}%`
            }
        };
        subtitles.push(newSubtitle);
        subtitles.sort((a, b) => a.start - b.start);
        renderSubtitles();
        subtitleList.scrollTop = subtitleList.scrollHeight; // Scroll to the new entry
    });

    // --- Subtitle Rendering & Logic ---

    function renderSubtitles() {
        subtitleList.innerHTML = '';
        if (subtitles.length === 0) {
            subtitleList.innerHTML = `
                <div class="p-4 bg-gray-100 rounded-lg shadow-inner">
                    <p class="text-sm text-gray-500">បន្ថែម Subtitle ដំបូងរបស់អ្នកដោយចុចប៊ូតុង "បន្ថែម Subtitle"</p>
                </div>
            `;
            return;
        }

        subtitles.forEach((sub, index) => {
            const row = document.createElement('div');
            row.className = 'p-4 bg-white rounded-lg shadow-md border border-gray-200 space-y-2';
            row.innerHTML = `
                <div class="flex items-center justify-between">
                    <span class="text-sm font-semibold text-gray-500">#${index + 1}</span>
                    <button class="delete-btn text-red-500 hover:text-red-700 text-sm font-bold">លុប</button>
                </div>
                <div class="flex items-center space-x-2">
                    <label class="text-sm text-gray-700">ចាប់ផ្តើម:</label>
                    <input type="text" value="${formatTime(sub.start)}" class="start-time-input w-20 rounded-md border-gray-300 shadow-sm text-xs font-mono p-1">
                    <button class="set-start-btn px-2 py-1 bg-blue-500 text-white text-xs rounded-full hover:bg-blue-600 transition-colors">កំណត់</button>
                </div>
                <div class="flex items-center space-x-2">
                    <label class="text-sm text-gray-700">បញ្ចប់:</label>
                    <input type="text" value="${formatTime(sub.end)}" class="end-time-input w-20 rounded-md border-gray-300 shadow-sm text-xs font-mono p-1">
                    <button class="set-end-btn px-2 py-1 bg-blue-500 text-white text-xs rounded-full hover:bg-blue-600 transition-colors">កំណត់</button>
                </div>
                <div>
                    <label class="text-sm text-gray-700">អត្ថបទ:</label>
                    <textarea class="subtitle-text-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" rows="2">${sub.text}</textarea>
                </div>
            `;
            subtitleList.appendChild(row);

            // Add event listeners for new elements
            row.querySelector('.delete-btn').addEventListener('click', () => {
                subtitles.splice(index, 1);
                renderSubtitles();
            });
            row.querySelector('.set-start-btn').addEventListener('click', () => {
                subtitles[index].start = audioPlayer.currentTime;
                subtitles.sort((a, b) => a.start - b.start);
                renderSubtitles();
            });
            row.querySelector('.set-end-btn').addEventListener('click', () => {
                subtitles[index].end = audioPlayer.currentTime;
                subtitles.sort((a, b) => a.start - b.start);
                renderSubtitles();
            });
            row.querySelector('.start-time-input').addEventListener('input', (event) => {
                subtitles[index].start = parseTime(event.target.value);
            });
            row.querySelector('.end-time-input').addEventListener('input', (event) => {
                subtitles[index].end = parseTime(event.target.value);
            });
            row.querySelector('.subtitle-text-input').addEventListener('input', (event) => {
                subtitles[index].text = event.target.value;
            });
        });
    }

    // Update styles based on user input
    fontSelect.addEventListener('change', (e) => {
        subtitleDisplay.style.fontFamily = e.target.value;
        subtitles.forEach(sub => sub.styles.fontFamily = e.target.value);
    });
    fontSizeInput.addEventListener('input', (e) => {
        subtitleDisplay.style.fontSize = `${e.target.value}px`;
        subtitles.forEach(sub => sub.styles.fontSize = `${e.target.value}px`);
    });
    fontColorInput.addEventListener('input', (e) => {
        subtitleDisplay.style.color = e.target.value;
        subtitles.forEach(sub => sub.styles.color = e.target.value);
    });
    verticalPosInput.addEventListener('input', (e) => {
        subtitleDisplay.style.bottom = `${e.target.value}%`;
        subtitles.forEach(sub => sub.styles.bottom = `${e.target.value}%`);
    });

    audioPlayer.addEventListener('timeupdate', () => {
        const currentTime = audioPlayer.currentTime;
        const previousIndex = currentSubtitleIndex;

        let found = false;
        for (let i = 0; i < subtitles.length; i++) {
            const sub = subtitles[i];
            if (currentTime >= sub.start && currentTime < sub.end) {
                if (currentSubtitleIndex !== i) {
                    currentSubtitleIndex = i;
                    subtitleDisplay.textContent = sub.text;
                    subtitleDisplay.style.opacity = '1';
                    
                    // Apply saved styles
                    subtitleDisplay.style.fontFamily = sub.styles.fontFamily;
                    subtitleDisplay.style.fontSize = sub.styles.fontSize;
                    subtitleDisplay.style.color = sub.styles.color;
                    subtitleDisplay.style.bottom = sub.styles.bottom;
                }
                found = true;
                break;
            }
        }

        if (!found) {
            currentSubtitleIndex = -1;
            subtitleDisplay.textContent = '';
            subtitleDisplay.style.opacity = '0';
        }
    });

    renderSubtitles(); // Initial render
</script>

</body>
</html>
