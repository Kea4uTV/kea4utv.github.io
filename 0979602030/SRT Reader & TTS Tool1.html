<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRT Reader & TTS Tool - Professional Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/font-awesome.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@300;400;700&display=swap');
        body {
            font-family: 'Kantumruy Pro', sans-serif;
            background-color: #f1f5f9;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #6366f1; border-radius: 10px; }
        .btn-active { transform: scale(0.95); }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden border border-gray-100">
        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-700 p-6 text-white shadow-lg">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold mb-1 flex items-center">
                        <i class="fas fa-microphone-lines mr-3"></i> SRT to Khmer Voice Pro
                    </h1>
                    <p class="opacity-80 text-xs">បច្ចេកវិទ្យាបញ្ជូលសំឡេងតាមជួរ និងទាញយកឯកសារបានភ្លាមៗ</p>
                </div>
                <div class="hidden md:block">
                    <i class="fas fa-compact-disc animate-spin-slow text-4xl opacity-20"></i>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-0">
            <!-- Left Sidebar: Controls -->
            <div class="p-6 bg-gray-50 border-r border-gray-200">
                <!-- File Upload -->
                <div class="mb-6">
                    <label class="block text-gray-700 font-bold mb-2 text-sm">១. បញ្ចូលឯកសារ SRT</label>
                    <input type="file" id="srtFile" accept=".srt" class="hidden" onchange="handleFileUpload(event)">
                    <button onclick="document.getElementById('srtFile').click()" class="w-full py-4 px-4 bg-white border-2 border-dashed border-indigo-300 text-indigo-600 rounded-2xl hover:bg-indigo-50 hover:border-indigo-500 transition-all flex flex-col items-center justify-center">
                        <i class="fas fa-cloud-upload-alt text-2xl mb-1"></i>
                        <span class="font-bold text-sm">ជ្រើសរើសឯកសារ .srt</span>
                    </button>
                    <p id="fileNameDisplay" class="text-[10px] text-gray-400 mt-1 text-center truncate"></p>
                </div>

                <!-- Voice Selection -->
                <div class="mb-6">
                    <label class="block text-gray-700 font-bold mb-2 text-sm">២. ជ្រើសរើសតួអង្គ (Voice)</label>
                    <select id="voiceSelect" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none shadow-sm bg-white text-sm">
                        <option value="Kore">Kore (សំឡេងស្តង់ដារ - ប្រុស)</option>
                        <option value="Zephyr">Zephyr (សំឡេងស្រទន់ - ស្រី)</option>
                        <option value="Puck">Puck (សំឡេងរហ័សរហួន)</option>
                        <option value="Charon">Charon (សំឡេងជ្រៅ)</option>
                        <option value="Fenrir">Fenrir (សំឡេងបុរសមាំ)</option>
                        <option value="Leda">Leda (សំឡេងស្រីផ្អែម)</option>
                    </select>
                </div>

                <!-- Merge Logic -->
                <div class="mb-6">
                    <label class="block text-gray-700 font-bold mb-2 text-sm">៣. ការបញ្ចូលជួរ (Merge Groups)</label>
                    <div class="flex items-center gap-3">
                        <input type="number" id="mergeCount" value="1" min="1" max="20" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none shadow-sm text-center font-bold">
                        <span class="text-xs text-gray-500 font-medium">ជួរ/ផ្នែក</span>
                    </div>
                </div>

                <div class="mb-6">
                    <button onclick="processSRT()" class="w-full py-4 bg-gradient-to-r from-indigo-600 to-blue-600 text-white rounded-2xl font-bold shadow-xl hover:shadow-indigo-200 transition-all active:scale-95 flex items-center justify-center">
                        <i class="fas fa-magic mr-2"></i> វិភាគ និងរៀបចំ
                    </button>
                </div>
                
                <div class="p-4 bg-amber-50 rounded-2xl border border-amber-100">
                    <h3 class="text-amber-800 font-bold text-xs mb-1"><i class="fas fa-lightbulb mr-1"></i> គន្លឹះ៖</h3>
                    <p class="text-[10px] text-amber-700 leading-relaxed">
                        បន្ទាប់ពីចុះឈ្មោះរួច ចុចប៊ូតុង <i class="fas fa-play"></i> ដើម្បីស្ដាប់ ឬប៊ូតុង <i class="fas fa-download"></i> ដើម្បីទាញយកសំឡេងទុក។
                    </p>
                </div>
            </div>

            <!-- Right: Content Display -->
            <div class="lg:col-span-2 p-6 bg-white">
                <div id="welcomeScreen" class="h-full flex flex-col items-center justify-center text-gray-300 py-20">
                    <div class="w-24 h-24 bg-gray-50 rounded-full flex items-center justify-center mb-4">
                        <i class="fas fa-file-audio text-4xl opacity-20"></i>
                    </div>
                    <p class="font-medium">មិនទាន់មានទិន្នន័យនៅឡើយទេ</p>
                </div>

                <div id="outputArea" class="hidden">
                    <div class="flex justify-between items-center mb-6 border-b pb-4">
                        <h2 class="text-lg font-bold text-gray-800 flex items-center">
                            <i class="fas fa-list-ul mr-2 text-indigo-500"></i> បញ្ជីផ្នែកសំឡេង
                        </h2>
                        <span id="statInfo" class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-lg text-[10px] font-black uppercase"></span>
                    </div>
                    <div id="srtList" class="space-y-4 max-h-[600px] overflow-y-auto pr-2 custom-scrollbar"></div>
                </div>
            </div>
        </div>
    </div>

    <audio id="audioPlayer" class="hidden"></audio>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-md hidden flex items-center justify-center z-50">
        <div class="bg-white p-10 rounded-[2rem] shadow-2xl flex flex-col items-center max-w-sm text-center border border-white/20">
            <div class="relative w-24 h-24 mb-6">
                <div class="absolute inset-0 border-4 border-indigo-50 rounded-full"></div>
                <div class="absolute inset-0 border-4 border-indigo-600 rounded-full border-t-transparent animate-spin"></div>
                <i class="fas fa-microphone-alt text-indigo-600 absolute inset-0 flex items-center justify-center text-3xl"></i>
            </div>
            <h3 class="font-bold text-gray-800 text-xl mb-2">កំពុងបង្កើតសំឡេង...</h3>
            <p id="loadingMsg" class="text-sm text-gray-500 mb-2"></p>
            <div id="segmentStatus" class="text-[10px] text-indigo-600 bg-indigo-50 px-4 py-1.5 rounded-full font-bold uppercase tracking-widest">Processing</div>
        </div>
    </div>

    <script>
        const apiKey = ""; 
        let rawSrtData = "";

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            document.getElementById('fileNameDisplay').innerText = file.name;
            const reader = new FileReader();
            reader.onload = (e) => {
                rawSrtData = e.target.result;
                processSRT();
            };
            reader.readAsText(file);
        }

        function parseSrtTimeToSeconds(timeStr) {
            const parts = timeStr.split(':');
            const secondsParts = parts[2].split(',');
            return (parseInt(parts[0]) * 3600) + (parseInt(parts[1]) * 60) + parseInt(secondsParts[0]) + (parseInt(secondsParts[1]) / 1000);
        }

        function processSRT() {
            if (!rawSrtData) return;
            const mergeCount = parseInt(document.getElementById('mergeCount').value) || 1;
            const srtRegex = /(\d+)\s+(\d{2}:\d{2}:\d{2},\d{3})\s*-->\s*(\d{2}:\d{2}:\d{2},\d{3})\s+([\s\S]*?)(?=\n\n|\n\d+\s+|$)/g;
            
            let items = [];
            let match;
            while ((match = srtRegex.exec(rawSrtData)) !== null) {
                const start = parseSrtTimeToSeconds(match[2]);
                const end = parseSrtTimeToSeconds(match[3]);
                items.push({
                    index: match[1],
                    startStr: match[2],
                    endStr: match[3],
                    startTime: start,
                    endTime: end,
                    duration: (end - start).toFixed(2),
                    text: match[4].replace(/\n/g, ' ').trim()
                });
            }

            let mergedGroups = [];
            for (let i = 0; i < items.length; i += mergeCount) {
                let chunk = items.slice(i, i + mergeCount);
                let totalDur = (chunk[chunk.length - 1].endTime - chunk[0].startTime).toFixed(2);
                
                mergedGroups.push({
                    id: Math.floor(i / mergeCount) + 1,
                    segments: chunk,
                    totalDuration: totalDur
                });
            }
            renderList(mergedGroups);
        }

        function renderList(groups) {
            const list = document.getElementById('srtList');
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('outputArea').classList.remove('hidden');
            document.getElementById('statInfo').innerText = `${groups.length} ផ្នែកត្រូវបានរកឃើញ`;
            list.innerHTML = '';

            groups.forEach(group => {
                const card = document.createElement('div');
                card.className = 'bg-white border border-gray-100 rounded-2xl overflow-hidden shadow-sm hover:border-indigo-200 transition-all group p-4';
                
                let segmentsHtml = group.segments.map(s => `
                    <div class="flex items-start gap-3 py-2 border-b border-gray-50 last:border-0">
                        <div class="flex flex-col items-center shrink-0">
                            <span class="text-[9px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded font-mono font-bold">${s.duration}s</span>
                        </div>
                        <p class="text-sm text-slate-700 leading-snug">${s.text}</p>
                    </div>
                `).join('');

                card.innerHTML = `
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-3">
                                <span class="w-7 h-7 flex items-center justify-center bg-indigo-600 text-white rounded-lg text-xs font-bold">${group.id}</span>
                                <div>
                                    <div class="text-[10px] text-gray-400 font-bold font-mono tracking-tighter">${group.segments[0].startStr}</div>
                                    <div class="text-indigo-600 text-[10px] font-black italic">DURATION: ${group.totalDuration}s</div>
                                </div>
                            </div>
                            <div class="bg-gray-50/50 p-3 rounded-xl border border-gray-50">
                                ${segmentsHtml}
                            </div>
                        </div>
                        <div class="flex md:flex-col gap-2 shrink-0">
                            <button onclick='generateSpeech(this, ${JSON.stringify(group.segments).replace(/'/g, "&apos;")}, ${group.totalDuration}, "play")' class="w-12 h-12 bg-indigo-600 text-white rounded-2xl flex items-center justify-center shadow-lg hover:bg-indigo-700 transition-all hover:scale-105 active:scale-95 group/btn">
                                <i class="fas fa-play"></i>
                            </button>
                            <button onclick='generateSpeech(this, ${JSON.stringify(group.segments).replace(/'/g, "&apos;")}, ${group.totalDuration}, "download")' class="w-12 h-12 bg-emerald-500 text-white rounded-2xl flex items-center justify-center shadow-lg hover:bg-emerald-600 transition-all hover:scale-105 active:scale-95 group/btn">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>`;
                list.appendChild(card);
            });
        }

        async function generateSpeech(btn, segments, totalDuration, mode) {
            const overlay = document.getElementById('loadingOverlay');
            const icon = btn.querySelector('i');
            const loadingMsg = document.getElementById('loadingMsg');
            const voice = document.getElementById('voiceSelect').value;
            
            overlay.classList.remove('hidden');
            const originalIconClass = icon.className;
            icon.className = 'fas fa-spinner animate-spin';
            loadingMsg.innerText = mode === "download" ? "កំពុងរៀបចំទាញយក..." : "កំពុងអានតាមជួរនីមួយៗ...";
            
            let segmentScript = segments.map((s, idx) => `Segment ${idx+1} ("${s.text}"): Speed up/slow down to fit exactly ${s.duration} seconds.`).join('\n');
            
            let systemPrompt = `You are a professional Khmer narrator.
            Script format:
            ${segmentScript}
            
            INSTRUCTIONS:
            1. Read each segment with the EXACT specified duration.
            2. For segments like 0.44s, you must speak very quickly and clearly.
            3. For segments like 1.64s, speak with a natural, professional pace.
            4. Do not skip any words.
            5. Ensure the total audio length matches ${totalDuration} seconds.`;

            try {
                const response = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: systemPrompt }] }],
                        model: "gemini-2.5-flash-preview-tts",
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: {
                                voiceConfig: {
                                    prebuiltVoiceConfig: { voiceName: voice }
                                }
                            }
                        }
                    })
                });

                const result = await response.json();
                if (result.error) throw new Error(result.error.message);

                const audioPart = result.candidates?.[0]?.content?.parts?.find(p => p.inlineData);
                if (audioPart?.inlineData?.data) {
                    const base64Data = audioPart.inlineData.data;
                    const mimeType = audioPart.inlineData.mimeType;
                    
                    if (mode === "play") {
                        playAudio(base64Data, mimeType);
                    } else {
                        downloadAudio(base64Data, mimeType, `voice_part_${Date.now()}.wav`);
                    }
                }
            } catch (err) {
                console.error(err);
                alert("កំហុស៖ " + err.message);
            } finally {
                overlay.classList.add('hidden');
                icon.className = originalIconClass;
            }
        }

        async function fetchWithRetry(url, options, retries = 5) {
            for (let i = 0; i < retries; i++) {
                try {
                    const res = await fetch(url, options);
                    if (res.ok) return res;
                    await new Promise(r => setTimeout(r, 1000 * Math.pow(2, i)));
                } catch (e) {}
            }
            throw new Error("ការភ្ជាប់ទៅម៉ាស៊ីនមេមានបញ្ហា សូមព្យាយាមម្ដងទៀត។");
        }

        function getWavBlob(base64Data, mimeType) {
            const sampleRateMatch = mimeType.match(/rate=(\d+)/);
            const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1]) : 24000;
            const binary = atob(base64Data);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
            const wav = createWav(bytes.buffer, sampleRate);
            return new Blob([wav], { type: 'audio/wav' });
        }

        function playAudio(base64Data, mimeType) {
            const blob = getWavBlob(base64Data, mimeType);
            const url = URL.createObjectURL(blob);
            const player = document.getElementById('audioPlayer');
            player.src = url;
            player.play();
        }

        function downloadAudio(base64Data, mimeType, filename) {
            const blob = getWavBlob(base64Data, mimeType);
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function createWav(pcm, rate) {
            const buf = new ArrayBuffer(44 + pcm.byteLength);
            const v = new DataView(buf);
            const s = (o, str) => { for (let i = 0; i < str.length; i++) v.setUint8(o + i, str.charCodeAt(i)); };
            s(0, 'RIFF'); v.setUint32(4, 32 + pcm.byteLength, true); s(8, 'WAVE'); s(12, 'fmt ');
            v.setUint32(16, 16, true); v.setUint16(20, 1, true); v.setUint16(22, 1, true);
            v.setUint32(24, rate, true); v.setUint32(28, rate * 2, true); v.setUint16(32, 2, true);
            v.setUint16(34, 16, true); s(36, 'data'); v.setUint32(40, pcm.byteLength, true);
            new Uint8Array(buf, 44).set(new Uint8Array(pcm));
            return buf;
        }
    </script>
</body>
</html>
